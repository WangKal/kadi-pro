<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!--<link rel="manifest" href="/manifest.json">-->
    <meta name="msapplication-TileColor" content="#ffffff">
    <meta name="msapplication-TileImage" content="/ms-icon-144x144.png">
    <meta name="theme-color" content="#ffffff">
        <!--[if lt IE 9]>
            <script src="//html5shim.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]-->
    <title>Kadi-Pro - Kenyan Poker</title>

<link rel="apple-touch-icon" sizes="57x57" href="./uploads/apple-icon-57x57.png">
<link rel="apple-touch-icon" sizes="60x60" href="./uploads/apple-icon-60x60.png">
<link rel="apple-touch-icon" sizes="72x72" href="./uploads/apple-icon-72x72.png">
<link rel="apple-touch-icon" sizes="76x76" href="./uploads/apple-icon-76x76.png">
<link rel="apple-touch-icon" sizes="114x114" href="./uploads/apple-icon-114x114.png">
<link rel="apple-touch-icon" sizes="120x120" href="./uploads/apple-icon-120x120.png">
<link rel="apple-touch-icon" sizes="144x144" href="./uploads/apple-icon-144x144.png">
<link rel="apple-touch-icon" sizes="152x152" href="./uploads/apple-icon-152x152.png">
<link rel="apple-touch-icon" sizes="180x180" href="./uploads/apple-icon-180x180.png">
<link rel="icon" type="image/png" sizes="192x192"  href="/android-icon-192x192.png">
<link rel="icon" type="image/png" sizes="32x32" href="./uploads/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="96x96" href="./uploads/favicon-96x96.png">
<link rel="icon" type="image/png" sizes="16x16" href="./uploads/favicon-16x16.png">

    
       
  


        <!-- Fonts (Raleway from Google Fonts) -->
<link href="https://fonts.googleapis.com/css2?family=Raleway&display=swap" rel="stylesheet">

<!-- Font Awesome -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">

<!-- Bootstrap CSS -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@3.4.1/dist/css/bootstrap.min.css" rel="stylesheet">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">


<!-- Animate.css -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" rel="stylesheet">




<!-- jQuery -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@3.4.1/dist/js/bootstrap.min.js"></script>


              <link href="./styles2.css" rel="stylesheet">
    
        
</head>
<body data-theme="light">

<div class="container full-height-container">

  <div id="custom-alert" class="custom-alert">
    This is a custom alert. It will disappear after 1 minute.
  </div>

  <div class="tutorial-buttons">
    <button class="btn btn-primary btn-lg" id="tutorial_prev">Prev</button>
    <button class="btn btn-primary btn-lg" id="tutorial_next">Next</button>
    <button class="btn btn-primary btn-lg" id="tutorial_skip">Skip</button>
  </div>

  <div id="notifywin" class="notifywin-wrapper">
    <div class="notifywin-inner">

      <div class="notifywin-left">
        <h1 class="logo-text"> Kadi Pro</h1>
        <div class="notifywin-icons">

        <button class="btn btn-info hicons" onclick="restartGame()"><i class="bi bi-arrow-clockwise"></i></button>
         <button class="btn btn-info" onclick="viewLeaderboard()"><i class="bi bi-trophy"></i></button>
          <!--<button class="btn btn-info" onclick="profileView()"><i class="bi bi-person-circle"></i></button>-->
          <button class="btn btn-info" onclick="toggleTheme()"><i class="bi bi-moon" id="themeToggle"></i></button>
           <button class="btn btn-info" onclick="logout()" ><i class="bi bi-box-arrow-right"></i> 
        </button>

        </div>
        <div class="notifywin-updates">
          <p id="winner_text" class="notifywin-text">Game updates will appear here...</p>
        </div>
      </div>
      <div class="notifywin-right">
        <div class="player-portrait">
          <div class="player-portrait-image">
            <img src="./img/friend.jpg" id="player-pic" alt="Player" style="width: 100%; height: auto; object-fit: cover;">
          </div>
          <h4 class="player-name">Player Name</h4>
        </div>
      </div>
    </div>
  </div>

  <div class="row">
    <div class="col-md-6">
      <div id="playing-area" style="margin:0 auto;">
        <div id="circle1">
          <div class="playing-card " ></div>
        </div>
      </div>
    </div>

    <div class="col-md-6 z-999">
      <div>
        <div class="col-xs-3 z-999">
          <div id="circle2" class="z-999">
            <button class="btn btn-info" id="pick_c">PICK</button>
          </div>
        </div>
        <div class="col-xs-3">
          <div id="circle3">
            <button class="btn btn-info" id="undo">UNDO</button>
          </div>
        </div>
        <div class="col-xs-3">
          <div id="circle4">
            <button class="btn btn-info" id="kadi">KADI</button>
          </div>
        </div>
        <div class="col-xs-3">
          <div id="circle5">
            <button class="btn btn-info" id="play_end">PLAY</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="card-stack">
    <div class="holdin-p card-holder" id="h0"></div>
  </div>

  <div class="card_warning"></div>

  <div id="prev-play" class="prev-play">
    <div class="card-placeholder" id="card_placeholder"></div>
  </div>

  <div class="PlayerCardsRemaining">
    <p id="PCRD"></p>
  </div>
</div>
<div id="chat-handle">💬</div>
  

<div id="chat-drawer">
  <!-- Chat Header -->
  <div id="chat-header">
    <h3 id="chatdrawer-heading">Kadi Chat</h3>
    <div>
      <button  id="open_subdrawer" onclick="toggleSubdrawer()">☰</button>
      <button  id="close_drawer" onclick="toggleChatDrawer()">✖</button>
    </div>
  </div>

  <!-- Subdrawer -->
  <!-- Subdrawer inside chat drawer -->
<div id="chat-subdrawer">
  <div id="subdrawer-tabs">
    <div style="display: flex; flex: 1;">
      <button onclick="showChats()" style="flex: 1;">Chats</button>
      <button onclick="showOnline()" style="flex: 1;">Players</button>
    </div>
    <button onclick="toggleSubdrawer()" style="flex: 0 0 auto;">✖</button>
  </div>
  <div id="chat-list"></div>
  <div id="online-list" style="display:none;"></div>
</div>


  <!-- Messages Area -->
  <div id="chat-messages"></div>

  <!-- Input Section -->
  <div id="chat-input">
    <div id="input-row">
      <textarea id="msgInput" placeholder="Type message..."></textarea>
  <div class="button-row">
      <button onclick="toggleEmojiPicker()">😊</button>
      <button onclick="toggleGifPicker()">GIF</button>
      <button onclick="sendMessage()">Send</button>
  </div>
    </div>
    <emoji-picker id="emojiPicker"></emoji-picker>
    <div id="gifPicker">
      <input type="text" id="gifSearch" placeholder="Search GIFs..." />
      <div id="gifResults" ></div>
    </div>
  </div>
</div>





<div class="tutorial-overlay" id="overlay"></div>
<div class="tutorial-text" id="tutorial-text"></div>

    <audio id="cardClickSound" src="sounds/snap2.wav" preload="auto"></audio>
    <audio id="areaClickSound" src="sounds/snap3.wav" preload="auto"></audio>
    <audio id="pickCardSound" src="sounds/snap3.wav" preload="auto"></audio>
    <audio id="submitCardSound" src="sounds/submit.wav" preload="auto"></audio>
<!--<div id="bannerAdContainer" style="
    position: fixed;
    bottom: 0;
    left: 0;
    width: 100%;
    height: 50px; /* Adjust banner height */
    background-color: black; /* Just in case ad doesn't load */
    text-align: center;
    z-index: 1000;">
</div>-->

    
<div id="card_request_modal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
        <div class="modal-dialog modal_table">
            <div class="modal-content modal_cell">
                <div class="modal-content">
                    <div class="container">
                        <div class="row">
                            <div class="col-sm-6 col-sm-offset-3">
                                <div class="modal-header">
                                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true"><i class="fa fa-times"></i></button>
                                    <h3 id="myModalLabel"><i class="fa fa-user"></i> &nbsp; Select the card you want.</h3>
                                </div>
                                <div class="modal-body">
                                    <div class="row">
                                        <div class="col-md-3">
                                    <button class="select-card" id="hearts" style="text-align: left;color:white;height:150px;width:100px;"></button>
        

                                        </div>
                                        <div class="col-md-3">
        <button class="select-card" id="diamonds" style="text-align: left;color:white;height:150px;width:100px;"></button>                                    

                                        </div>
                                        <div class="col-md-3">
                                            
<button class="select-card" id="flowers" style="text-align: left;color:white;height:150px;width:100px;"></button>
                                        </div>
                                        <div class="col-md-3">
                                            <button class="select-card" id="spades" style="text-align: left;color:white;height:150px;width:100px;"></button>

                                        </div>

                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <div class="form-group">
                                        <div class="col-sm-4 text-left">
                                            <button type="button" data-dismiss="modal" class="btn btn-default"><i class="fa fa-times"></i> Close</button>
                                        </div>
                                        <div class="col-sm-8">
                                            
                                            
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
<!-- Game Selection Modal -->
<div id="game_selection" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="gameModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            
            <!-- Header -->
            <div class="modal-header text-center">
                <h3 id="gameModalLabel" class="w-100"> Select Play Mode</h3>
                
            </div>

            <!-- Main Content -->
            <div class="modal-body">
                <!-- First Screen: Singleplayer or Multiplayer (Side-by-Side on Large Screens) -->
                <div id="main-menu" class="selection-container">
                    <div class="selection-card" id="multi_player">
                        <img src="./img/multi.jpg" alt="Multiplayer">
                        <div class="card-info">
                            <h5>🌍 Multiplayer</h5>
                            <p>Play with a friend or a random opponent.</p>
                        </div>
                    </div>

                    <div class="selection-card" id="single_player">
                        <img src="./img/single.jpg" alt="Singleplayer">
                        <div class="card-info">
                            <h5>🎮 Singleplayer</h5>
                            <p>Play against AI and practice your skills.</p>
                        </div>
                    </div>
                </div>

                <!-- Multiplayer Options (Side-by-Side on Large Screens, Hidden Initially) -->
                <div id="multiplayer-options" style="display:none" class="selection-container d-none">

                    <div class="game-form">
  <div class="switch-container">
  <label class="switch">
    <input type="checkbox" id="create_a_new">
    <span class="slider round"></span>
  </label>
  <label for="create_a_new" class="switch-label">Create New Game</label>
</div>


  <label for="no_players">Number of Players</label>
  <input type="text" id="no_players"/>

  <label for="game_name">Duel Name</label>
  <input type="text" id="game_name"/>

  <label for="game_description">Description</label>
  <input type="text" id="game_description"/>
</div>
                    <div class="selection-card" id="play_random">
                        <img src="./img/random.png" alt="Random Match">
                        <div class="card-info">
                            <h5>🎲 Play Random</h5>

                            <p>Find a random opponent & challenge them!</p>
                        </div>
                    </div>

                    <div class="selection-card" id="play_friend">
                        <img src="./img/friend.jpg" alt="Play with Friend">
                        <div class="card-info">
                            <h5>👫 Play with Friend</h5>
                            <p>Invite and challenge a specific friend.</p>
                        </div>
                    </div>
                    <!-- Back Button (Centered) -->
                <div class="text-center mt-3 d-none" id="back_button">
                    <button id="back_to_menu" class="btn btn-secondary">
                        <i class="fa fa-arrow-left"></i> Back
                    </button>
                </div>
                </div>

                
            </div>
        </div>
    </div>
</div>


<!-- Continue Game Modal -->
<div id="continueGame" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="continueGameLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            
            <!-- Header -->
            <div class="modal-header text-center">
                <h3 id="continueGameLabel" class="w-100">Continue Game?</h3>
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
            </div>

            <!-- Main Content -->
            <div class="modal-body text-center">
                <p>Would you like to continue your previous game?</p>

                <!-- Buttons -->
                <div class="d-flex justify-content-around mt-3">
                    <button id="continueGameBtn" class="btn btn-success">Continue Game</button>
                    <button id="cancelGameBtn" class="btn btn-danger" data-dismiss="modal">Cancel</button>
                </div>
            </div>
        </div>
    </div>
</div>



<div id="leader_board" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
        <div class="modal-dialog modal_table">
            <div class="modal-content modal_cell">
                <div class="modal-content">
                    <div class="container">
                        
                            
                                <div class="modal-header">
                                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true"><i class="fa fa-times"></i></button>
                                    <h3 id="myModalLabel"><i class="fa fa-user"></i> &nbsp; Leader Board.</h3>
                                </div>
                                <div class="modal-body">
                                  <div class="container text-center mt-4">
                                        <h2>🏆 Leaderboard</h2>
                                        <table class="table table-dark">
                                            <thead>
                                                <tr>
                                                    <th>Rank</th>
                                                    <th>Player</th>
                                                    <th>Score</th>
                                                </tr>
                                            </thead>
                                            <tbody id="leaderboard-list">
                                                <!-- Rankings will be inserted here -->
                                            </tbody>
                                        </table>
                                    </div>

                                </div>
                                <div class="modal-footer">
                                    <div class="form-group">
                                      
                                    </div>
                                </div>
                        
                       
                    </div>
                </div>
            </div>
        </div>
    </div>


<div id="game_end_modal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
        <div class="modal-dialog modal_table">
            <div class="modal-content modal_cell">
                <div class="modal-content">
                    <div class="container">
                        <div class="row">
                            <div class="col-sm-6 col-sm-offset-3">
                                <div class="modal-header">
                                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true"><i class="fa fa-times"></i></button>
                                    <h3 id="myModalLabel"><i class="fa fa-user"></i> &nbsp; The game has ended.</h3>
                                </div>
                                <div class="modal-body">
                                    <div class="row">
                                 <p id="game_winner" style="text-align:center"></p>
                                 
                                 <div class="col-md-12" style="text-align:center"><button id="play_again" class="btn btn-large btn-success">Play Again</button></div>
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <div class="form-group">
                                        <div class="col-sm-4 text-left">
                                            <button class="btn btn-info btn-block " id="end_game"> Go Home</button>
                                        </div>
                                        <div class="col-sm-8">
                                            
                                            
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

<!-- Auth Modal -->
<div class="modal" id="authModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="auth-card">
  <div class="card-inner" id="authCardInner">
    <div class="auth-face auth-front" id="loginFace">
      <h3>Login</h3>
      <form>
      <input type="email" placeholder="Email" id="loginEmail" />
      <input type="password" placeholder="Password" id="loginPassword" />
      <button class="auth-btn" id="loginBtn" onclick="login()">Login</button>
      <p><a href="#" onclick="flipTo('register')">Register</a> | <a href="#" onclick="flipTo('guest')">Guest</a> | <a href="#" onclick="flipTo('forgot')">Forgot Password</a></p>
  </form>
    </div>

    <div class="auth-face auth-back" id="registerFace">
      <h3>Register</h3>
      <input type="text" placeholder="Name" id="regName" />
      <input type="text" placeholder="Phone" id="regPhone"/>
      <input type="email" placeholder="Email" id="regEmail"/>
      <input type="password" placeholder="Password" id="regPassword"/>
      <button class="auth-btn" id="registerBtn" onclick="register()">Register</button>
      <p><a href="#" onclick="flipTo('login')">Login</a></p>
    </div>

    <div class="auth-face auth-guest" id="guestFace">
      <h3>Guest Access</h3>
      <input type="text" placeholder="Nickname" id="Nickname" />
      <button class="auth-btn" onclick="guestLogin()">Continue</button>
      <p><a href="#" id="guestBtn" onclick="flipTo('login')">Login</a></p>
    </div>
<div class="auth-face auth-forgot" id="forgotFace">
  <h3>Reset Password</h3>
  <input type="email" placeholder="Your Email" id="forgotEmail" />
  <button class="auth-btn" id="resetBtn" onclick="resetPassword()">Send Reset Link</button>
  <p><a href="#" onclick="flipTo('login')">Back to Login</a></p>
</div>


  </div>
</div>

  </div>
</div>
<!-- Logout Confirmation Modal -->
<div class="modal fade" id="logoutModal" tabindex="-1" aria-labelledby="logoutModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content bg-dark text-white">
      <div class="modal-header">
        <h3 class="modal-title" id="logoutModalLabel">Confirm Logout</h3>
        
      </div>
      <div class="modal-body">
        Are you sure you want to logout? All progress will be lost if you are still playing.
      </div>
      <div class="modal-footer">
        <button type="button" id="cancelLogoutBtn" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-danger" id="confirmLogoutBtn">Logout</button>
      </div>
    </div>
  </div>
</div>


    <div id="toast-container"></div>


    <!-- Include Firebase UMD CDN -->
    <script src="https://www.gstatic.com/firebasejs/10.10.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.10.0/firebase-firestore-compat.js"></script> 
    <script src="https://www.gstatic.com/firebasejs/10.10.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.10.0/firebase-auth-compat.js"></script>
      <script type="module" src="https://cdn.jsdelivr.net/npm/emoji-picker-element@1.6.2/index.js"></script>
    <script>

let interstitialAd = null;
let rewardedAd = null;

const cardClickSound = document.getElementById('cardClickSound');
const areaClickSound = document.getElementById('areaClickSound');
const pickCardSound = document.getElementById('pickCardSound');
const submitCardSound = document.getElementById('submitCardSound');
/*  const alertCardSound = document.getElementById('alertCardSound');*/
let dragging = null; 
let originalIndex; 
let cardPositions = [];
let my_play=[];
let plays =[];
let start_play = false;
let my_cards = [];
let play_type ='';
let card_picked =false;
let play_type_array =[''];
let to_pick ='';
let card_request = false;
let card_requested ='';
let cardless =false;
let kadi =false;
let user = "";

let current_player = "";
let play_state = "";
let begin_card_index;
let prev_play=[];
let player_fined = false;
let number_of_plays = 1;
let p_status = "";
let my_fine = 0;
let picked_fine = false;
let p_allowed =true;
let allow_change = false;
let timeout ='true';
let opponent = 'random';
let no_players = 2;
let create_a_new = false;
let game_name = "";
let game_description = "";

//Tutorial var

let start_tutorial = false;
var steps = ['circle1','h3','circle1','circle5', 'circle2', 'circle3', 'circle4','fin','end'];
var tutorial_count = 0;

    let playerID; 
    let playerName;
    let playerPhoto;
    let duel_id;

    </script>
    <script src="./firebase-init.js"></script>
        
<script src="./helper.js"></script>
    <script src="./auth.js"></script>
    <script src="./init.js"></script>
    <script src="./info.js"></script>
    <script src="./engine.js"></script>
    <script src="./chats.js"></script>

<script type="text/javascript">
  


       $(document).ready(function() {

    const storedPlayerID = localStorage.getItem("playerID");
    if (storedPlayerID) {
      playerID = storedPlayerID;
      playerName = localStorage.getItem("playerName") || "Player";
      playerPhoto = localStorage.getItem("playerPhoto") || "";
        $('#player-pic').attr('src',playerPhoto);
        $('.player-name').text(playerName);
      checkForInvitedGame(playerID);
    } else {
      $('#authModal').modal({
        backdrop: 'static',
        keyboard: false
      });
    } 
    
  $('#play_again').click(function(){
    localStorage.removeItem('activeGame');
    localStorage.removeItem('duel');
    localStorage.removeItem('kadi_plays');  
    localStorage.removeItem('registrationData1');   
    localStorage.removeItem('registrationData2');
    if(play_type =="single_player"){
            play_type = 'single_player';
    $('#game_selection').modal('hide');  
//localStorage.clear();
kadiSetup();
kadi_play_setup();
check_readiness();
tutorial2(tutorial_count);
    }
    else{
    $('#game_selection').modal({backdrop: 'static',
  keyboard: false  });

    $('#game_selection').modal('show');
}
  })
  $('#end_game').click(function(){
localStorage.removeItem('activeGame');
localStorage.removeItem('duel');
localStorage.removeItem('kadi_plays');  
localStorage.removeItem('registrationData1');   
localStorage.removeItem('registrationData2');
 
     $('#game_selection').modal({backdrop: 'static',
  keyboard: false  });

    
    
  })
     

   /* $('#game_selection').modal('show');
    $('#multi_player').css({'display':'none'});*/
   


//Ads
/***showBannerAd();***/
/***preloadAds();***/
        //









//Buttons for coninuing game
document.getElementById("cancelGameBtn").addEventListener("click", function() {
   
    localStorage.removeItem('activeGame');
    localStorage.removeItem('duel');
    localStorage.removeItem('kadi_plays');  
    localStorage.removeItem('registrationData1');   
    localStorage.removeItem('registrationData2');
    $('#continueGame').modal('hide');
    $('#game_selection').modal({backdrop: 'static',
  keyboard: false  });
});
document.getElementById("continueGameBtn").addEventListener("click", function() {
   
   
    $('#continueGame').modal('hide');
   setup_reset(duel_id);
   check_play2(duel_id);
   /*console.log(play_state)*/
  
});
// Select play mode
   

$('#single_player').on('click',function(){
    
    play_type = 'single_player';
    $('#game_selection').modal('hide');  
//localStorage.clear();
kadiSetup();
kadi_play_setup();
check_readiness();
tutorial2(tutorial_count);
  
})



 // Click Multiplayer → Show Multiplayer Options
    $("#multi_player").click(function() {
        $("#main-menu").slideUp(300);
        $("#multiplayer-options, #back_button").removeClass("d-none").hide().slideDown(300);
    play_type = 'multi_player';
    });

    // Click Back → Return to Main Menu
    $("#back_to_menu").click(function() {
        $("#multiplayer-options, #back_button").slideUp(300, function() {
            $("#main-menu").slideDown(300);
        });
    });

    // Highlight selected card
    $(".selection-card").click(function() {
        create_a_new = $("#create_a_new").is(":checked")
console.log(create_a_new)
    if(create_a_new == true){
    no_players = $('#no_players').val()
    game_name = $('#game_name').val()
    game_description = $('#game_description').val()
        
    }

        $(".selection-card").removeClass("selected");
        $(this).addClass("selected");
        let a =$(this).attr('id');
        if(a=='play_random'){
            play_type = 'multi_player';
            //opponent = 'friend';
           
            localStorage.removeItem('activeGame');
            localStorage.removeItem('duel');
            localStorage.removeItem('kadi_plays');  
            localStorage.removeItem('registrationData1');   
            localStorage.removeItem('registrationData2');
            kadiSetup();
            $('#game_selection').modal('hide'); 
            tutorial2(tutorial_count);

        }
        else if(a == 'play_friend'){
            opponent = 'friend';
            createNewGameWithFriend(playerID);
        }
    });







 $("#back_to_menu").click(function() {
        $("#multiplayer-options").slideUp(300, function() {
            $("#main-menu").slideDown(300);
        });
    });
/*$("#play_random").click(function() {
       
            $("#main-menu").slideDown(300);
        play_type = 'multi_player';
            opponent = 'friend';
        localStorage.clear();
kadiSetup();


tutorial2(tutorial_count); 
    });
$("#play_friend").click(function() {
       
            $("#main-menu").slideDown(300);
            play_type = 'multi_player';
            opponent = 'friend';
        localStorage.clear();
kadiSetup();


tutorial2(tutorial_count); 
    });*/
//tutorial Functions
$('#tutorial_next').on('click',function(){
    
    $('#tutorial_prev').show();
    tutorial_count += 1;
  tutorial2(tutorial_count);  
    
})
$('#tutorial_prev').on('click',function(){
    if(tutorial_count >0){
    tutorial_count -= 1;
    }
  tutorial2(tutorial_count);  
    
})
$('#tutorial_skip').on('click',function(){
    tutorial_count = 8;
  tutorial2(tutorial_count);  
    
})








    $('.holdin-p').each(function() {
    
        cardPositions.push($(this).position().left);
    });

    $('body').on('click','.card', function(e) {
       cardClickSound.play(); 
  if(dragging == null){
    todrag =$(this);
   
    todragB = $(this).css('background-color');
    todragI = $(this).attr('id');
 
    dragging = true;
  }
  else if(dragging == true){
    var a = $(this);
    
    var b = $(this).css('background-color');
    var c = $(this).attr('id');

    $(todrag).css('background-color',b);
    $(todrag).attr('id',c);

$(a).attr('id',todragI);
$(a).css('background-color',todragB);

todragB = null;
todragI = null;
todrag = null;
dragging = null;
  }

  });





    $('.playing-card').on('click', function(e) {
/*if(current_player == user && start_play == true){
*/    
areaClickSound.play();
var pcd  =todragI.split('_');


        if(card_picked ==false){
  if(dragging == null){
    
  }
  else if(dragging == true){
var ptal = play_type_array.length;
    if(to_pick == user && ([12,13,14,15,16,17,18,19,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53]).includes(parseInt(pcd[1])) ){

        showToast('This play is not allowed');
    }

   
    else{
    
        if(to_pick == user  ){
var pvl = prev_play.length;
if(parseInt(pcd[1])== 20 && ([20,21,22,23,24,29,28,0,1,2,3].includes(parseInt(prev_play[pvl-1])==false))  ){
    p_allowed = false;
}
else if(parseInt(pcd[1])== 21 && ([20,21,22,23,25,29,28,0,1,2,3].includes(parseInt(prev_play[pvl-1])==false))  ){
    p_allowed = false;
}
else if(parseInt(pcd[1])== 22 && ([20,21,22,23,26,29,28,0,1,2,3].includes(parseInt(prev_play[pvl-1])==false))  ){
    p_allowed = false;
}
else if(parseInt(pcd[1])== 23 && ([20,21,22,23,27,29,28,0,1,2,3].includes(parseInt(prev_play[pvl-1])==false))  ){
    p_allowed = false;
}
else if(parseInt(pcd[1])== 24 && ([20,24,25,26,27,29,0,1,2,3].includes(parseInt(prev_play[pvl-1])==false))  ){
    p_allowed = false;
}
else if(parseInt(pcd[1])== 25 && ([21,24,25,26,27,29,28,0,1,2,3].includes(parseInt(prev_play[pvl-1])==false))  ){
    p_allowed = false;
}
else if(parseInt(pcd[1])== 26 && ([22,24,25,26,27,29,28,0,1,2,3].includes(parseInt(prev_play[pvl-1])==false))  ){
    p_allowed = false;
}
else if(parseInt(pcd[1])== 27 && ([23,24,25,26,27,29,28,0,1,2,3].includes(parseInt(prev_play[pvl-1])==false))  ){
    p_allowed = false;
}
else if((parseInt(pcd[1])== 28 || parseInt(pcd[1])== 29 )&& ([20,21,22,23,24,25,26,27,28,0,1,2,3].includes(parseInt(prev_play[pvl-1])==false))  ){
    p_allowed = false;
}       
        }
       
if([0,1,2,3].includes(parseInt(pcd[1]))  && to_pick !=user && my_fine ==0){

    $('#card_request_modal').modal('show');
    card_request = 'hearts';
    card_request = true;
}
if(to_pick == user && [0,1,2,3].includes(parseInt(pcd[1]))){
    my_fine =0;
}
        /*else if(play_type_array[ptal -1] == 'fine' && ([20,21,22,23,24,25,26,27]).includes(parseInt(pcd[1])) ){
        play_type_array.push('fine_added'); 
        }
        else if(([12,13,14,15,16,17,18,19]).includes(parseInt(pcd[1])) ){
        play_type_array.push('question');
        }
        else if( ([4,5,6,7]).includes(parseInt(pcd[1])) ){
        play_type_array.push('kickback');
        
        }
        else if( ([8,9,10,11]).includes(parseInt(pcd[1])) ){
        play_type_array.push('jump');
        }*/
if(p_allowed == false){
    showToast('You are not allowed to play this way');
}
if(p_allowed == true){
    var current_card =0;
    var no_cards =0;
$('.card').each(function() {
    no_cards += 1;
    if($(this).attr('id') == todragI){
        current_card = no_cards;
    }
    
    });
if(current_card != no_cards ){
    
for (var i = current_card-1; i <= no_cards; i++) {
    var x = i+1;
   var d =  $('.card_'+x).css('background');
  var e  =  $('.card_'+x).attr('id');
 
   $('.card_'+i).attr('id',e);
   if(i ==no_cards-1){
   var tr = $('.card_'+i).parent();
    $('.card_'+i).parent().remove();
     $('.card_'+i).remove();

     tr.remove();
   }
}

}

else if(current_card == no_cards && no_cards == 1){
 
$('.card_'+(current_card-1)).remove();
}

else if(current_card == no_cards && no_cards >1){
 $('.card_'+(current_card-1)).parent().remove();
$('.card_'+(current_card-1)).remove();
}

$(this).attr('id',todragI);
$(this).css('background-color',todragB);

my_play.push(pcd[1]);
plays.push(pcd[1]);

todragB = null;
todragI = null;
todrag = null;
dragging = null;
//play_type ='normal';
/*console.log(my_play);*/
  }

}
}
}
else{
/*console.log(card_picked);*/
showToast('You have picked a card');

}
/*}
else{
    alert('Not your turn yet')
}
*/


  });






$('#pick_c').click(function(){


pickCardSound.play();
if(current_player == user){


var questions =[12,13,14,15,16,17,18,19];
var ptal = play_type_array.length;
var ml = my_play.length;
 
/*console.log(

    ( my_play.length==0 || (card_picked==false && ml>0 && questions.includes(parseInt(my_play[ml-1]))
    ) || (to_pick ==user && my_fine >0) )
     && picked_fine == false);*/





    if( ( my_play.length==0 || (card_picked==false && ml>0 && questions.includes(parseInt(my_play[ml-1]))) || (to_pick ==user && my_fine >0) ) && picked_fine == false ){

    var no_cards =0;
var shuffled_rc =shuffleArray(ready_cards);
var picked_card = shuffled_rc[0];

$('.card').each(function() {
    no_cards += 1;
   });
    if(no_cards == 0){

$('<div class="card_'+0+' card" id ="card_'+picked_card+'"style="text-align: left;color:white;height:300px;width:200px;"></div>').appendTo('#h'+0);

    }
    else{
var new_card =no_cards ;
marg =  no_cards+'00px';
$('#h'+(no_cards-1)).after('<div class="holdin-p" id="h'+new_card+'" style="height:300px;width:200px;"><div class="card_'+new_card+' card" id ="card_'+picked_card+'"style="text-align: left;color:white;height:300px;width:200px;left: -'+marg+'">card </div></div>');
}
if(to_pick == user){
    my_fine  = my_fine-1;
}

shuffled_rc.shift();

ready_cards = shuffled_rc;
card_picked = true;

if(!questions.includes(parseInt(my_play[ml-1]))){
my_play.push('picked_card');
}
else{
    card_picked = true;
}

//play_type = 'normal_pick';

play_type_array.push('picked_card');
    






}
else{
    showToast('You have picked a card');
}


}
else{
    showToast('Not your turn yet');
}



});


$('#undo').click(function(){

/*if(current_player == user){*/


    if(my_play.length > 0){
if(card_picked == false){

        var l = my_play.length;
    var ucard =my_play[l-1];
my_play.pop();
    var no_cards =0;
$('.card').each(function() {
    no_cards += 1;
   });
    if(no_cards == 0){
$('<div class="card_'+0+' card" id ="card_'+ucard+'"style="text-align: left;color:white;height:300px;width:200px;"></div>').appendTo('#h'+0);

    }
else{
var new_card =no_cards ;
marg =  no_cards+'00px';

$('#h'+(no_cards-1)).after('<div class="holdin-p" id="h'+new_card+'" style="height:300px;width:200px;"><div class="card_'+new_card+' card" id ="card_'+ucard+'"style="text-align: left;color:white;height:300px;width:200px;left: -'+marg+';">card '+ucard+'</div></div>');
}

if(l>1){ 
    $('.playing-card').fadeOut(1000, function() {
    $(this).attr('id', 'card_'+my_play[l-2]);  
    $(this).slideDown(1000);
});


}
else{
   var lp =  prev_play.length;

    $('.playing-card').fadeOut(1000, function() {
    $(this).attr('id', 'card_'+prev_play[lp-1]);  
    $(this).slideDown(1000);
});
}
plays.pop();
play_type ='';
play_type_array.pop();



}
else{
   showToast('You have already picked a card');

}

}
else{
   showToast('You have not played');
}
/*}
else{

    alert('Not your turn yet');
}*/


});
$('#kadi').click(function(){
if(current_player == user){

kadi = true;
}
else{
    showToast('Not your turn yet');
}

});


    $('#play_end').click(async function() {
    submitCardSound.play();
    if (current_player == user) {
        var submit_play = true;
        var ml = my_play.length;
        var questions = [12, 13, 14, 15, 16, 17, 18, 19];
        var ace = [0, 1, 2, 3];

        if (ml == 0 && card_picked == false) {
            showToast('You need to play first');
        } else {
            if (card_picked == false && questions.includes(parseInt(my_play[ml - 1]))) {
                showToast('You need to pick a card then press play');
                submit_play = false;
            }
            if (to_pick == user && my_fine > 0) {
                if (my_play[ml - 1] == 'picked_card') {
                    showToast('You haven\'t picked all cards');
                    submit_play = false;
                }
            }
            if (submit_play == true) {
                var player_cards = [];

                $('.card').each(function() {
                    var a = $(this).attr('id');
                    var b = a.split('_');
                    player_cards.push(b[1]);
                });

                if (player_cards.length == 0) {
                    cardless = true;
                }

                var lply = [];
                if (Array.isArray(prev_play)) {
                    lply = prev_play;
                } else {
                    lply.push(prev_play);
                }

                // Prepare data to send to kadiPlay
                var response = await kadiPlay(
                    user,            // player
                    player_cards,    // playerCards
                    cardless,        // cardless
                    kadi,            // kadi
                    my_play,         // playerPlay
                    ready_cards,     // readyCards
                    card_request,    // cardRequest
                    card_requested,   // cardRequested
                    lply             // lastPlay
                );

            
                // Handle the response
                play_state = JSON.parse(response).play_status; // Assuming kadiPlay returns play_status
                ready_cards = JSON.parse(response).ready_cards; // Assuming kadiPlay returns updated ready_cards
                current_player = JSON.parse(response).next_player; // Assuming kadiPlay returns next_player

                if (JSON.parse(response).game_end == 'true' ||JSON.parse(response).game_end == true) {
                    $('#game_end_modal').modal('show');
                    $('#game_winner').text('The winner is ' + JSON.parse(response).game_winner);
                } else {
                    if (JSON.parse(response).to_fine == 'self') {
                        if (parseInt(JSON.parse(response).fine) == 1 && JSON.parse(response).next_player != user) {
                           
                            var fined_card = JSON.parse(response).fined_card;
                            var lp = prev_play.length;

                            $('.playing-card').fadeOut(1000, function() {
                                $(this).attr('id', 'card_' + prev_play[lp - 1]);
                                $(this).slideDown(1000);
                            });

                            $.each(my_play, function(index, value) {
                                var no_cards = 0;
                                $('.card').each(function() {
                                    no_cards += 1;
                                });

                                if (no_cards == 0) {
                                    $('<div class="card_' + 0 + ' card" id ="card_' + value + '" style="text-align: left;color:white;height:300px;width:200px;"></div>').appendTo('#h' + 0);
                                } else {
                                    var new_card = no_cards;
                                    var marg = no_cards + '00px';
                                    $('#h' + (no_cards - 1)).after('<div class="holdin-p" id="h' + no_cards + '" style="height:300px;width:200px;"><div class="card_' + (no_cards) + ' card" id ="card_' + value + '" style="text-align: left;color:white;height:300px;width:200px;left: -' + marg + ';"></div></div>');
                                }
                                my_play.unshift();
                            });

                            var no_cards = 0;
                            $('.card').each(function() {
                                no_cards += 1;
                            });
                            var new_card = no_cards;
                            var marg = no_cards + '00px';
                            var ucard = fined_card;

                            $('#h' + (no_cards - 1)).after('<div class="holdin-p" id="h' + (no_cards) + '" style="height:300px;width:200px;"><div class="card_' + (no_cards) + ' card" id ="card_' + ucard + '" style="text-align: left;color:white;height:300px;width:200px;left: -' + marg + ';"></div></div>');
                            picked_fine = true; // limit play
                        }
                    } else {
                        prev_play = my_play;
                        $('.last_play').remove()
                        if (prev_play[0] != 'picked_card') {
                            $.each(prev_play, function(index, value) {
                                $('#card_placeholder').after('<div style="width:50px;height:100px;flex-shrink:0;" class="last_play" id="card_' + value + '"></div>');
                            });
                        } else if (prev_play[0] == 'picked_card') {
                            $('#card_placeholder').after('<div style="width:50px;height:100px;flex-shrink:0;" class="last_play" id="card_pick"></div>');
                        }
                    }

                    my_play = []; // limit play
                    number_of_plays = parseInt(number_of_plays) + 1;
                    prev_play = [];
                    card_picked = false;
                    kadi = false;
                    
if(JSON.parse(response).next_player == 19 || JSON.parse(response).next_player == "19"){
   
await aiTurn(JSON.parse(response), duel_id);
}
                    if (JSON.parse(response).play_type == 'single_player') {
                        allow_change = true;
                    }
                }
            }
        }
    }
});




});






function tutorial2(start) {
    $('#tutorial_skip').show();
    $('#tutorial_next').show();
     $('.tutorial-overlay').show();
     $('.tutorial-text').show();
    

    if (start <= steps.length - 1) {
      showTutorial(steps[start], start);
        /*  setTimeout(function() {
            showTutorial(steps[start], start);
            tutorial2(start + 1);
            console.log(start + 1);
        }, 5000);*/
    } 
   
}

function showTutorial(part, start) {
      var text_steps = ["<h3>This is the playing area. Here you will drop your card.</h3>","<h3>To make a move on playing click on a card </h3>" ,"<h3>Then click on the playing area to move it to the playing area</h3>","<h3>Then click PLAY button to submit your move.</h3>" ,"<h3>Use the 'PICK' button to draw/pick a new card.</h3>" ,"<h3>Use 'UNDO' to undo your last move. as long as you have not picked</h3>" ,"<h3>Click 'KADI' when on your next play you're ready to finish the game.</h3>","<h3>To arrange your cards click on the card you wantto move and the card where you want to move it to.<br>When you or the other player has no cards after a play either of you cannot finish as someone will cardless.<br>Happy playing</h3>" 
        ];
    if(part=='h3' || part=='h2'){
           $('.circle').attr('class', ''); 
      $('.playing-card').attr('class', 'playing-card').css('z-index',''); 
      var x = 'card_3';
      $('#h3').css('z-index','');
       $('#circle1').css('z-index','');
       $('.circle2').attr('class', x +' card').css('z-index','');
        $('.tutorial-text').html(text_steps[start]);
         $('.circle').attr('class', '');
    var a =  $('#' + part);
    a.css('z-index','1000');
    a.find('.card').attr('class','holdin-p circle2').css('z-index','1000');  
    }
    else if(part=='circle1'){
           $('.circle').attr('class', ''); 
      $('.playing-card').attr('class', 'playing-card').css('z-index',''); 
      var x = 'card_3';
      $('#h3').css('z-index','');
       $('#circle1').css('z-index','');
       $('.circle2').attr('class', x +' card').css('z-index','');
       
   $('.tutorial-text').html(text_steps[start]);
      var a =  $('#' + part);
    a.css('z-index','1000');
    a.find('.card').attr('class','playing-card circle2').css('z-index','1000'); 
    }
    else if(part=='fin'){
           $('.circle').attr('class', ''); 
      $('.playing-card').attr('class', 'playing-card').css('z-index',''); 
      var x = 'card_3';
      $('#h3').css('z-index','');
       $('#circle1').css('z-index','');
       $('.circle2').attr('class', x +' card').css('z-index','');
    $('.tutorial-text').html(text_steps[start]);
    }
    else if(part=='end'){
        
           $('.circle').attr('class', ''); 
      $('.playing-card').attr('class', 'playing-card').css('z-index',''); 
      var x = 'card_3';
      $('#h3').css('z-index','');
       $('#circle1').css('z-index','');
       $('.circle2').attr('class', x +' card').css('z-index','');
   $('#overlay').remove();
     $('#tutorial-text').remove();
      $('#tutorial_skip').hide();
    $('#tutorial_next').hide();
     $('#tutorial_prev').hide();
    }
    else{
           $('.circle').attr('class', ''); 
      $('.playing-card').attr('class', 'playing-card').css('z-index','900'); 
      var x = 'card_3';
      $('#h3').css('z-index','');
       $('#circle1').css('z-index','');
       $('.circle2').attr('class', x +' card').css('z-index','');
        $('.tutorial-text').html(text_steps[start]);
        $('.circle').attr('class', '');
    $('#' + part).attr('class', 'circle');
    
}
}


function check_readiness() {
   // check if all are onboard
if( p_status == 'playing'){


check_play2(duel_id);
start_play =true;
}
else{

start_playing();
check_play(duel_id);
if(opponent == "friend"){
//inviteFriendToGame();
}
}

}


function start_playing(){
/*console.log(current_player);
console.log(start_play);
console.log(play_state);
console.log(user);*/

if(start_play == false  && play_state =='starting' && user == current_player ){

var start_cards =shuffleArray([30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53]);
/*var start_cards =shuffleArray([50,51,52,53]);*/

var stl =start_cards.length;
begin_card_index =start_cards[stl -1];
/*console.log(begin_card_index);*/
var begin_card ='card_'+ begin_card_index;
var last_play =begin_card_index;

 prev_play =[begin_card_index];
$('.playing-card').fadeOut(1000, function() {
    $(this).attr('id', begin_card);  
    $(this).slideDown(1000);
});
plays.push(begin_card_index);
start_cards.pop();

ready_cards =shuffleArray(start_cards.concat([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29]));
/*ready_cards =shuffleArray([30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53]);*/
start_play = true; 


for(i=0; i<=3;i++){

my_cards.push(ready_cards[i]);
if(i==0){

$('<div class="card_'+i+' card" id ="card_'+ready_cards[i]+'"style="text-align: left;color:white;height:300px;width:200px;">card '+1+'</div>').appendTo('#h'+i);
ready_cards.shift();
    }
else{
    var no_cards = ($('.cards').length)-1;
    var new_card = i;
    var marg =  i+'00px';
    var holder = i -1;


$('#h'+holder).after('<div class="holdin-p" id="h'+new_card+'" style="height:300px;width:200px;"><div class="card_'+new_card+' card" id ="card_'+ready_cards[i]+'"style="text-align: left;color:white;height:300px;width:200px;left: -'+marg+';"></div></div>');
ready_cards.shift();


}

}


start_game(duel_id,begin_card_index,ready_cards);

}


else{
// console.log(start_play);
// console.log( play_state);
if(start_play == false  && play_state =='starting_others'){
start_play = true;
var begin_card ='card_'+ begin_card_index
$('.playing-card').fadeOut(1000, function() {
    $(this).attr('id', begin_card);  
    $(this).slideDown(1000);
});
plays.push(begin_card_index);
ready_cards = shuffleArray(ready_cards);
/*console.log(ready_cards)*/
for(i=0; i<=3;i++){

my_cards.push(ready_cards[i]);
if(i==0){
$('<div class="card_'+i+' card" id ="card_'+ready_cards[i]+'"style="text-align: left;color:white;height:300px;width:200px;">card '+1+'</div>').appendTo('#h'+i);
ready_cards.shift();
    }
else{
    no_cards = ($('.cards').length)-1;
    new_card = i;
    var marg =  i+'00px';
    var holder = i -1;
$('#h'+holder).after('<div class="holdin-p" id="h'+new_card+'" style="height:300px;width:200px;"><div class="card_'+new_card+' card" id ="card_'+ready_cards[i]+'"style="text-align: left;color:white;height:300px;width:200px;left: -'+marg+';"></div></div>');
ready_cards.shift();
}






}
start_game(duel_id,begin_card_index,ready_cards);

}




}

}


function shuffleArray(array) {
    for (var i = array.length - 1; i > 0; i--) {
        var j = Math.floor(Math.random() * (i + 1));
        var temp = array[i];
        array[i] = array[j];
        array[j] = temp;
    }
    return array;
}

function start_game(duel_id,begin_card_index,ready_cards){
let kadiPlays; 
let reg2;
let duelData;


if(play_type == 'single_player'){

kadiPlays = JSON.parse(localStorage.getItem('kadi_plays')) || [];

reg2 = JSON.parse(localStorage.getItem('registrationData2')) || [];
duelData = JSON.parse(localStorage.getItem('duel')) || [];  
cards_set(duelData,kadiPlays,reg2)
check_play2(duel_id);
}
else{

db.ref("games/" + duel_id + "/duel").once("value", function(snapshot) {
  if (snapshot.exists()) {
    duelData = snapshot.val();
    
  }
});

db.ref("games/" + duel_id + "/kadi_plays").once("value", function(snapshot) {
  if (snapshot.exists()) {
    kadiPlays = snapshot.val();
    
  }
});


   db.ref("games/" + duel_id + "/duel").once("value", function(snapshot) {
    if (snapshot.exists()) {
        duelData = snapshot.val();
        /*console.log("Duel Data Loaded:", duelData);*/

        // Fetch Kadi Plays AFTER duelData is available
        db.ref("games/" + duel_id + "/kadi_plays").once("value", function(snapshot) {
            if (snapshot.exists()) {
                kadiPlays = snapshot.val();
                /*console.log("Kadi Plays Loaded:", kadiPlays);*/

                // Now that both duelData and gameData are ready, process them
                
            cards_set(duelData,kadiPlays)
            check_play2(duel_id);
            }else{

            cards_set(duelData,kadiPlays)
            check_play2(duel_id);
            }
        });
    }


});






}


   /*  $.ajax({
                 method:'post',
                 url: '<?php echo base_url(); ?>challenge/kadi_start',
                
                 data:data_to_send,
                 dataType: "JSON",
                 success: function(msg) {
                     prev_play =[begin_card_index];
check_play2(duel_id);


                 }
             });*/




}

async function check_play(duel_id) {
  let duel;

  const x = setInterval(async function () {
    try {
      const kadiPlays = await getKadiPlays(duel_id);
      if (kadiPlays) {
        /*console.log("Kadi Plays Loaded:", kadiPlays);*/
        play_state = kadiPlays.play_status;

        ready_cards = kadiPlays.ready_cards;
        current_player = kadiPlays.playing;

        const lastPlayRaw = kadiPlays.last_play;
        const lastPlayArray = Array.isArray(lastPlayRaw)
          ? lastPlayRaw
          : JSON.parse(lastPlayRaw);

        let lastPlay = lastPlayArray || [];
        const lpl = lastPlay.length;
        /*console.log("Last play length:", lpl);*/

        if (lpl > 0 && lastPlay[0].play.length > 0) {
          begin_card_index = lastPlay[0].play[0];
        }

        for (let i = lpl - 1; i >= 1; i--) {
          const lpla = Array.isArray(lastPlay[i].play)
            ? lastPlay[i].play
            : JSON.parse(lastPlay[i].play);

          if (
            lpla[lpla.length - 1] !== "picked_card" &&
            lastPlay[i].to_fine !== "self"
          ) {
            let s = lpla.length - 1;

            for (let t = s; t >= 0; t--) {
              if (
                lastPlay[i].card_requests === "true" &&
                [0, 1, 2, 3].includes(lpla[t])
              ) {
                begin_card_index = parseInt(lpla[t]);
                break;
              } else if (
                (lpla[t] === 28 || lpla[t] === 29) &&
                lastPlay[i].to_fine === "19"
              ) {
                begin_card_index = parseInt(lpla[t]);
                break;
              } else {
                if (
                  (lastPlay[i].card_requests !== "true" &&
                    ![0, 1, 2, 3].includes(lpla[t])) ||
                  (lpla[t] !== 28 &&
                    lpla[t] !== 29 &&
                    lastPlay[i].to_fine !== "19")
                ) {
                  begin_card_index = parseInt(lpla[t]);
                  break;
                }
              }
            }
            break;
          }
        }

        prev_play = [begin_card_index];
        /*console.log(prev_play)
        console.log(play_state)*/
        if (play_state === "playing") {
          start_play = true;
          clearInterval(x); // Clear here to avoid duplicate calls
          check_play2(duel_id);
        } else if (play_state === "starting_others") {
          /*console.log("Starting Others:", play_state);*/
          start_playing();
        }
      }
    } catch (err) {
      console.error("Error checking play:", err);
    }
  }, 1000);
}



   async function kadiCheckPlay(duel_id) {
    let kadiPlays = await getKadiPlays(duel_id);

    
   // console.log((kadiPlays));
    //learn how to go over objects more so if the key is empty ""
    const duel = kadiPlays;
    //const play_history = kadiPlays[duel_id].last_play;
    
    if (!duel) {
        console.error('No duel found');
        return;
    }
 const kpp = duel;
//console.log(kpp.last_play)
const kppo = kpp.last_play;


let last_play = kppo || []




let lpl = last_play.length;

    const lastPlay =Array.isArray(last_play)? last_play: JSON.parse(last_play);
    const cardless = Array.isArray(duel?.cardless_status) && duel.cardless_status.length > 0;
    const kadi = Array.isArray(duel?.kadi_status) && duel.kadi_status.length > 0;
    const playsNo = (lastPlay).length;
    
    let playableCard = lastPlay[0]?.play || null;
    let currentPlayerId = duel.playing;
    let currentPlayerName = '';//(currentPlayerId === userId) ? 'You' : getFullnameByID(currentPlayerId); // Placeholder function to get player name
    let playerIcon = currentPlayerName.charAt(0).toUpperCase();
    let gameEnd = lastPlay[playsNo -1].game_end == undefined ? false:lastPlay[playsNo -1].game_end;

    // Determine the timeout status
   // const timeoutT = localStorage.getItem('timeout'); // Assuming timeout is also stored
   // const timeout = (Date.now() < timeoutT) ? 'true' : 'false';

    if (playsNo >= 2) {
        for (let i = playsNo - 1; i > 0; i--) {
            const play =lastPlay[i].play;
            if (play[play.length - 1] !== 'picked_card' && lastPlay[i].player_fined != '1') {
                playableCard = play[play.length - 1];
                break;
            }
        }
    }

    const data = {
        play_status: duel.play_status,
        playing: duel.playing,
        card_request: lastPlay[playsNo - 1]?.card_request,
        card_requested: lastPlay[playsNo - 1]?.card_requested,
        plays: lastPlay[playsNo - 1]?.play,
        ready_cards: duel.ready_cards,
        player_fined: lastPlay[playsNo - 1]?.player_fined,
        to_fine: lastPlay[playsNo - 1]?.to_fine,
        plays_num: playsNo,
        playable_card: playableCard,
        normal_play: '', // Add logic if needed
        cardless: cardless,
        kadi: kadi,
        game_end: gameEnd,
        current_player_icon: playerIcon,
        current_player_name: currentPlayerName,
        //game_winner: gameEnd ? getFullnameByID(lastPlay[playsNo - 1]?.player) : '',
        //timeout: timeout
    };

    return (JSON.stringify(data)); // Use this data as needed
}
async function setup_reset(duel_id){
const lastCard = await game_info(duel_id);
let my_c =  await getMyCards( play_type);
my_cards =JSON.parse(my_c);

var begin_card ='card_'+ lastCard
$('.playing-card').fadeOut(1000, function() {
    $(this).attr('id', begin_card);  
    $(this).slideDown(1000);
});
plays.push(lastCard);
for(i=0; i<=(my_cards.length)-1;i++){

if(i==0){
$('<div class="card_'+i+' card" id ="card_'+my_cards[i]+'"style="text-align: left;color:white;height:300px;width:200px;"></div>').appendTo('#h'+i);

    }
else{
    no_cards = ($('.cards').length)-1;
    new_card = i;
    var marg =  i+'00px';
    var holder = i -1;
$('#h'+holder).after('<div class="holdin-p" id="h'+new_card+'" style="height:300px;width:200px;"><div class="card_'+new_card+' card" id ="card_'+my_cards[i]+'"style="text-align: left;color:white;height:300px;width:200px;left: -'+marg+';"></div></div>');

}

}

}

function check_play2(duel_id){

setInterval(async function() {
    
                 const msg =JSON.parse(await kadiCheckPlay(duel_id));
                
                 play_state = msg.play_status;
                 player_fined =msg.player_fined;
                 ready_cards = Array.isArray(msg.ready_cards)?msg.ready_cards:JSON.parse(msg.ready_cards);
                 to_pick = msg.to_fine;
                 timeout = msg.timeout;
               if(msg.game_end=='true' || msg.game_end==true){
                   
     let rank_info = await getPlayerRank();
    $('#game_end_modal').modal('show');
    $('#game_winner').text('The winner is '+ msg.game_winner + '<br>' + rank_info);



                   
                   
                   
                 $('#winner_icon').text(msg.game_winner_icon);
      $('#winner_text').text(msg.game_winner + ' has won. ');
/* $( "#notifywin" ).toggle( "slide" );*/

               }
                else{
              /*   if((number_of_plays < msg.plays_num || msg.plays_num == 1) && play_state=='playing' && (current_player != user || allow_change == true)){*/
                if( (current_player != user || allow_change == true)){

                    card_request =msg.card_request;
                card_requested =msg.card_requested;
                      if(number_of_plays < msg.plays_num || allow_change == true ){
                        if(!(msg.plays).includes('picked_card') ){
                         prev_play =msg.plays;
                         setplay(); 
                     }

else{
                        prev_play=[msg.playable_card];
    showCustomAlert('Player two picked');

    
                     }
                       

                          
                 number_of_plays =msg.plays_num;
             }/*Add only if there is new play else this will not run as  number of plays will continously add*/
                 picked_fine =false;
                 card_picked =false;
                 cardless = msg.cardless;
                 kadi =msg.kadi;
                 card_picked =false;
                 picked_fine =false;
                 
                 current_player = msg.playing;
                /*   if(msg.plays_num >1){
                    number_of_plays +=1;
                   }*/
                   

                   if(current_player == user){
 $('#winner_text').text(msg.current_player_name + 'Your turn to play');
 /*$( "#notifywin" ).toggle( "slide" );*/
                    if(to_pick ==user){
                          $('#winner_text').text(msg.current_player_name + ' have been asked to pick '+msg.player_fined+' card/s');
 /*$( "#notifywin" ).toggle( "slide" );*/
                        my_fine = msg.player_fined;
                    }
                    
                    if(to_pick !=user && msg.player_fined == '1'){
                        
                        $('.playing-card').fadeOut(1000, function() {
    $(this).attr('id', 'card_'+msg.playable_card);  
    $(this).slideDown(1000);
});
                          showCustomAlert('Previous player has been fined for foul play.');;
 
                    }
                   }
                   else{


      $('#winner_text').text(msg.current_player_name + ' is currently playing');
/* $( "#notifywin" ).toggle( "slide" );*/
                   }
                 
                   if(card_request == true){
                    var t  = $('#winner_text').text();   
                    $('#winner_text').text(t+ '. '+ card_requested+ ' card has been requested');
                   }
                   if(cardless == true){
                    var t  = $('#winner_text').text();
                    showCustomAlert('There is a cardless player');
                   }
                   if(kadi == true){
                       var t  = $('#winner_text').text();
                    showCustomAlert('There is a player who is kadi');
                   }
                   
                 }


}
allow_change = false;


            
 
},1000);
}
$('.select-card').click(function(){
    card_requested =$(this).attr('id');
    $('#card_request_modal').modal('hide');
    showToast('You have requested '+card_requested);
})




function setplay(){

    if(prev_play[0] !='picked_card'){
$.each(prev_play,function(index,value){

var current_card ='card_'+ value;
$('.playing-card').fadeOut(1000, function() {
    $(this).attr('id', current_card);  
    $(this).slideDown(1000);
});
$('.last_play').remove()
$('#card_placeholder').after('<div style="width:50px;height:100px;flex-shrink:0;" class="last_play" id="card_'+ value+'"></div>');
});
}
else if(prev_play[0] =='picked_card'){
    $('.last_play').remove()
    $('#card_placeholder').after('<div class="last_play" style="width:50px;height:100px;flex-shrink:0;" id="card_pick"></div>');
    
    
}
/*
if(player_fined =='none' ||player_fined.length==0)
    {

    }
    else{


    }*/
    /*if(player_fined == true)
    {

$.each(prev_play,function(index,value){

var current_card ='card_'+ value;
$('.playing-card').attr('id',current_card);

});

alert('player fined');
var pl = plays.length;
if(plays[pl-1] !='picked_card'){
$('.playing-card').attr('id','card_'+plays[pl-1]);
}
player_fined = false;

    }
        else{

$.each(prev_play,function(index,value){

var current_card ='card_'+ value;
if(plays[pl-1] !='picked_card'){
$('.playing-card').attr('id',current_card);
plays.push(parseInt(value));
}
}); 
        }
*/





if(start_play == true){
    clearInterval(this);
}

}



async function game_info(duel_id){
    let kadiPlays = await getKadiPlays(duel_id);
 const kpp = kadiPlays;

const kppo = (kpp.last_play[0]) == '[' ?JSON.parse(kpp.last_play):kpp.last_play;//Comment we check for [ because on second play we cannot parse the json an we need to differentiate when to parse on second play the [0] is an array instead of [

let last_play = kppo || []

let lpl = last_play.length;
let prev_card = last_play[0]?.play[0];

// Loop through last plays to find the previous valid card
for (let i = lpl - 1; i >= 1; i--) {
    let lpla = Array.isArray(last_play[i].play)?last_play[i].play:JSON.parse(last_play[i].play);

    if (
        lpla[lpla.length - 1] !== 'picked_card' &&
        last_play[i].to_fine !== 'self' &&
        ![0, 1, 2, 3].includes(lpla[lpla.length - 1])
    ) {
        let s = lpla.length - 1;
        prev_card = parseInt(lpla[s]);
        break;
    }
}

// Ensure prev_card is properly set
prev_card = Array.isArray(prev_card) ? prev_card[0] : prev_card;
return(prev_card);

}

async function getMyCards( play_type) {
    let all_cards = [];

    if (play_type === "single_player") {
        

        let myCards = JSON.parse(localStorage.getItem('registrationData2'))?.my_cards || [];

        return myCards

    } else {
    

        try {
            const regRef = db.ref(`games/${duel_id}/registrationData`);
            const snapshot = await regRef.once("value");

            if (!snapshot.exists()) {
                console.error("Error: registrationData not found for duel_id:", duel_id);
                return [];
            }

            const regData = snapshot.val();

 if (player1 === playerID) {
                const leCards = Array.isArray(regData.player1.my_cards)
                return myCards; 
            }
            else{
                let myCards = Array.isArray(regData.player2.my_cards)
                return myCards; 

            }

            


        } catch (error) {
            console.error("Error fetching player cards from Firebase:", error);
            return [];
        }
    }

}



    











</script>






