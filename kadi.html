<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kadi Game - Facebook Login</title>
    <!-- <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fontsource/source-sans-3@5.0.12/index.css" integrity="sha256-tXJfXfp6Ewt1ilPzLDtQnJV4hclT9XuaZUKyUvmyr+Q=" crossorigin="anonymous">end::Fonts--><!--begin::Third Party Plugin(OverlayScrollbars)
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/overlayscrollbars@2.3.0/styles/overlayscrollbars.min.css" integrity="sha256-dSokZseQNT08wYEWiz5iLI8QPlKxG+TswNRD8k35cpg=" crossorigin="anonymous">end::Third Party Plugin(OverlayScrollbars)--><!--begin::Third Party Plugin(Bootstrap Icons)
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.min.css" integrity="sha256-Qsx5lrStHZyR9REqhUF8iQt73X06c8LGIUPzpOhwRrI=" crossorigin="anonymous"><!--end::Third Party Plugin(Bootstrap Icons)--><!--begin::Required Plugin(AdminLTE)-->
  


        
        <link href="./themes/default/css/font-awesome/css/font-awesome.min.css" rel="stylesheet">
        <link href="./themes/default/css/bootstrap.min.css" rel="stylesheet">
        <link href="./themes/default/css/animate.css" rel="stylesheet">
        <link href="./themes/default/css/emoji.css" rel="stylesheet">
        <link href="./themes/default/css/styles.css" rel="stylesheet">
        <link href="./themes/default/fonts/raleway/Raleway.css" rel="stylesheet">
        <link rel="apple-touch-icon" sizes="57x57" href="./uploads/apple-icon-57x57.png">
<link rel="apple-touch-icon" sizes="60x60" href="./uploads/apple-icon-60x60.png">
<link rel="apple-touch-icon" sizes="72x72" href="./uploads/apple-icon-72x72.png">
<link rel="apple-touch-icon" sizes="76x76" href="./uploads/apple-icon-76x76.png">
<link rel="apple-touch-icon" sizes="114x114" href="./uploads/apple-icon-114x114.png">
<link rel="apple-touch-icon" sizes="120x120" href="./uploads/apple-icon-120x120.png">
<link rel="apple-touch-icon" sizes="144x144" href="./uploads/apple-icon-144x144.png">
<link rel="apple-touch-icon" sizes="152x152" href="./uploads/apple-icon-152x152.png">
<link rel="apple-touch-icon" sizes="180x180" href="./uploads/apple-icon-180x180.png">
<link rel="icon" type="image/png" sizes="192x192"  href="/android-icon-192x192.png">
<link rel="icon" type="image/png" sizes="32x32" href="./uploads/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="96x96" href="./uploads/favicon-96x96.png">
<link rel="icon" type="image/png" sizes="16x16" href="./uploads/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<meta name="msapplication-TileColor" content="#ffffff">
<meta name="msapplication-TileImage" content="/ms-icon-144x144.png">
<meta name="theme-color" content="#ffffff">
        <!--[if lt IE 9]>
            <script src="//html5shim.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]-->
    
        <script src="./themes/default/js/jquery.min.js"></script>
        <script src="./themes/default/js/bootstrap.min.js"></script>
        <script src="./themes/default/mathquil/lib/mathquill.min.js"></script>
    <script src="./themes/default/mathquil/lib/matheditor.js"></script>
    
        
</head>
<body>


<div class="container" style="min-height:1005;height: 100vh;">
  
  

    <div id="custom-alert">
    This is a custom alert. It will disappear after 1 minute.
</div>
    
    <div style="position: fixed;z-index:1000; top: 10%;right:10%">
    <button class="btn btn-primary btn-lg" id="tutorial_prev" style="display:none;">Prev</button>
    <button class="btn btn-primary btn-lg" id="tutorial_next" style="display:none;">Next</button>
    <button class="btn btn-primary btn-lg" id="tutorial_skip" style="display:none;">Skip</button>
    </div>
<div id="notifywin" style="position: -webkit-sticky; position: sticky; top: 10%; background-color: yellow; padding: 0px; font-size: 20px; z-index: 10;">
  <div style="background: #f0f0f0; right: 0; z-index: 10; padding: 10px;">
    <div class="flex-container" style="display: flex; align-items: center;">
      <div style="flex-grow: 1; padding-right: 10px;">
        <p style="width: 40px; height: 40px; line-height: 40px; border-radius: 50%; font-size: 16px; color: #fff; text-align: center; background: #000;" id="winner_icon">S</p>
      </div>
      <div style="flex-grow: 8;">
        <div class="media-body" style="text-align: left;">
          <h4 style="padding-top: 5px; margin: 0;" id="winner_text">Hello</h4>
        </div>
      </div>
    </div>
  </div>
</div>

    



    <div class="row">
<div class="col-md-6">

    <div id="playing-area" style="margin:0 auto;">
 <div  id="circle1">
    <div class="playing-card" style="text-align: left;color:white;height:300px;width:200px;"></div>
</div>
</div>


</div>
<div class="col-md-6" style="z-index:999">
    <div >
     <div class="col-xs-3" style="z-index:999">
<div  id="circle2" style="z-index:999">
<button class="btn btn-primary" id="pick_c">PICK</button></div>
 </div>
 <div   class="col-xs-3" >
<div  id="circle3"> 
<button class="btn btn-primary" id="undo">UNDO</button>
</div>
</div>
 <div class="col-xs-3" >
<div  id="circle4">
<button class="btn btn-primary" id="kadi">KADI</button>
</div>
</div>
 <div class="col-xs-3" >
    <div id="circle5">
<button class="btn btn-primary" id="play_end">PLAY</button>
</div>
</div>
</div>

</div>


</div>

<div class="card-stack" style="margin:0 auto; bottom:0; border-top:1px solid black;border-bottom:1px solid black; display:flex; align-items:flex-end; color:white; overflow-x:auto; width:100%; max-width:100vw; white-space:nowrap;">


<div class="holdin-p" id="h0" style="height:300px;width:200px;">        

</div>
    
    </div>

<div class="card_warning">
  

  </div>
  
 <div id="prev-play" style="margin:0 auto; bottom:0; display:flex; align-items:flex-end; color:white; overflow-x:auto; width:100%; max-width:100vw; white-space:nowrap;">
  <div style="width:50px;height:100px; flex-shrink:0;" id="card_placeholder"></div>
  <!-- Add more cards here -->
</div>
    
</div>

    






</div>
<div class="tutorial-overlay" id="overlay"></div>
<div class="tutorial-text" id="tutorial-text"></div>

    <audio id="cardClickSound" src="sounds/snap2.wav" preload="auto"></audio>
    <audio id="areaClickSound" src="sounds/snap3.wav" preload="auto"></audio>
    <audio id="pickCardSound" src="sounds/snap3.wav" preload="auto"></audio>
    <audio id="submitCardSound" src="sounds/submit.wav" preload="auto"></audio>

<div id="card_request_modal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
        <div class="modal-dialog modal_table">
            <div class="modal-content modal_cell">
                <div class="modal-content">
                    <div class="container">
                        <div class="row">
                            <div class="col-sm-6 col-sm-offset-3">
                                <div class="modal-header">
                                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true"><i class="fa fa-times"></i></button>
                                    <h3 id="myModalLabel"><i class="fa fa-user"></i> &nbsp; Select the card you want.</h3>
                                </div>
                                <div class="modal-body">
                                    <div class="row">
                                        <div class="col-md-3">
                                    <button class="select-card" id="hearts" style="text-align: left;color:white;height:150px;width:100px;"></button>
        

                                        </div>
                                        <div class="col-md-3">
        <button class="select-card" id="diamonds" style="text-align: left;color:white;height:150px;width:100px;"></button>                                    

                                        </div>
                                        <div class="col-md-3">
                                            
<button class="select-card" id="flowers" style="text-align: left;color:white;height:150px;width:100px;"></button>
                                        </div>
                                        <div class="col-md-3">
                                            <button class="select-card" id="spades" style="text-align: left;color:white;height:150px;width:100px;"></button>

                                        </div>

                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <div class="form-group">
                                        <div class="col-sm-4 text-left">
                                            <button type="button" data-dismiss="modal" class="btn btn-default"><i class="fa fa-times"></i> Close</button>
                                        </div>
                                        <div class="col-sm-8">
                                            
                                            
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>


<div id="game_end_modal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
        <div class="modal-dialog modal_table">
            <div class="modal-content modal_cell">
                <div class="modal-content">
                    <div class="container">
                        <div class="row">
                            <div class="col-sm-6 col-sm-offset-3">
                                <div class="modal-header">
                                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true"><i class="fa fa-times"></i></button>
                                    <h3 id="myModalLabel"><i class="fa fa-user"></i> &nbsp; The game has ended.</h3>
                                </div>
                                <div class="modal-body">
                                    <div class="row">
                                 <p id="game_winner" style="text-align:center"></p>
                                 
                                 <div class="col-md-12" style="text-align:center"><button id="play_again" class="btn btn-large btn-success">Play Again</button></div>
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <div class="form-group">
                                        <div class="col-sm-4 text-left">
                                            <a class="btn btn-info btn-block " href=""> Go Home</a>
                                        </div>
                                        <div class="col-sm-8">
                                            
                                            
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>


<div id="mpesa_payment_modal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
        <div class="modal-dialog modal_table">
            <div class="modal-content modal_cell">
                <div class="modal-content">
                    <div class="container">
                        <div class="row">
                            <div class="col-sm-6 col-sm-offset-3">
                                <div class="modal-header" style="color:white;background:#2c3e50">
                                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true"><i class="fa fa-times"></i></button>
                                    <h3 id="myModalLabel"><i class="fa fa-user"></i> &nbsp; Support Kadi .</h3>
                                </div>
                                <div class="modal-body">
                                    <div class="row">
                                        <div class="col-md-12">
                                                <p style="text-align:center">Help us maintain kadi by supporting us with Ksh 10. Enter your phone number below and click the mpesa prompt button to get a prompt</p>
                                 <div class="form-group">
                                    <label class="control-label col-sm-4 hidden-xs">Phone Number</label>
                                    <div class="col-sm-8">
                                       <input type="text" name="phone" id="phone_no" class="form-control" placeholder="e.g 0700123456"></input>
                                    </div>
                                </div>
                                <hr>
                                
                               
                                <div class="statusHolder">
                                    <p class="statusText"></p>
                                </div>
                                <div class="form-group">
                                    <div class="col-md-12 ">
                                        <a id="mpesa_prompt" class="btn btn-danger btn-lg"><i class="fa fa-arrow-left"></i> &nbsp;MPESA PROMPT</a>
                                    </div>
                                   
                                </div>
                            </form>
                                        </div>
                                        
                                        
                                        

                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <div class="form-group">
                                        <div class="col-sm-4 text-left">
                                            <button type="button" data-dismiss="modal" class="btn btn-default"><i class="fa fa-times"></i> Close</button>
                                        </div>
                                        <div class="col-sm-8">
                                            
                                            
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div id="fb-root"></div>
    <script async defer crossorigin="anonymous" 
        src="https://connect.facebook.net/en_US/sdk.js"></script>

    <!-- Include Firebase UMD CDN -->
    <script src="https://www.gstatic.com/firebasejs/10.10.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.10.0/firebase-firestore-compat.js"></script> 
    <script src="https://www.gstatic.com/firebasejs/10.10.0/firebase-database-compat.js"></script>

    <script>
        // Your Firebase Config
        const firebaseConfig = {
  apiKey: "AIzaSyAG3Ol3VvK21To_31q75C6XxmoFIDLhkQY",
  authDomain: "kadi-a1d99.firebaseapp.com",
  databaseURL: "https://kadi-a1d99-default-rtdb.firebaseio.com",
  projectId: "kadi-a1d99",
  storageBucket: "kadi-a1d99.firebasestorage.app",
  messagingSenderId: "1073311326790",
  appId: "1:1073311326790:web:26692c92794a389757a047",
  measurementId: "G-3QGPPYBHV7"
};

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);

        // Firestore Reference
       

        console.log("Firebase Initialized");
    </script>
    <script>
        window.fbAsyncInit = function() {
            FB.init({
                appId      : 'YOUR_APP_ID', // Replace with your Facebook App ID
                cookie     : true,
                xfbml      : true,
                version    : 'v12.0'
            });
        };
    </script>
<script type="text/javascript">
       $(document).ready(function() {
       var steps = ['circle1','h3','circle1','circle5', 'circle2', 'circle3', 'circle4','fin','end'];
var tutorial_count = 0;
tutorial2(tutorial_count);
$('#tutorial_next').on('click',function(){
    
    $('#tutorial_prev').show();
    tutorial_count += 1;
  tutorial2(tutorial_count);  
    
})
$('#tutorial_prev').on('click',function(){
    if(tutorial_count >0){
    tutorial_count -= 1;
    }
  tutorial2(tutorial_count);  
    
})
$('#tutorial_skip').on('click',function(){
    tutorial_count = 8;
  tutorial2(tutorial_count);  
    
})
function tutorial1(){

}

function tutorial2(start) {
    $('#tutorial_skip').show();
    $('#tutorial_next').show();
     $('.tutorial-overlay').show();
     $('.tutorial-text').show();
    

    if (start <= steps.length - 1) {
      showTutorial(steps[start], start);
        /*  setTimeout(function() {
            showTutorial(steps[start], start);
            tutorial2(start + 1);
            console.log(start + 1);
        }, 5000);*/
    } 
   
}

function showTutorial(part, start) {
      var text_steps = ["<h3>This is the playing area. Here you will drop your card.</h3>","<h3>To make a move on playing click on a card </h3>" ,"<h3>Then click on the playing area to move it to the playing area</h3>","<h3>Then click PLAY button to submit your move.</h3>" ,"<h3>Use the 'PICK' button to draw/pick a new card.</h3>" ,"<h3>Use 'UNDO' to undo your last move. as long as you have not picked</h3>" ,"<h3>Click 'KADI' when on your next play you're ready to finish the game.</h3>","<h3>To arrange your cards click on the card you wantto move and the card where you want to move it to.<br>When you or the other player has no cards after a play either of you cannot finish as someone will cardless.<br>Happy playing</h3>" 
        ];
    if(part=='h3' || part=='h2'){
           $('.circle').attr('class', ''); 
      $('.playing-card').attr('class', 'playing-card').css('z-index',''); 
      var x = 'card_3';
      $('#h3').css('z-index','');
       $('#circle1').css('z-index','');
       $('.circle2').attr('class', x +' card').css('z-index','');
        $('.tutorial-text').html(text_steps[start]);
         $('.circle').attr('class', '');
    var a =  $('#' + part);
    a.css('z-index','1000');
    a.find('.card').attr('class','holdin-p circle2').css('z-index','1000');  
    }
    else if(part=='circle1'){
           $('.circle').attr('class', ''); 
      $('.playing-card').attr('class', 'playing-card').css('z-index',''); 
      var x = 'card_3';
      $('#h3').css('z-index','');
       $('#circle1').css('z-index','');
       $('.circle2').attr('class', x +' card').css('z-index','');
       
   $('.tutorial-text').html(text_steps[start]);
      var a =  $('#' + part);
    a.css('z-index','1000');
    a.find('.card').attr('class','playing-card circle2').css('z-index','1000'); 
    }
    else if(part=='fin'){
           $('.circle').attr('class', ''); 
      $('.playing-card').attr('class', 'playing-card').css('z-index',''); 
      var x = 'card_3';
      $('#h3').css('z-index','');
       $('#circle1').css('z-index','');
       $('.circle2').attr('class', x +' card').css('z-index','');
    $('.tutorial-text').html(text_steps[start]);
    }
    else if(part=='end'){
        
           $('.circle').attr('class', ''); 
      $('.playing-card').attr('class', 'playing-card').css('z-index',''); 
      var x = 'card_3';
      $('#h3').css('z-index','');
       $('#circle1').css('z-index','');
       $('.circle2').attr('class', x +' card').css('z-index','');
   $('#overlay').remove();
     $('#tutorial-text').remove();
      $('#tutorial_skip').hide();
    $('#tutorial_next').hide();
     $('#tutorial_prev').hide();
    }
    else{
           $('.circle').attr('class', ''); 
      $('.playing-card').attr('class', 'playing-card').css('z-index','900'); 
      var x = 'card_3';
      $('#h3').css('z-index','');
       $('#circle1').css('z-index','');
       $('.circle2').attr('class', x +' card').css('z-index','');
        $('.tutorial-text').html(text_steps[start]);
        $('.circle').attr('class', '');
    $('#' + part).attr('class', 'circle');
    
}
}


})




</script>


<script type="text/javascript">
    $(document).ready(function() {
const cardClickSound = document.getElementById('cardClickSound');
        const areaClickSound = document.getElementById('areaClickSound');
        const pickCardSound = document.getElementById('pickCardSound');
        const submitCardSound = document.getElementById('submitCardSound');
      /*  const alertCardSound = document.getElementById('alertCardSound');*/
    let dragging = null; 
    let originalIndex; 
    let cardPositions = [];
let my_play=[];
let plays =[];
let start_play = false;
let my_cards = [];
let play_type ='';
let card_picked =false;
let play_type_array =[''];
let to_pick ='';
let card_request = false;
let card_requested ='';
let cardless =false;
let kadi =false;
let user = "";
let duel_id = "";
let current_player = "";
let play_state = "";
let begin_card_index;
let prev_play=[];
let player_fined = false;
let number_of_plays = 1;
let p_status = "";
let my_fine = 0;
let picked_fine = false;
let p_allowed =true;
let allow_change = false;
let timeout ='true';

localStorage.clear();
kadiSetup();
kadi_play_setup();

if( p_status == 'playing'){


//check_play2(duel_id);
/*start_play =true;*/
}
else{

start_playing();
check_play(duel_id);
}

function start_playing(){
//console.log(current_player);
if(start_play == false  && play_state =='starting' && user == current_player ){

var start_cards =shuffleArray([30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53]);
/*var start_cards =shuffleArray([50,51,52,53]);*/

var stl =start_cards.length;
begin_card_index =start_cards[stl -1];
var begin_card ='card_'+ begin_card_index;
var last_play =begin_card_index;

 prev_play =[begin_card_index];
$('.playing-card').fadeOut(1000, function() {
    $(this).attr('id', begin_card);  
    $(this).slideDown(1000);
});
plays.push(begin_card_index);
start_cards.pop();

ready_cards =shuffleArray(start_cards.concat([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29]));
/*ready_cards =shuffleArray([30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53]);*/
start_play = true; 


for(i=0; i<=3;i++){

my_cards.push(ready_cards[i]);
if(i==0){

$('<div class="card_'+i+' card" id ="card_'+ready_cards[i]+'"style="text-align: left;color:white;height:300px;width:200px;">card '+1+'</div>').appendTo('#h'+i);
ready_cards.shift();
    }
else{
    var no_cards = ($('.cards').length)-1;
    var new_card = i;
    var marg =  i+'00px';
    var holder = i -1;


$('#h'+holder).after('<div class="holdin-p" id="h'+new_card+'" style="height:300px;width:200px;"><div class="card_'+new_card+' card" id ="card_'+ready_cards[i]+'"style="text-align: left;color:white;height:300px;width:200px;left: -'+marg+';"></div></div>');
ready_cards.shift();


}

}


start_game(duel_id,begin_card_index,ready_cards);

}


else{
// console.log(start_play);
// console.log( play_state);
if(start_play == false  && play_state =='starting_others'){
start_play = true;
var begin_card ='card_'+ begin_card_index
$('.playing-card').fadeOut(1000, function() {
    $(this).attr('id', begin_card);  
    $(this).slideDown(1000);
});
plays.push(begin_card_index);


for(i=0; i<=3;i++){

my_cards.push(ready_cards[i]);
if(i==0){
$('<div class="card_'+i+' card" id ="card_'+ready_cards[i]+'"style="text-align: left;color:white;height:300px;width:200px;">card '+1+'</div>').appendTo('#h'+i);
ready_cards.shift();
    }
else{
    no_cards = ($('.cards').length)-1;
    new_card = i;
    var marg =  i+'00px';
    var holder = i -1;
$('#h'+holder).after('<div class="holdin-p" id="h'+new_card+'" style="height:300px;width:200px;"><div class="card_'+new_card+' card" id ="card_'+ready_cards[i]+'"style="text-align: left;color:white;height:300px;width:200px;left: -'+marg+';"></div></div>');
ready_cards.shift();
}






}

start_game(duel_id,begin_card_index,ready_cards);

}
}

}


function shuffleArray(array) {
    for (var i = array.length - 1; i > 0; i--) {
        var j = Math.floor(Math.random() * (i + 1));
        var temp = array[i];
        array[i] = array[j];
        array[j] = temp;
    }
    return array;
}

function start_game(duel_id,begin_card_index,ready_cards){


    var player_cards=[];
$('.card').each(function() {
    var a = $(this).attr('id');
    var b = a.split('_');
    player_cards.push(b[1]);
   });
const kadiPlays = JSON.parse(localStorage.getItem('kadi_plays')) || [];

const reg2 = JSON.parse(localStorage.getItem('registrationData2')) || [];
const duelData = JSON.parse(localStorage.getItem('duel')) || [];
   // console.log((kadiPlays).duel_id);
    //learn how to go over objects more so if the key is empty ""
    const duel = kadiPlays;
  prev_play =[begin_card_index];
  const lastPlay = JSON.stringify([{
        player: 'start',
        player_fined: 0,
        play_allowed: true,
        to_fine: 'none',
        card_request: false,
        card_requested: '',
        game_end: false,
        kadi: false,
        cardless: false,
        play: [begin_card_index]
    }]);

    // Check if the current player is the one who should start
    if (duel.playing === user) {
        const updatedDuel = {
            ...duel,
            my_cards: JSON.stringify(my_cards),
            last_play: lastPlay,
            players: duel.players, // Keep player logic as it is
            play_status: duel.play_status,
            players_ready: duel.players_ready + 1
        };

    // const updatedKadiPlays = kadiPlays.map(play => play.duel_id === duelId ? updatedDuel : play);
        localStorage.setItem('kadi_plays', JSON.stringify(updatedDuel));
 if(duelData.play_type === 'single_player'){
 const updatedReg2 = {
            ...reg2,
            my_cards: JSON.stringify(my_cards),
            
}
       localStorage.setItem('registrationData2', JSON.stringify(updatedReg2));
aiStart(duel.ready_cards);
}
 }
check_play2(duel_id);

   /*  $.ajax({
                 method:'post',
                 url: '<?php echo base_url(); ?>challenge/kadi_start',
                
                 data:data_to_send,
                 dataType: "JSON",
                 success: function(msg) {
                     prev_play =[begin_card_index];
check_play2(duel_id);


                 }
             });*/




}


function check_play(duel_id){
const kadiPlays = JSON.parse(localStorage.getItem('kadi_plays')) || [];
   // console.log((kadiPlays).duel_id);
    //learn how to go over objects more so if the key is empty ""
    const duel = kadiPlays;

var x = setInterval(function() {


   /*  $.ajax({
                 method:'post',
                 url: '<?php echo base_url(); ?>challenge/kadi_check_start',
                
                 data:data_to_send,
                 dataType: "JSON",
                 success: function(msg) {
                 current_player = msg.playing;
                 play_state = msg.play_status;
                 begin_card_index =msg.start_card;
                 ready_cards = msg.ready_cards;
                 prev_play =[begin_card_index];
              
                
    if(play_state == 'playing'){
  start_play = true
check_play2(duel_id);  
    }
    else if(play_state == 'starting_others'){
        console.log(play_state);
 start_playing();
    }


                 }
             });*/

 if(start_play == true){
    p_status = "playing";
check_play2(duel_id);
    clearInterval(x);
}
},1000);
if(start_play == true){
 
    clearInterval(x);
}
}


    function kadiCheckPlay(duel_id) {
    const kadiPlays = JSON.parse(localStorage.getItem('kadi_plays')) || [];
    //console.log((kadiPlays).duel_id);
    //learn how to go over objects more so if the key is empty ""
    const duel = kadiPlays;
    //const play_history = kadiPlays[duel_id].last_play;
    
    if (!duel) {
        console.error('No duel found');
        return;
    }
 const kpp = JSON.parse(localStorage.getItem('kadi_plays')) || {};
//console.log(kpp.last_play)
const kppo = kpp.last_play;


let last_play = kppo || []




let lpl = last_play.length;

    const lastPlay =Array.isArray(last_play)? last_play: JSON.parse(last_play);
    const cardless = duel.cardless_status;
    const kadi = duel.kadi_status;
    const playsNo = (lastPlay).length;
    
    let playableCard = lastPlay[0]?.play || null;
    let currentPlayerId = duel.playing;
    let currentPlayerName = '';//(currentPlayerId === userId) ? 'You' : getFullnameByID(currentPlayerId); // Placeholder function to get player name
    let playerIcon = currentPlayerName.charAt(0).toUpperCase();
    let gameEnd = lastPlay[playsNo -1].game_end;

    // Determine the timeout status
   // const timeoutT = localStorage.getItem('timeout'); // Assuming timeout is also stored
   // const timeout = (Date.now() < timeoutT) ? 'true' : 'false';
console.log();
    if (playsNo >= 2) {
        for (let i = playsNo - 1; i > 0; i--) {
            const play =lastPlay[i].play;
            if (play[play.length - 1] !== 'picked_card' && lastPlay[i].player_fined !== 1) {
                playableCard = play[play.length - 1];
                break;
            }
        }
    }

    const data = {
        play_status: duel.play_status,
        playing: duel.playing,
        card_request: lastPlay[playsNo - 1]?.card_request,
        card_requested: lastPlay[playsNo - 1]?.card_requested,
        plays: lastPlay[playsNo - 1]?.play,
        ready_cards: duel.ready_cards,
        player_fined: lastPlay[playsNo - 1]?.player_fined,
        to_fine: lastPlay[playsNo - 1]?.to_fine,
        plays_num: playsNo,
        playable_card: playableCard,
        normal_play: '', // Add logic if needed
        cardless: cardless,
        kadi: kadi,
        game_end: gameEnd,
        current_player_icon: playerIcon,
        current_player_name: currentPlayerName,
        //game_winner: gameEnd ? getFullnameByID(lastPlay[playsNo - 1]?.player) : '',
        //timeout: timeout
    };

    return (JSON.stringify(data)); // Use this data as needed
}


function check_play2(duel_id){

setInterval(function() {
    
                 const msg =JSON.parse(kadiCheckPlay(duel_id));
                 
                 play_state = msg.play_status;
                 player_fined =msg.player_fined;
                 ready_cards = JSON.parse(msg.ready_cards);
                 to_pick = msg.to_fine;
                 timeout = msg.timeout;
               if(msg.game_end=='true' || msg.game_end==true){
                let rank_info = await getPlayerRank();
    $('#game_end_modal').modal('show');
    $('#game_winner').text('The winner is '+ msg.game_winner + '<br>' + rank_info);


                   
                   
                   
                 $('#winner_icon').text(msg.game_winner_icon);
      $('#winner_text').text(msg.game_winner + ' has won. ');

/* $( "#notifywin" ).toggle( "slide" );*/

               }
                else{
              /*   if((number_of_plays < msg.plays_num || msg.plays_num == 1) && play_state=='playing' && (current_player != user || allow_change == true)){*/
                if( (current_player != user || allow_change == true)){

                    card_request =msg.card_request;
                card_requested =msg.card_requested;
                      if(number_of_plays < msg.plays_num || allow_change == true ){
                        if(!(msg.plays).includes('picked_card') ){
                         prev_play =msg.plays;
                         setplay(); 
                     }

else{
                        prev_play=[msg.playable_card];
    showCustomAlert('Player two picked');

    
                     }
                       

                          
                 number_of_plays =msg.plays_num;
             }/*Add only if there is new play else this will not run as  number of plays will continously add*/
                 picked_fine =false;
                 card_picked =false;
                 /*cardless = msg.cardless;
                 kadi =msg.kadi;*/
                 card_picked =false;
                 picked_fine =false;
                 
                 current_player = msg.playing;
                /*   if(msg.plays_num >1){
                    number_of_plays +=1;
                   }*/
                   

                   if(current_player == user){
 $('#winner_text').text(msg.current_player_name + 'r turn to play');
 /*$( "#notifywin" ).toggle( "slide" );*/
                    if(to_pick ==user){
                          $('#winner_text').text(msg.current_player_name + ' have been asked to pick '+msg.player_fined+' card/s');
 /*$( "#notifywin" ).toggle( "slide" );*/
                        my_fine = msg.player_fined;
                    }
                   }
                   else{


      $('#winner_text').text(msg.current_player_name + ' is currently playing');
/* $( "#notifywin" ).toggle( "slide" );*/
                   }
                 
                   if(card_request == true){
                    var t  = $('#winner_text').text();   
                    $('#winner_text').text(t+ '. '+ card_requested+ ' card has been requested');
                   }
                   if(cardless == true){
                    var t  = $('#winner_text').text();
                    showCustomAlert('There is a cardless player');
                   }
                   if(kadi == true){
                       var t  = $('#winner_text').text();
                    showCustomAlert('There is a player who is kadi');
                   }
                   
                 }


}
allow_change = false;


            
 
},1000);
}
$('.select-card').click(function(){
    card_requested =$(this).attr('id');
    $('#card_request_modal').modal('hide');
    alert('You have requested '+card_requested);
})

async function getTopPlayers() {
    try {
        const leaderboard = await FBInstant.getLeaderboardAsync('kadi_ranking');
        const entries = await leaderboard.getEntriesAsync(10, 0);

        console.log("Top Players:");
        entries.forEach(entry => {
            console.log(`${entry.getRank()}. ${entry.getPlayer().getName()} - ${entry.getScore()} points`);
        });

        return entries; // Return data to display in UI
    } catch (error) {
        console.error("Error fetching leaderboard:", error);
    }
}
async function getPlayerRank() {
    try {
        const leaderboard = await FBInstant.getLeaderboardAsync('kadi_ranking');
        const playerEntry = await leaderboard.getPlayerEntryAsync();

        if (playerEntry) {
            console.log(`Your Rank: ${playerEntry.getRank()} | Score: ${playerEntry.getScore()}`);
            return `Your Rank: ${playerEntry.getRank()} | Score: ${playerEntry.getScore()}`;
            //return ${playerEntry.getScore()};
        } else {
            console.log("You are not ranked yet.");
        }
    } catch (error) {
        console.error("Error fetching player rank:", error);
    }
}


async function updateLeaderboard(playerID, score) {
    try {
        // Ensure the leaderboard exists
        
        const leaderboard = await FBInstant.getLeaderboardAsync('kadi_ranking');
        const player_score = await getPlayerRank();
        let total_score = parseInt(score) + parseInt(player_score);
        total_score = total_score >= 0 ?total_score : 0;
        // Submit the player's score (higher scores = higher rank)
        await leaderboard.setScoreAsync(total_score);
        console.log("Leaderboard updated! Score:", score);
    } catch (error) {
        console.error("Error updating leaderboard:", error);
    }
}









   function showCustomAlert(text) {
        var alertBox = document.getElementById("custom-alert");
        $("#custom-alert").text(text);
        alertBox.style.display = "block";

       
        setTimeout(function() {
            alertBox.style.display = "none";
        }, 5000); 
    }



function setplay(){

    if(prev_play[0] !='picked_card'){
$.each(prev_play,function(index,value){

var current_card ='card_'+ value;
$('.playing-card').fadeOut(1000, function() {
    $(this).attr('id', current_card);  
    $(this).slideDown(1000);
});

$('#card_placeholder').after('<div style="width:50px;height:100px;flex-shrink:0;" id="card_'+ value+'"></div>');
});
}
else if(prev_play[0] =='picked_card'){
    $('#card_placeholder').after('<div style="width:50px;height:100px;flex-shrink:0;" id="card_pick"></div>');
    
    
}
/*
if(player_fined =='none' ||player_fined.length==0)
    {

    }
    else{


    }*/
    /*if(player_fined == true)
    {

$.each(prev_play,function(index,value){

var current_card ='card_'+ value;
$('.playing-card').attr('id',current_card);

});

alert('player fined');
var pl = plays.length;
if(plays[pl-1] !='picked_card'){
$('.playing-card').attr('id','card_'+plays[pl-1]);
}
player_fined = false;

    }
        else{

$.each(prev_play,function(index,value){

var current_card ='card_'+ value;
if(plays[pl-1] !='picked_card'){
$('.playing-card').attr('id',current_card);
plays.push(parseInt(value));
}
}); 
        }
*/





if(start_play == true){
    clearInterval(this);
}

}




    $('.holdin-p').each(function() {
    
        cardPositions.push($(this).position().left);
    });

    $('body').on('click','.card', function(e) {
       cardClickSound.play(); 
  if(dragging == null){
    todrag =$(this);
   
    todragB = $(this).css('background-color');
    todragI = $(this).attr('id');
 
    dragging = true;
  }
  else if(dragging == true){
    var a = $(this);
    
    var b = $(this).css('background-color');
    var c = $(this).attr('id');

    $(todrag).css('background-color',b);
    $(todrag).attr('id',c);

$(a).attr('id',todragI);
$(a).css('background-color',todragB);

todragB = null;
todragI = null;
todrag = null;
dragging = null;
  }

  });





    $('.playing-card').on('click', function(e) {
/*if(current_player == user && start_play == true){
*/    
areaClickSound.play();
var pcd  =todragI.split('_');


        if(card_picked ==false){
  if(dragging == null){
    
  }
  else if(dragging == true){
var ptal = play_type_array.length;
    if(to_pick == user && ([12,13,14,15,16,17,18,19,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53]).includes(parseInt(pcd[1])) ){

        alert('This play is not allowed');
    }

   
    else{
    
        if(to_pick == user  ){
var pvl = prev_play.length;
if(parseInt(pcd[1])== 20 && ([20,21,22,23,24,29,28,0,1,2,3].includes(parseInt(prev_play[pvl-1])==false))  ){
    p_allowed = false;
}
else if(parseInt(pcd[1])== 21 && ([20,21,22,23,25,29,28,0,1,2,3].includes(parseInt(prev_play[pvl-1])==false))  ){
    p_allowed = false;
}
else if(parseInt(pcd[1])== 22 && ([20,21,22,23,26,29,28,0,1,2,3].includes(parseInt(prev_play[pvl-1])==false))  ){
    p_allowed = false;
}
else if(parseInt(pcd[1])== 23 && ([20,21,22,23,27,29,28,0,1,2,3].includes(parseInt(prev_play[pvl-1])==false))  ){
    p_allowed = false;
}
else if(parseInt(pcd[1])== 24 && ([20,24,25,26,27,29,0,1,2,3].includes(parseInt(prev_play[pvl-1])==false))  ){
    p_allowed = false;
}
else if(parseInt(pcd[1])== 25 && ([21,24,25,26,27,29,28,0,1,2,3].includes(parseInt(prev_play[pvl-1])==false))  ){
    p_allowed = false;
}
else if(parseInt(pcd[1])== 26 && ([22,24,25,26,27,29,28,0,1,2,3].includes(parseInt(prev_play[pvl-1])==false))  ){
    p_allowed = false;
}
else if(parseInt(pcd[1])== 27 && ([23,24,25,26,27,29,28,0,1,2,3].includes(parseInt(prev_play[pvl-1])==false))  ){
    p_allowed = false;
}
else if((parseInt(pcd[1])== 28 || parseInt(pcd[1])== 29 )&& ([20,21,22,23,24,25,26,27,28,0,1,2,3].includes(parseInt(prev_play[pvl-1])==false))  ){
    p_allowed = false;
}       
        }
       
if([0,1,2,3].includes(parseInt(pcd[1]))  && to_pick !=user && my_fine ==0){

    $('#card_request_modal').modal('show');
    card_request = 'hearts';
    card_request = true;
}
if(to_pick == user && [0,1,2,3].includes(parseInt(pcd[1]))){
    my_fine =0;
}
        /*else if(play_type_array[ptal -1] == 'fine' && ([20,21,22,23,24,25,26,27]).includes(parseInt(pcd[1])) ){
        play_type_array.push('fine_added'); 
        }
        else if(([12,13,14,15,16,17,18,19]).includes(parseInt(pcd[1])) ){
        play_type_array.push('question');
        }
        else if( ([4,5,6,7]).includes(parseInt(pcd[1])) ){
        play_type_array.push('kickback');
        
        }
        else if( ([8,9,10,11]).includes(parseInt(pcd[1])) ){
        play_type_array.push('jump');
        }*/
if(p_allowed == false){
    alert('You are not allowed to play this way');
}
if(p_allowed == true){
    var current_card =0;
    var no_cards =0;
$('.card').each(function() {
    no_cards += 1;
    if($(this).attr('id') == todragI){
        current_card = no_cards;
    }
    
    });
if(current_card != no_cards ){
    
for (var i = current_card-1; i <= no_cards; i++) {
    var x = i+1;
   var d =  $('.card_'+x).css('background');
  var e  =  $('.card_'+x).attr('id');
 
   $('.card_'+i).attr('id',e);
   if(i ==no_cards-1){
   var tr = $('.card_'+i).parent();
    $('.card_'+i).parent().remove();
     $('.card_'+i).remove();

     tr.remove();
   }
}

}

else if(current_card == no_cards && no_cards == 1){
 
$('.card_'+(current_card-1)).remove();
}

else if(current_card == no_cards && no_cards >1){
 $('.card_'+(current_card-1)).parent().remove();
$('.card_'+(current_card-1)).remove();
}

$(this).attr('id',todragI);
$(this).css('background-color',todragB);

my_play.push(pcd[1]);
plays.push(pcd[1]);

todragB = null;
todragI = null;
todrag = null;
dragging = null;
play_type ='normal';
/*console.log(my_play);*/
  }

}
}
}
else{
/*console.log(card_picked);*/
alert('You have picked a card');

}
/*}
else{
    alert('Not your turn yet')
}
*/


  });






$('#pick_c').click(function(){


pickCardSound.play();
if(current_player == user){


var questions =[12,13,14,15,16,17,18,19];
var ptal = play_type_array.length;
var ml = my_play.length;
 
console.log(

    ( my_play.length==0 || (card_picked==false && ml>0 && questions.includes(parseInt(my_play[ml-1]))
    ) || (to_pick ==user && my_fine >0) )
     && picked_fine == false);





    if( ( my_play.length==0 || (card_picked==false && ml>0 && questions.includes(parseInt(my_play[ml-1]))) || (to_pick ==user && my_fine >0) ) && picked_fine == false ){

    var no_cards =0;
var shuffled_rc =shuffleArray(ready_cards);
var picked_card = shuffled_rc[0];

$('.card').each(function() {
    no_cards += 1;
   });
    if(no_cards == 0){

$('<div class="card_'+0+' card" id ="card_'+picked_card+'"style="text-align: left;color:white;height:300px;width:200px;"></div>').appendTo('#h'+0);

    }
    else{
var new_card =no_cards ;
marg =  no_cards+'00px';
$('#h'+(no_cards-1)).after('<div class="holdin-p" id="h'+new_card+'" style="height:300px;width:200px;"><div class="card_'+new_card+' card" id ="card_'+picked_card+'"style="text-align: left;color:white;height:300px;width:200px;left: -'+marg+'">card </div></div>');
}
if(to_pick == user){
    my_fine  = my_fine-1;
}

shuffled_rc.shift();
console.log(shuffled_rc);
ready_cards = shuffled_rc;
card_picked = true;

if(!questions.includes(parseInt(my_play[ml-1]))){
my_play.push('picked_card');
}
else{
    card_picked = true;
}

play_type = 'normal_pick';

play_type_array.push('picked_card');
    






}
else{
    alert('You have picked a card');
}


}
else{
    alert('Not your turn yet');
}



});


$('#undo').click(function(){

/*if(current_player == user){*/


    if(my_play.length > 0){
if(card_picked == false){

        var l = my_play.length;
    var ucard =my_play[l-1];
my_play.pop();
    var no_cards =0;
$('.card').each(function() {
    no_cards += 1;
   });
    if(no_cards == 0){
$('<div class="card_'+0+' card" id ="card_'+ucard+'"style="text-align: left;color:white;height:300px;width:200px;"></div>').appendTo('#h'+0);

    }
else{
var new_card =no_cards ;
marg =  no_cards+'00px';

$('#h'+(no_cards-1)).after('<div class="holdin-p" id="h'+new_card+'" style="height:300px;width:200px;"><div class="card_'+new_card+' card" id ="card_'+ucard+'"style="text-align: left;color:white;height:300px;width:200px;left: -'+marg+';">card '+ucard+'</div></div>');
}

if(l>1){ 
    $('.playing-card').fadeOut(1000, function() {
    $(this).attr('id', 'card_'+my_play[l-2]);  
    $(this).slideDown(1000);
});


}
else{
   var lp =  prev_play.length;

    $('.playing-card').fadeOut(1000, function() {
    $(this).attr('id', 'card_'+prev_play[lp-1]);  
    $(this).slideDown(1000);
});
}
plays.pop();
play_type ='';
play_type_array.pop();



}
else{
    alert('You have already picked a card');

}

}
else{
    alert('You have not played');
}
/*}
else{

    alert('Not your turn yet');
}*/


});
$('#kadi').click(function(){
if(current_player == user){

kadi = true;
}
else{
    alert('Not your turn yet');
}

});


    $('#play_end').click(function() {
    submitCardSound.play();
    if (current_player == user) {
        var submit_play = true;
        var ml = my_play.length;
        var questions = [12, 13, 14, 15, 16, 17, 18, 19];
        var ace = [0, 1, 2, 3];

        if (ml == 0 && card_picked == false) {
            alert('You need to play first');
        } else {
            if (card_picked == false && questions.includes(parseInt(my_play[ml - 1]))) {
                alert('You need to pick a card then press play');
                submit_play = false;
            }
            if (to_pick == user && my_fine > 0) {
                if (my_play[ml - 1] == 'picked_card') {
                    alert('You haven\'t picked all cards');
                    submit_play = false;
                }
            }
            if (submit_play == true) {
                var player_cards = [];

                $('.card').each(function() {
                    var a = $(this).attr('id');
                    var b = a.split('_');
                    player_cards.push(b[1]);
                });

                if (player_cards.length == 0) {
                    cardless = true;
                }

                var lply = [];
                if (Array.isArray(prev_play)) {
                    lply = prev_play;
                } else {
                    lply.push(prev_play);
                }

                // Prepare data to send to kadiPlay
                var response = kadiPlay(
                    user,            // player
                    player_cards,    // playerCards
                    cardless,        // cardless
                    kadi,            // kadi
                    my_play,         // playerPlay
                    ready_cards,     // readyCards
                    card_request,    // cardRequest
                    card_requested,   // cardRequested
                    lply             // lastPlay
                );
console.log(response);
            
                // Handle the response
                play_state = JSON.parse(response).play_status; // Assuming kadiPlay returns play_status
                ready_cards = JSON.parse(response).ready_cards; // Assuming kadiPlay returns updated ready_cards
                current_player = JSON.parse(response).next_player; // Assuming kadiPlay returns next_player

                if (JSON.parse(response).game_end == 'true' ||JSON.parse(response).game_end == true) {
                    $('#game_end_modal').modal('show');
                    $('#game_winner').text('The winner is ' + JSON.parse(response).game_winner);
                } else {
                    if (JSON.parse(response).to_fine == 'self') {
                        if (parseInt(JSON.parse(response).fine) == 1 && JSON.parse(response).next_player != user) {
                            alert('hello');
                            var fined_card = JSON.parse(response).fined_card;
                            var lp = prev_play.length;
alert(prev_play)
                            $('.playing-card').fadeOut(1000, function() {
                                $(this).attr('id', 'card_' + prev_play[lp - 1]);
                                $(this).slideDown(1000);
                            });

                            $.each(my_play, function(index, value) {
                                var no_cards = 0;
                                $('.card').each(function() {
                                    no_cards += 1;
                                });

                                if (no_cards == 0) {
                                    $('<div class="card_' + 0 + ' card" id ="card_' + value + '" style="text-align: left;color:white;height:300px;width:200px;"></div>').appendTo('#h' + 0);
                                } else {
                                    var new_card = no_cards;
                                    var marg = no_cards + '00px';
                                    $('#h' + (no_cards - 1)).after('<div class="holdin-p" id="h' + no_cards + '" style="height:300px;width:200px;"><div class="card_' + (no_cards) + ' card" id ="card_' + value + '" style="text-align: left;color:white;height:300px;width:200px;left: -' + marg + ';"></div></div>');
                                }
                                my_play.unshift();
                            });

                            var no_cards = 0;
                            $('.card').each(function() {
                                no_cards += 1;
                            });
                            var new_card = no_cards;
                            var marg = no_cards + '00px';
                            var ucard = fined_card;

                            $('#h' + (no_cards - 1)).after('<div class="holdin-p" id="h' + (no_cards) + '" style="height:300px;width:200px;"><div class="card_' + (no_cards) + ' card" id ="card_' + ucard + '" style="text-align: left;color:white;height:300px;width:200px;left: -' + marg + ';"></div></div>');
                            picked_fine = true; // limit play
                        }
                    } else {
                        prev_play = my_play;
                        if (prev_play[0] != 'picked_card') {
                            $.each(prev_play, function(index, value) {
                                $('#card_placeholder').after('<div style="width:50px;height:100px;flex-shrink:0;" id="card_' + value + '"></div>');
                            });
                        } else if (prev_play[0] == 'picked_card') {
                            $('#card_placeholder').after('<div style="width:50px;height:100px;flex-shrink:0;" id="card_pick"></div>');
                        }
                    }

                    my_play = []; // limit play
                    number_of_plays = parseInt(number_of_plays) + 1;
                    prev_play = [];
                    card_picked = false;
                    kadi = false;
                    console.log(JSON.parse(response).next_player)
if(JSON.parse(response).next_player == 19 || JSON.parse(response).next_player == "19"){
   
aiTurn(JSON.parse(response), duel_id);
}
                    if (JSON.parse(response).play_type == 'single_player') {
                        allow_change = true;
                    }
                }
            }
        }
    }
});
























// Function to setup Kadi game
function kadi_play_setup() {
  // Retrieve duel_id from URL or other source
 
  // Check if game data already exists in localStorage
  let gameData = JSON.parse(localStorage.getItem('kadi_plays')) || {};
let duelData = JSON.parse(localStorage.getItem('duel'));

  // If no data for the current duel, initialize it
  if (gameData.duel_id === undefined) {
  
    
let duelData = JSON.parse(localStorage.getItem('duel'));

    // Assuming these variables are pulled from some initial setup or configuration
    const duelPlayers =[duelData.player_one,duelData.player_two]  //getDuelPlayers(duelId); Replace this with logic to get duel players
    const playType = gameData[play_type]; // Default play type or retrieve from some source
    const allPlayingCards = Array.from({ length: 54 }, (_, i) => i); // Array [0, 1, ..., 53]



    gameData = {
      duel_id:duel_id,
      players: duelPlayers,
      playing: duelPlayers[duelPlayers.length - 1],
      play_direction: 'forward',
      play_status: 'starting',
      kadi_status: [],
      cardless_status: [],
      play_type: playType,
      ready_cards: allPlayingCards,
      play_state: [],
      my_cards: [],
      last_play: null,
      plays: [],
      to_fine: null,
      kadi: null,
      cardless: null,
      number_of_plays: null,
    };

    // Save initial data to localStorage
    localStorage.setItem('kadi_plays', JSON.stringify(gameData));
 //console.log(localStorage);
 p_status = 'starting';
 play_state = 'starting';
 current_player = duelPlayers[duelPlayers.length - 1];
  }
else{
  // Fetch the current game data
  let currentGameData = gameData;

  // Update game state based on current play status
  if (currentGameData.play_status === 'playing') {
    const lastPlay = currentGameData.last_play || [];

    if (lastPlay.length > 1) {
      // Process last play to determine playable card and other status flags
      let playableCard = lastPlay[0].play;
      for (let i = lastPlay.length - 1; i > 0; i--) {
        if (lastPlay[i].play !== 'null' && lastPlay[i].play[lastPlay[i].play.length - 1] !== 'picked_card' && lastPlay[i].playerFined !== 1) {
          playableCard = lastPlay[i].play[lastPlay[i].play.length - 1];
          break;
        }
      }

      plays = playableCard;
      to_pick = lastPlay[lastPlay.length - 1].player === 'start' ? 'none' : lastPlay[lastPlay.length - 1].to_fine;
      kadi = lastPlay[lastPlay.length - 1].player === 'start' ? 'none' : lastPlay[lastPlay.length - 1].kadi;
      cardless = lastPlay[lastPlay.length - 1].player === 'start' ? 'none' : lastPlay[lastPlay.length - 1].cardless;
      number_of_plays = lastPlay.length;
       p_status = 'playing';
 play_state = 'playing';
    }

    // Save updated game state to localStorage
  //  localStorage.setItem('gameData', JSON.stringify(gameData));

  } else if (currentGameData.playStatus === 'starting') {
    // Game is in starting phase; reset relevant fields
    my_cards = [];
    plays = [];
    to_pick = null;
    kadi = null;
    cardless = null;
    numberOfPlays = null;
       p_status = 'starting';
        play_state = 'starting';
    // Save updated starting state to localStorage
    //localStorage.setItem('gameData', JSON.stringify(gameData));
  }else if (currentGameData.playStatus === 'game_ended') {
     // Handle play ended case
    play_status = 'game_ended';
   my_cards = null;
    play_state = null;

   
  }
 
}
  // Render or use data as needed on the frontend
  
}

function kadiSetup() {
    // Get userID from localStorage
    const userID = 1;//localStorage.getItem('userID');

    if (!userID) {
        console.error("User is not authenticated.");
        return;
    }

    // Get player name and play type from the form
    const playType = 'single_player';

   /* const playerName = document.getElementById('player_name').value;
    
    // Update player name via API
    if (playerName && playerName.length > 0) {
        //await updatePlayerName(userID, playerName);
    }*/

    if (playType === 'single_player') {
        const challengeID = 10; // Static challenge ID
        duel_id = generateUniqueId();
        user = userID;
        const data = {
            challenge_id: challengeID,
            players: `19,${userID}`,
            player_one: '19',
            player_one_ready: true,
            player_one_topic: '',
            player_two: userID,
            player_two_ready: true,
            player_two_time: 0,
            start_date: new Date().toISOString(),
            status: 'playing',
            play_type: 'single_player',
            duel_id:duel_id
        };
const registrationData = {
      userID: 19,
      challengeID: challengeID,
      status: 'pending',
      play_amount: 0,
      win_status: 'pending',
      reg_day: new Date().toISOString().replace('T', ' ').split('.')[0],
      duel_id: duel_id
    };
    const registrationData2 = {
      userID: userID,
      challengeID: challengeID,
      status: 'pending',
      play_amount: 0,
      win_status: 'pending',
      reg_day: new Date().toISOString().replace('T', ' ').split('.')[0],
      duel_id: duel_id
    };
        // Create a new duel via API
        createDuel(data);

        // Register challenges for both players
        registerChallenge('registrationData1',registrationData);
        registerChallenge('registrationData2',registrationData2);

        console.log(localStorage);
    } else {
        const challengeID = 11; // Another static challenge ID
/*
        // Check for existing challenges
        const existingChallenge = await getExistingChallenge(challengeID, userID);
        if (existingChallenge) {
            await updateChallenge(existingChallenge, userID);
            await deleteChallengeRegis tration(challengeID, userID);
        }

        const challengeData = await getChallengeData(challengeID);
        const newRegistrationID = await registerChallenge(userID, challengeID, challengeData.amount);

        const serial = generateRandomString(8);
        const challengeLink = `/${serial}/${newRegistrationID}`;

        // Update the challenge registration with the link
        await updateChallengeLink(newRegistrationID, challengeLink);

        console.log(JSON.stringify({ link: `challenge/kadi_waiting_bay/${newRegistrationID}` }));
 */   }
}



function createDuel(data) {
try {


localStorage.setItem('duel', JSON.stringify(data));

} catch (error) {
    console.error("Error adding document: ", error);
  }

}

function generateUniqueId() {
  // Get the current timestamp
  const timestamp = Date.now().toString(36); // Convert timestamp to base-36

  // Generate a random number and convert it to base-36
  const randomNum = Math.random().toString(36).substring(2, 10);

  // Combine timestamp and random number to create a unique ID
  return `${timestamp}-${randomNum}`;
}

// Usage





async function registerChallenge(player, registrationData) {
 try {


localStorage.setItem(player, JSON.stringify(registrationData));;

} catch (error) {
    console.error("Error adding document: ", error);
  }


}







//backend game engine 
function kadiPlay(
  player = null,
  player_cards = null,
  cardless = null,
  kadi = null,
  player_play = null,
  ready_cards = null,
  card_request = null,
  card_requested = null,
  lastPlay = null,
  duelId = null,
) {
console.log(cardless);
let cr = card_request;
let crd = card_requested;

console.log(card_request)
console.log(crd)
let user_id = player; // kadi_ai
let duel_id = localStorage.getItem('duel_id');
let hearts = [0, 4, 8, 12, 16, 20, 24, 30, 34, 38, 42, 46, 50];
let diamonds = [1, 5, 9, 13, 17, 21, 25, 31, 35, 39, 43, 47, 51];
let flowers = [2, 6, 10, 14, 18, 22, 26, 32, 36, 40, 44, 48, 52];
let spades = [3, 7, 11, 15, 19, 23, 27, 33, 37, 41, 45, 49, 53];

let allowed_q_hearts = [16, 30, 34, 38, 42, 46, 50];
let allowed_q_diamonds = [17, 31, 35, 39, 43, 47, 51];
let allowed_q_flowers = [18, 32, 36, 40, 44, 48, 52];
let allowed_q_spades = [19, 33, 37, 41, 45, 49, 53];

let allowed_8_hearts = [12, 30, 34, 38, 42, 46, 50];
let allowed_8_diamonds = [13, 31, 35, 39, 43, 47, 51];
let allowed_8_flowers = [14, 32, 36, 40, 44, 48, 52];
let allowed_8_spades = [15, 33, 37, 41, 45, 49, 53];

let allowed_2_hearts = [24, 28, 29];
let allowed_2_diamonds = [25, 28, 29];
let allowed_2_flowers = [26, 28, 29];
let allowed_2_spades = [27, 28, 29];

let allowed_3_hearts = [20, 28, 29];
let allowed_3_diamonds = [21, 28, 29];
let allowed_3_flowers = [22, 28, 29];
let allowed_3_spades = [23, 28, 29];
let allowed_jk = [20, 21, 22, 23, 24, 25, 26, 27, 28, 29];

// Load 'kadi_plays' data from localStorage and parse players
let q = JSON.parse(localStorage.getItem('kadi_plays') || '{}');
let players = q?.players || [];
let pl = players.length;
let lp = players[pl - 1];
let current_player = players[pl - 1];

players.pop();
players.unshift(lp);






let to_play = players[pl - 1];
let direction = 'forward';
let active_player = '';
let player_ask_card = false;
let action = [];

/*if (!localStorage.getItem('player')) {
    user_id = localStorage.getItem('userID');
    //let card_request = localStorage.getItem('card_requests');
    let player_cards = JSON.parse(localStorage.getItem('player_cards') || '[]');
    let to_pick = localStorage.getItem('to_pick');
    let kadi = localStorage.getItem('kadi');
    let ready_cards = JSON.parse(localStorage.getItem('ready_cards') || '[]');
    let cardless = localStorage.getItem('cardless');
    let player_play = JSON.parse(localStorage.getItem('my_play') || '[]');

    let last_play_data = JSON.parse(localStorage.getItem('kadi_plays') || '{}');
    let last_play = last_play_data.last_play || [];
    let lpl = last_play.length;
    let plays = last_play[lpl - 1]?.play || [];
    let plays_no = last_play.length;
   // let card_requested = last_play[lpl - 1]?.card_requested || '';*/









   const kpp = JSON.parse(localStorage.getItem('kadi_plays')) || {};
const kppo = (kpp.last_play[0]) == '[' ?JSON.parse(kpp.last_play):kpp.last_play;;
let last_play = kppo || [];
let lpl = last_play.length;
    let playable_card = last_play[0]?.play;
let plays_no = last_play.length;
    if (plays_no >= 2) {
        for (let i = lpl - 1; i > 0; i--) {
            let lpla = last_play[i]?.play || [];
            if (lpla[lpla.length - 1] !== 'picked_card' && last_play[i]?.to_fine !== 'self') {
                playable_card = lpla[lpla.length - 1];
                break;
            }
        }
    }
    last_play = playable_card;
    card_request = (kppo[0]) == '['?cr:kppo[plays_no-1].card_request;
 card_requested = (kppo[0]) == '['?crd:kppo[plays_no-1].card_requested;

card_request = (card_request) == null ||card_request== undefined?(kppo[plays_no-1]).card_request:card_request;
console.log(card_request)

console.log(kppo[plays_no-1])
if (player_play[0] === 'picked_card') {


    // Retrieve data
    const duelId = localStorage.getItem('duel_id');
    const oPlays = JSON.parse(localStorage.getItem('last_play')) || [];
    let cardlessStatus = JSON.parse(localStorage.getItem('cardless_status')) || [];
    let kadiStatus = JSON.parse(localStorage.getItem('kadi_status')) || [];
    
    // Prepare new play data
    const playData = {
        player: user_id,
        play: JSON.stringify(player_play),
        player_fined: 'none',
        play_allowed: true,
        to_fine: 'none',
        next_player: to_play,
        card_request: card_request,
        card_requested: card_requested,
        kadi: kadi,
        cardless: cardless
    };

 
    // Define action object
    const action = {
        fine: 'none',
        play_allowed: 'true',
        to_fine: 'none',
        next_player: to_play,
        card_request: card_request,
        card_requested: card_requested,
        last_play_cards: player_cards,
        kadi: kadi,
        cardless: cardless,
        line: 1402
    };

    // Update cardless status
    if (player_cards.length === 0) {
        if (!cardlessStatus.includes(userId)) {
            cardlessStatus.push(userId);
        }
    } else if (cardlessStatus.includes(user_id)) {
        cardlessStatus = cardlessStatus.filter(id => id !== user_id);
        cardlessStatus = cardlessStatus.length ? [cardlessStatus[0]] : [];
    }

    // Update kadi status
    if (action.kadi === 'true' && action.cardless === 'false') {
        if (!kadiStatus.includes(user_id)) {
            kadiStatus.push(userId);
        }
    } else if (kadiStatus.includes(user_id)) {
        kadiStatus = kadiStatus.filter(id => id !== user_id);
        kadiStatus = kadiStatus.length ? [kadiStatus[0]] : [];
    }


let o_plays = JSON.parse(localStorage.getItem('kadi_plays')) || {};

cardless_status =  o_plays.cardless_status || [];
kadi_status = o_plays.kadi_status || '[]';//JSON.parse(o_plays.kadi_status || '[]');

    let o_plays2 =Array.isArray(o_plays.last_play)?o_plays.last_play:JSON.parse( o_plays.last_play);
    let o_plays2L = o_plays2.length;
    
    o_plays2[o_plays2L] = {
        player: user_id,
        play: JSON.stringify(player_play),
        player_fined: action.fine,
        play_allowed: action.play_allowed,
        to_fine: action.to_fine,
        next_player: action.next_player,
        card_request: action.card_request,
        card_requested: action.card_requested,
        game_end: false,
        kadi: action.kadi,
        cardless: action.cardless
    };

   
    // Update LocalStorage
    o_plays.last_play = JSON.stringify(o_plays2);
   
    o_plays.ready_cards = JSON.stringify(ready_cards);
    o_plays.players = players;
    o_plays.playing = action.next_player;
    
    // Save updated states
    o_plays.cardless_status =cardlessStatus;
    o_plays.kadi_status = kadiStatus;
    console.log(o_plays);
    localStorage.setItem('kadi_plays', JSON.stringify(o_plays));
    console.log(player_cards);
       if(user_id == 19 || user_id =='19'){
        console.log((JSON.parse(localStorage.getItem('registrationData1'))).my_cards)
    localStorage.setItem('registrationData1', JSON.stringify({
        ...JSON.parse(localStorage.getItem('registrationData1')),
        my_cards: JSON.stringify(player_cards) // Clear cards for user
    }));}
    else{
        console.log(player_cards);
        localStorage.setItem('registrationData2', JSON.stringify({
        ...JSON.parse(localStorage.getItem('registrationData2')),
        my_cards: JSON.stringify(player_cards) // Clear cards for user
    }));
    }

    // Determine action for AI or next player


    let actionData = { ...action, ready_cards: ready_cards };
    if (action.next_player == '19' || action.next_player == '19') { // AI turn
        alert('weuh');
        actionData.play_type = 'single_player';
        
  return (JSON.stringify(actionData)); 
    } /*else {
        // Output action data
        if (user_id !== 19) {
           
        }
    }*/


}
else{

 //card played not picked

let pll = player_play.length;

for (let k = 0; k < pll; k++) {
  let current_card = parseInt(player_play[k]);
  
  if (k === 0) {
if (card_request === true) {
      let fine = 'none';
      let to_fine = 'none';

      if ([0, 1, 2, 3].includes(current_card)) {
        let play_allowed = true;
        if (k === pll - 1) {
          action = {
            fine: 'none',
            play_allowed: 'true',
            to_fine: 'none',
            next_player: to_play,
            card_requests: cr,
            card_requested: crd,
            last_play_cards: player_cards,
            kadi: kadi,
            cardless: cardless,
            line: 1450,
          };
          break;
        }
      } else if (card_requested === 'hearts') {
        if (hearts.includes(current_card)) {
          let play_allowed = true;
          card_request = false;
          card_requested = '';

          if ([20, 21, 22, 23].includes(current_card)) {
            fine = 2;
            to_fine = to_play;
          } else if ([24, 25, 26, 27].includes(current_card)) {
            fine = 3;
            to_fine = to_play;
          }

          if (k === pll - 1) {
            action = {
              fine: fine,
              play_allowed: 'true',
              to_fine: to_fine,
              next_player: to_play,
              card_requests: card_request,
              card_requested: card_requested,
              last_play_cards: player_cards,
              kadi: kadi,
              cardless: cardless,
              line: 1474,
            };
            break;
          } else {
            let action_b = process_card_request(player_play, players, current_player, to_play);
            action = Object.assign({}, action_b, {
              card_requests: card_request,
              card_requested: card_requested,
              last_play_cards: player_cards,
              kadi: kadi,
              cardless: cardless,
              line: 1486,
            });
            break;
          }
        } else {
          action = {
            fine: '1',
            play_allowed: 'false',
            to_fine: 'self',
            next_player: to_play,
            card_requests: card_request,
            card_requested: card_requested,
            last_play_cards: player_cards,
            kadi: kadi,
            cardless: cardless,
            line: 1502,
          };
          break;
        }
      } else if (card_requested === 'diamonds') {
        if (diamonds.includes(current_card)) {
          let play_allowed = true;
          card_request = false;
          card_requested = '';

          if ([20, 21, 22, 23].includes(current_card)) {
            fine = 2;
            to_fine = to_play;
          } else if ([24, 25, 26, 27].includes(current_card)) {
            fine = 3;
            to_fine = to_play;
          }

          if (k === pll - 1) {
            action = {
              fine: fine,
              play_allowed: 'true',
              to_fine: to_fine,
              next_player: to_play,
              card_requests: card_request,
              card_requested: card_requested,
              last_play_cards: player_cards,
              kadi: kadi,
              cardless: cardless,
              line: 1524,
            };
            break;
          } else {
            let action_b = process_card_request(player_play, players, current_player, to_play);
            action = Object.assign({}, action_b, {
              card_requests: card_request,
              card_requested: card_requested,
              last_play_cards: player_cards,
              kadi: kadi,
              cardless: cardless,
              line: 1536,
            });
            break;
          }
        } else {
          action = {
            fine: '1',
            play_allowed: 'false',
            to_fine: 'self',
            next_player: to_play,
            card_requests: card_request,
            card_requested: card_requested,
            last_play_cards: player_cards,
            kadi: kadi,
            cardless: cardless,
            line: 1551,
          };
          break;
        }
      } else if (card_requested === 'flowers') {
        if (flowers.includes(current_card)) {
          let play_allowed = true;
          card_request = false;
          card_requested = '';

          if ([20, 21, 22, 23].includes(current_card)) {
            fine = 2;
            to_fine = to_play;
          } else if ([24, 25, 26, 27].includes(current_card)) {
            fine = 3;
            to_fine = to_play;
          }

          if (k === pll - 1) {
            action = {
              fine: fine,
              play_allowed: 'true',
              to_fine: to_fine,
              next_player: to_play,
              card_requests: card_request,
              card_requested: card_requested,
              last_play_cards: player_cards,
              kadi: kadi,
              cardless: cardless,
              line: 1574,
            };
            break;
          } else {
            let action_b = process_card_request(player_play, players, current_player, to_play);
            action = Object.assign({}, action_b, {
              card_requests: card_request,
              card_requested: card_requested,
              last_play_cards: player_cards,
              kadi: kadi,
              cardless: cardless,
              line: 1585,
            });
            break;
          }
        } else {
          action = {
            fine: '1',
            play_allowed: 'false',
            to_fine: 'self',
            next_player: to_play,
            card_requests: card_request,
            card_requested: card_requested,
            last_play_cards: player_cards,
            kadi: kadi,
            cardless: cardless,
            line: 1599,
          };
          break;
        }
      } else if (card_requested === 'spades') {
        if (spades.includes(current_card)) {
          let play_allowed = true;
          card_request = false;
          card_requested = '';

          if ([20, 21, 22, 23].includes(current_card)) {
            fine = 2;
            to_fine = to_play;
          } else if ([24, 25, 26, 27].includes(current_card)) {
            fine = 3;
            to_fine = to_play;
          }

          if (k === pll - 1) {
            action = {
              fine: fine,
              play_allowed: 'true',
              to_fine: to_fine,
              next_player: to_play,
              card_requests: card_request,
              card_requested: card_requested,
              last_play_cards: player_cards,
              kadi: kadi,
              cardless: cardless,
              line: 1620,
            };
            break;
          } else {
            let action_b = process_card_request(player_play, players, current_player, to_play);
            action = Object.assign({}, action_b, {
              card_requests: card_request,
              card_requested: card_requested,
              last_play_cards: player_cards,
              kadi: kadi,
              cardless: cardless,
              line: 1632,
            });
            break;
          }
        } else {
          action = {
            fine: '1',
            play_allowed: 'false',
            to_fine: 'self',
            next_player: to_play,
            card_requests: card_request,
            card_requested: card_requested,
            last_play_cards: player_cards,
            kadi: kadi,
            cardless: cardless,
            line: 1648,
          };
          break;
        }
      }
    }//end o card request
    else{
//normal card playing
card_request = cr;
card_requested = crd;
let kadiPlays = JSON.parse(localStorage.getItem('kadi_plays')) || {};
 const kpp = JSON.parse(localStorage.getItem('kadi_plays')) || {};
 console.log(cr);
 console.log(crd);
const kppo = (kpp.last_play[0]) == '[' ?JSON.parse(kpp.last_play):kpp.last_play;//Comment we check for [ because on second play we cannot parse the json an we need to differentiate when to parse on second play the [0] is an array instead of [
console.log(kppo);
console.log((kpp.last_play).length);
let last_play = kppo || []

let lpl = last_play.length;
let prev_card = last_play[0]?.play[0];

// Loop through last plays to find the previous valid card
for (let i = lpl - 1; i >= 1; i--) {
    let lpla = Array.isArray(last_play[i].play)?last_play[i].play:JSON.parse(last_play[i].play);

    if (
        lpla[lpla.length - 1] !== 'picked_card' &&
        last_play[i].to_fine !== 'self' &&
        ![0, 1, 2, 3].includes(lpla[lpla.length - 1])
    ) {
        let s = lpla.length - 1;
        prev_card = parseInt(lpla[s]);
        break;
    }
}

// Ensure prev_card is properly set
prev_card = Array.isArray(prev_card) ? prev_card[0] : prev_card;
alert(prev_card);
if ([0, 1, 2, 3].includes(current_card)) {
  play_allowed = true;
  card_ask_perm = true;

  if (k === pll - 1) {
    action = {
      fine: 'none',
      play_allowed: 'true',
      to_fine: 'none',
      next_player: to_play,
      card_requests: card_request,
      card_requested: card_requested,
      last_play_cards: player_cards,
      kadi: kadi,
      cardless: cardless,
      line: 1765,
      prev_card: prev_card
    };
  }
}

if ([4, 5, 6, 7].includes(current_card)) {
    if ([4, 5, 6, 7, 28, 29].includes(prev_card)) {
        play_allowed = true;
        card_ask_perm = true;

        let ps = players.length - 1;

        let op = players.shift();
        players.push(op);
        players.reverse();

        to_play = players[ps];

        if (k === pll - 1) {
            action = {
                fine: 'none',
                play_allowed: 'true',
                to_fine: 'none',
                next_player: to_play,
                card_requests: card_request,
                card_requested: card_requested,
                last_play_cards: player_cards,
                kadi: kadi,
                cardless: cardless,
                line: 2015,
                prev_card: prev_card
            };
        }
    } else {
        if (hearts.includes(current_card)) {
            if (hearts.includes(prev_card)) {
                let ps = players.length - 1;

                let op = players.shift();
                players.push(op);
                players.reverse();

                let ps2 = players.length - 1;

                to_play = players[ps2];

                play_allowed = true;
                if (k === pll - 1) {
                    action = {
                        fine: 'none',
                        play_allowed: 'true',
                        to_fine: 'none',
                        next_player: to_play,
                        card_requests: card_request,
                        card_requested: card_requested,
                        last_play_cards: player_cards,
                        kadi: kadi,
                        cardless: cardless,
                        line: 2054,
                        prev_card: prev_card
                    };
                }
            } else {
                action = {
                    fine: '1',
                    play_allowed: 'false',
                    to_fine: 'self',
                    next_player: to_play,
                    card_requests: card_request,
                    card_requested: card_requested,
                    last_play_cards: player_cards,
                    kadi: kadi,
                    cardless: cardless,
                    line: 2070,
                    prev_card: prev_card
                };
                break;
            }



        } else if (diamonds.includes(current_card)) {
            if (diamonds.includes(prev_card)) {
                let ps = players.length - 1;

                let op = players.shift();
                players.push(op);
                players.reverse();

                to_play = players[ps];

                play_allowed = true;
                if (k === pll - 1) {
                    action = {
                        fine: 'none',
                        play_allowed: 'true',
                        to_fine: 'none',
                        next_player: to_play,
                        card_requests: card_request,
                        card_requested: card_requested,
                        last_play_cards: player_cards,
                        kadi: kadi,
                        cardless: cardless,
                        line: 2109,
                        prev_card: prev_card
                    };
                }
            } else {
                action = {
                    fine: '1',
                    play_allowed: 'false',
                    to_fine: 'self',
                    next_player: to_play,
                    card_requests: card_request,
                    card_requested: card_requested,
                    last_play_cards: player_cards,
                    kadi: kadi,
                    cardless: cardless,
                    line: 2125,
                    prev_card: prev_card
                };
                break;
            }
        } else if (flowers.includes(current_card)) {
            if (flowers.includes(prev_card)) {
                let ps = players.length - 1;

                let op = players.shift();
                players.push(op);
                players.reverse();

                to_play = players[ps];

                play_allowed = true;
                if (k === pll - 1) {
                    action = {
                        fine: 'none',
                        play_allowed: 'true',
                        to_fine: 'none',
                        next_player: to_play,
                        card_requests: card_request,
                        card_requested: card_requested,
                        last_play_cards: player_cards,
                        kadi: kadi,
                        cardless: cardless,
                        line: 2166,
                        prev_card: prev_card
                    };
                }
            } else {
                action = {
                    fine: '1',
                    play_allowed: 'false',
                    to_fine: 'self',
                    next_player: to_play,
                    card_requests: card_request,
                    card_requested: card_requested,
                    last_play_cards: player_cards,
                    kadi: kadi,
                    cardless: cardless,
                    line: 2182,
                    prev_card: prev_card
                };
                break;
            }
        } else if (spades.includes(current_card)) {
            if (spades.includes(prev_card)) {
                let ps = players.length - 1;

                let op = players.shift();
                players.push(op);
                players.reverse();

                to_play = players[ps];

                play_allowed = true;
                if (k === pll - 1) {
                    action = {
                        fine: 'none',
                        play_allowed: 'true',
                        to_fine: 'none',
                        next_player: to_play,
                        card_requests: card_request,
                        card_requested: card_requested,
                        last_play_cards: player_cards,
                        kadi: kadi,
                        cardless: cardless,
                        line: 2221,
                        prev_card: prev_card
                    };
                }
            } else {
                action = {
                    fine: '1',
                    play_allowed: 'false',
                    to_fine: 'self',
                    next_player: to_play,
                    card_requests: card_request,
                    card_requested: card_requested,
                    last_play_cards: player_cards,
                    kadi: kadi,
                    cardless: cardless,
                    line: 2237,
                    prev_card: prev_card
                };
                break;
            }
        }
    }
}


if ([8, 9, 10, 11].includes(current_card)) {
    if ([8, 9, 10, 11, 28, 29].includes(prev_card)) {
        play_allowed = true;
        card_ask_perm = true;
        const pl = players.length;
        const last_player = players[pl - 1];
        current_player = players[pl - 1];
        players.pop();
        players.unshift(last_player);

        const to_play = players[pl - 1];

        if (k === pll - 1) {
            action = {
                fine: 'none',
                play_allowed: 'true',
                to_fine: 'none',
                next_player: to_play,
                card_requests: card_request,
                card_requested: card_requested,
                last_play_cards: player_cards,
                kadi: kadi,
                cardless: cardless,
                line: 2287,
                prev_card: prev_card
            };
        }
    }
 else{ 
    if (hearts.includes(current_card)) {
    if (hearts.includes(prev_card)) {
        const pl = players.length;
        const last_player = players[pl - 1];
        current_player = players[pl - 1];
        players.pop();
        players.unshift(last_player);

        const to_play = players[pl - 1];
        play_allowed = true;

        if (k === pll - 1) {
            action = {
                fine: 'none',
                play_allowed: 'true',
                to_fine: 'none',
                next_player: to_play,
                card_requests: card_request,
                card_requested: card_requested,
                last_play_cards: player_cards,
                kadi: kadi,
                cardless: cardless,
                line: 2334,
                prev_card: prev_card
            };
        }
    } else {
        action = {
            fine: '1',
            play_allowed: 'false',
            to_fine: 'self',
            next_player: to_play,
            card_requests: card_request,
            card_requested: card_requested,
            last_play_cards: player_cards,
            kadi: kadi,
            cardless: cardless,
            line: 2351,
            prev_card: prev_card
        };
        break;
    }
} else if (diamonds.includes(current_card)) {
    if (diamonds.includes(prev_card)) {
        const pl = players.length;
        const last_player = players[pl - 1];
        current_player = players[pl - 1];
        players.pop();
        players.unshift(last_player);

        const to_play = players[pl - 1];
        play_allowed = true;

        if (k === pll - 1) {
            action = {
                fine: 'none',
                play_allowed: 'true',
                to_fine: 'none',
                next_player: to_play,
                card_requests: card_request,
                card_requested: card_requested,
                last_play_cards: player_cards,
                kadi: kadi,
                cardless: cardless,
                line: 2384,
                prev_card: prev_card
            };
        }
    } else {
        action = {
            fine: '1',
            play_allowed: 'false',
            to_fine: 'self',
            next_player: to_play,
            card_requests: card_request,
            card_requested: card_requested,
            last_play_cards: player_cards,
            kadi: kadi,
            cardless: cardless,
            line: 2400,
            prev_card: prev_card
        };
        break;
    }
} else if (flowers.includes(current_card)) {
    if (flowers.includes(prev_card)) {
        const pl = players.length;
        const last_player = players[pl - 1];
        current_player = players[pl - 1];
        players.pop();
        players.unshift(last_player);

        const to_play = players[pl - 1];
        play_allowed = true;

        if (k === pll - 1) {
            action = {
                fine: 'none',
                play_allowed: 'true',
                to_fine: 'none',
                next_player: to_play,
                card_requests: card_request,
                card_requested: card_requested,
                last_play_cards: player_cards,
                kadi: kadi,
                cardless: cardless,
                line: 2434,
                prev_card: prev_card
            };
        }
    } else {
        action = {
            fine: '1',
            play_allowed: 'false',
            to_fine: 'self',
            next_player: to_play,
            card_requests: card_request,
            card_requested: card_requested,
            last_play_cards: player_cards,
            kadi: kadi,
            cardless: cardless,
            line: 2451,
            prev_card: prev_card
        };
        break;
    }
} else if (spades.includes(current_card)) {
    if (spades.includes(prev_card)) {
        const pl = players.length;
        const last_player = players[pl - 1];
        current_player = players[pl - 1];
        players.pop();
        players.unshift(last_player);

        const to_play = players[pl - 1];
        play_allowed = true;

        if (k === pll - 1) {
            action = {
                fine: 'none',
                play_allowed: 'true',
                to_fine: 'none',
                next_player: to_play,
                card_requests: card_request,
                card_requested: card_requested,
                last_play_cards: player_cards,
                kadi: kadi,
                cardless: cardless,
                line: 2486,
                prev_card: prev_card
            };
        }
    } else {
        action = {
            fine: '1',
            play_allowed: 'false',
            to_fine: 'self',
            next_player: to_play,
            card_requests: card_request,
            card_requested: card_requested,
            last_play_cards: player_cards,
            kadi: kadi,
            cardless: cardless,
            line: 2503,
            prev_card: prev_card
        };
        break;
    }
}
}
}


if ([12, 13, 14, 15].includes(current_card)) {
    if ([12, 13, 14, 15, 28, 29].includes(prev_card)) {
        play_allowed = true;
        card_ask_perm = true;

        if (k === pll - 1) {
            action = {
                fine: 'none',
                play_allowed: 'true',
                to_fine: 'none',
                next_player: to_play,
                card_requests: card_request,
                card_requested: card_requested,
                last_play_cards: player_cards,
                kadi: kadi,
                cardless: cardless,
                line: 2549,
                prev_card: prev_card
            };
        }
    } 
 else if (hearts.includes(current_card)) {
    if (hearts.includes(prev_card)) {
        play_allowed = true;

        if (k === pll - 1) {
            action = {
                fine: 'none',
                play_allowed: 'true',
                to_fine: 'none',
                next_player: to_play,
                card_requests: card_request,
                card_requested: card_requested,
                last_play_cards: player_cards,
                kadi: kadi,
                cardless: cardless,
                line: 2587,
                prev_card: prev_card
            };
        }
    } else {
        action = {
            fine: '1',
            play_allowed: 'false',
            to_fine: 'self',
            next_player: to_play,
            card_requests: card_request,
            card_requested: card_requested,
            last_play_cards: player_cards,
            kadi: kadi,
            cardless: cardless,
            line: 2604,
            prev_card: prev_card
        };
        break;
    }
} else if (diamonds.includes(current_card)) {
    if (diamonds.includes(prev_card)) {
        play_allowed = true;

        if (k === pll - 1) {
            action = {
                fine: 'none',
                play_allowed: 'true',
                to_fine: 'none',
                next_player: to_play,
                card_requests: card_request,
                card_requested: card_requested,
                last_play_cards: player_cards,
                kadi: kadi,
                cardless: cardless,
                line: 2628,
                prev_card: prev_card
            };
        }
    } else {
        action = {
            fine: '1',
            play_allowed: 'false',
            to_fine: 'self',
            next_player: to_play,
            card_requests: card_request,
            card_requested: card_requested,
            last_play_cards: player_cards,
            kadi: kadi,
            cardless: cardless,
            line: 2645,
            prev_card: prev_card
        };
        break;
    }
} else if (flowers.includes(current_card)) {
    if (flowers.includes(prev_card)) {
        play_allowed = true;

        if (k === pll - 1) {
            action = {
                fine: 'none',
                play_allowed: 'true',
                to_fine: 'none',
                next_player: to_play,
                card_requests: card_request,
                card_requested: card_requested,
                last_play_cards: player_cards,
                kadi: kadi,
                cardless: cardless,
                line: 2669,
                prev_card: prev_card
            };
        }
    } else {
        action = {
            fine: '1',
            play_allowed: 'false',
            to_fine: 'self',
            next_player: to_play,
            card_requests: card_request,
            card_requested: card_requested,
            last_play_cards: player_cards,
            kadi: kadi,
            cardless: cardless,
            line: 2686,
            prev_card: prev_card
        };
        break;
    }
} else if (spades.includes(current_card)) {
    if (spades.includes(prev_card)) {
        play_allowed = true;

        if (k === pll - 1) {
            action = {
                fine: 'none',
                play_allowed: 'true',
                to_fine: 'none',
                next_player: to_play,
                card_requests: card_request,
                card_requested: card_requested,
                last_play_cards: player_cards,
                kadi: kadi,
                cardless: cardless,
                line: 2710,
                prev_card: prev_card
            };
        }
    } else {
        action = {
            fine: '1',
            play_allowed: 'false',
            to_fine: 'self',
            next_player: to_play,
            card_requests: card_request,
            card_requested: card_requested,
            last_play_cards: player_cards,
            kadi: kadi,
            cardless: cardless,
            line: 2727,
            prev_card: prev_card
        };
        break;
    }
}
}


if ([16, 17, 18, 19].includes(current_card)) {
    if ([16, 17, 18, 19, 28, 29].includes(prev_card)) {
        play_allowed = true;
        card_ask_perm = true;
        if (k === pll - 1) {
            action = {
                fine: 'none',
                play_allowed: 'true',
                to_fine: 'none',
                next_player: to_play,
                card_requests: card_request,
                card_requested: card_requested,
                last_play_cards: player_cards,
                kadi: kadi,
                cardless: cardless,
                line: 2763,
                prev_card: prev_card
            };
        }
    } else if (hearts.includes(current_card)) {
        if (hearts.includes(prev_card)) {
            play_allowed = true;
            if (k === pll - 1) {
                action = {
                    fine: 'none',
                    play_allowed: 'true',
                    to_fine: 'none',
                    next_player: to_play,
                    card_requests: card_request,
                    card_requested: card_requested,
                    last_play_cards: player_cards,
                    kadi: kadi,
                    cardless: cardless,
                    line: 2785,
                    prev_card: prev_card
                };
            }
        } else {
            action = {
                fine: '1',
                play_allowed: 'false',
                to_fine: 'self',
                next_player: to_play,
                card_requests: card_request,
                card_requested: card_requested,
                last_play_cards: player_cards,
                kadi: kadi,
                cardless: cardless,
                line: 2802,
                prev_card: prev_card
            };
            break;
        }
    } else if (diamonds.includes(current_card)) {
        if (diamonds.includes(prev_card)) {
            play_allowed = true;
            if (k === pll - 1) {
                action = {
                    fine: 'none',
                    play_allowed: 'true',
                    to_fine: 'none',
                    next_player: to_play,
                    card_requests: card_request,
                    card_requested: card_requested,
                    last_play_cards: player_cards,
                    kadi: kadi,
                    cardless: cardless,
                    line: 2827,
                    prev_card: prev_card
                };
            }
        } else {
            action = {
                fine: '1',
                play_allowed: 'false',
                to_fine: 'self',
                next_player: to_play,
                card_requests: card_request,
                card_requested: card_requested,
                last_play_cards: player_cards,
                kadi: kadi,
                cardless: cardless,
                line: 2843,
                prev_card: prev_card
            };
            break;
        }
    } else if (flowers.includes(current_card)) {
        if (flowers.includes(prev_card)) {
            play_allowed = true;
            if (k === pll - 1) {
                action = {
                    fine: 'none',
                    play_allowed: 'true',
                    to_fine: 'none',
                    next_player: to_play,
                    card_requests: card_request,
                    card_requested: card_requested,
                    last_play_cards: player_cards,
                    kadi: kadi,
                    cardless: cardless,
                    line: 2868,
                    prev_card: prev_card
                };
            }
        } else {
            action = {
                fine: '1',
                play_allowed: 'false',
                to_fine: 'self',
                next_player: to_play,
                card_requests: card_request,
                card_requested: card_requested,
                last_play_cards: player_cards,
                kadi: kadi,
                cardless: cardless,
                line: 2884,
                prev_card: prev_card
            };
            break;
        }
    } else if (spades.includes(current_card)) {
        if (spades.includes(prev_card)) {
            play_allowed = true;
            if (k === pll - 1) {
                action = {
                    fine: 'none',
                    play_allowed: 'true',
                    to_fine: 'none',
                    next_player: to_play,
                    card_requests: card_request,
                    card_requested: card_requested,
                    last_play_cards: player_cards,
                    kadi: kadi,
                    cardless: cardless,
                    line: 2909,
                    prev_card: prev_card
                };
            }
        } else {
            action = {
                fine: '1',
                play_allowed: 'false',
                to_fine: 'self',
                next_player: to_play,
                card_requests: card_request,
                card_requested: card_requested,
                last_play_cards: player_cards,
                kadi: kadi,
                cardless: cardless,
                line: 2926,
                prev_card: prev_card
            };
            break;
        }
    }
}


if ([20, 21, 22, 23].includes(current_card)) {
    to_pick = true;
    if ([20, 21, 22, 23, 28, 29].includes(prev_card)) {
        play_allowed = true;
        card_ask_perm = true;
        if (k === pll - 1) {
            fine = 2;
            action = {
                fine: fine,
                play_allowed: 'true',
                to_fine: to_play,
                next_player: to_play,
                card_requests: card_request,
                card_requested: card_requested,
                last_play_cards: player_cards,
                kadi: kadi,
                cardless: cardless,
                line: 2965,
                prev_card: prev_card
            };
        }
    } else {
        if (hearts.includes(current_card)) {
            if (hearts.includes(prev_card)) {
                play_allowed = true;
                if (k === pll - 1) {
                    fine = 2;
                    action = {
                        fine: fine,
                        play_allowed: 'true',
                        to_fine: to_play,
                        next_player: to_play,
                        card_requests: card_request,
                        card_requested: card_requested,
                        last_play_cards: player_cards,
                        kadi: kadi,
                        cardless: cardless,
                        line: 3012,
                        prev_card: prev_card
                    };
                }
            } else {
                action = {
                    fine: '1',
                    play_allowed: 'false',
                    to_fine: 'self',
                    next_player: to_play,
                    card_requests: card_request,
                    card_requested: card_requested,
                    last_play_cards: player_cards,
                    kadi: kadi,
                    cardless: cardless,
                    line: 3028,
                    prev_card: prev_card
                };
                break;
            }
        } else if (diamonds.includes(current_card)) {
            if (diamonds.includes(prev_card)) {
                play_allowed = true;
                if (k === pll - 1) {
                    fine = 2;
                    action = {
                        fine: fine,
                        play_allowed: 'true',
                        to_fine: to_play,
                        next_player: to_play,
                        card_requests: card_request,
                        card_requested: card_requested,
                        last_play_cards: player_cards,
                        kadi: kadi,
                        cardless: cardless,
                        line: 3052,
                        prev_card: prev_card
                    };
                }
            } else {
                action = {
                    fine: '1',
                    play_allowed: 'false',
                    to_fine: 'self',
                    next_player: to_play,
                    card_requests: card_request,
                    card_requested: card_requested,
                    last_play_cards: player_cards,
                    kadi: kadi,
                    cardless: cardless,
                    line: 3068,
                    prev_card: prev_card
                };
                break;
            }
        } else if (flowers.includes(current_card)) {
            if (flowers.includes(prev_card)) {
                play_allowed = true;
                if (k === pll - 1) {
                    fine = 2;
                    action = {
                        fine: fine,
                        play_allowed: 'true',
                        to_fine: to_play,
                        next_player: to_play,
                        card_requests: card_request,
                        card_requested: card_requested,
                        last_play_cards: player_cards,
                        kadi: kadi,
                        cardless: cardless,
                        line: 3089,
                        prev_card: prev_card
                    };
                }
            } else {
                action = {
                    fine: '1',
                    play_allowed: 'false',
                    to_fine: 'self',
                    next_player: to_play,
                    card_requests: card_request,
                    card_requested: card_requested,
                    last_play_cards: player_cards,
                    kadi: kadi,
                    cardless: cardless,
                    line: 3105,
                    prev_card: prev_card
                };
                break;
            }
        } else if (spades.includes(current_card)) {
            if (spades.includes(prev_card)) {
                play_allowed = true;
                if (k === pll - 1) {
                    fine = 2;
                    action = {
                        fine: fine,
                        play_allowed: 'true',
                        to_fine: to_play,
                        next_player: to_play,
                        card_requests: card_request,
                        card_requested: card_requested,
                        last_play_cards: player_cards,
                        kadi: kadi,
                        cardless: cardless,
                        line: 3125,
                        prev_card: prev_card
                    };
                }
            } else {
                action = {
                    fine: '1',
                    play_allowed: 'false',
                    to_fine: 'self',
                    next_player: to_play,
                    card_requests: card_request,
                    card_requested: card_requested,
                    last_play_cards: player_cards,
                    kadi: kadi,
                    cardless: cardless,
                    line: 3143,
                    prev_card: prev_card
                };
                break;
            }
        }
    }
}

if ([24, 25, 26, 27].includes(current_card)) {
    to_pick = true;
    if ([24, 25, 26, 27, 28, 29].includes(prev_card)) {
        play_allowed = true;
        card_ask_perm = true;
        fine = 3;
        if (k === pll - 1) {
            action = {
                fine: fine,
                play_allowed: 'true',
                to_fine: to_play,
                next_player: to_play,
                card_requests: card_request,
                card_requested: card_requested,
                last_play_cards: player_cards,
                kadi: kadi,
                cardless: cardless,
                line: 3177,
                prev_card: prev_card
            };
        }
    } else {
        if (hearts.includes(current_card)) {
            if (hearts.includes(prev_card)) {
                play_allowed = true;
                if (k === pll - 1) {
                    fine = 3;
                    action = {
                        fine: fine,
                        play_allowed: 'true',
                        to_fine: to_play,
                        next_player: to_play,
                        card_requests: card_request,
                        card_requested: card_requested,
                        last_play_cards: player_cards,
                        kadi: kadi,
                        cardless: cardless,
                        line: 3205,
                        prev_card: prev_card
                    };
                }
            } else {
                action = {
                    fine: '1',
                    play_allowed: 'false',
                    to_fine: 'self',
                    next_player: to_play,
                    card_requests: card_request,
                    card_requested: card_requested,
                    last_play_cards: player_cards,
                    kadi: kadi,
                    cardless: cardless,
                    line: 3221,
                    prev_card: prev_card
                };
                break;
            }
        } else if (diamonds.includes(current_card)) {
            if (diamonds.includes(prev_card)) {
                play_allowed = true;
                if (k === pll - 1) {
                    fine = 3;
                    action = {
                        fine: 'none',
                        play_allowed: 'true',
                        to_fine: 'none',
                        next_player: to_play,
                        card_requests: card_request,
                        card_requested: card_requested,
                        last_play_cards: player_cards,
                        kadi: kadi,
                        cardless: cardless,
                        line: 3242,
                        prev_card: prev_card
                    };
                }
            } else {
                action = {
                    fine: '1',
                    play_allowed: 'false',
                    to_fine: 'self',
                    next_player: to_play,
                    card_requests: card_request,
                    card_requested: card_requested,
                    last_play_cards: player_cards,
                    kadi: kadi,
                    cardless: cardless,
                    line: 3259,
                    prev_card: prev_card
                };
                break;
            }
        } else if (flowers.includes(current_card)) {
            if (flowers.includes(prev_card)) {
                play_allowed = true;
                if (k === pll - 1) {
                    fine = 3;
                    action = {
                        fine: fine,
                        play_allowed: 'true',
                        to_fine: to_play,
                        next_player: to_play,
                        card_requests: card_request,
                        card_requested: card_requested,
                        last_play_cards: player_cards,
                        kadi: kadi,
                        cardless: cardless,
                        line: 3280,
                        prev_card: prev_card
                    };
                }
            } else {
                action = {
                    fine: '1',
                    play_allowed: 'false',
                    to_fine: 'self',
                    next_player: to_play,
                    card_requests: card_request,
                    card_requested: card_requested,
                    last_play_cards: player_cards,
                    kadi: kadi,
                    cardless: cardless,
                    line: 3296,
                    prev_card: prev_card
                };
                break;
            }
        } else if (spades.includes(current_card)) {
            if (spades.includes(prev_card)) {
                play_allowed = true;
                if (k === pll - 1) {
                    fine = 3;
                    action = {
                        fine: fine,
                        play_allowed: 'true',
                        to_fine: to_play,
                        next_player: to_play,
                        card_requests: card_request,
                        card_requested: card_requested,
                        last_play_cards: player_cards,
                        kadi: kadi,
                        cardless: cardless,
                        line: 3316,
                        prev_card: prev_card
                    };
                }
            } else {
                action = {
                    fine: '1',
                    play_allowed: 'false',
                    to_fine: 'self',
                    next_player: to_play,
                    card_requests: card_request,
                    card_requested: card_requested,
                    last_play_cards: player_cards,
                    kadi: kadi,
                    cardless: cardless,
                    line: 3332,
                    prev_card: prev_card
                };
                break;
            }
        }
    }
}


if ([28, 29].includes(current_card)) {
    play_allowed = true;

    if (k === pll - 1) {
        action = {
            fine: '5',
            play_allowed: 'true',
            to_fine: to_play,
            next_player: to_play,
            card_requests: card_request,
            card_requested: card_requested,
            last_play_cards: player_cards,
            kadi: kadi,
            cardless: cardless,
            line: 3366,
            prev_card: prev_card
        };
    }
}

if ([30, 31, 32, 33].includes(current_card)) {
    if ([30, 31, 32, 33, 27, 28].includes(prev_card)) {
        play_allowed = true;
        card_ask_perm = true;

        if (k === pll - 1) {
            action = {
                fine: 'none',
                play_allowed: 'true',
                to_fine: 'none',
                next_player: to_play,
                card_requests: card_request,
                card_requested: card_requested,
                last_play_cards: player_cards,
                kadi: kadi,
                cardless: cardless,
                line: 3389,
                prev_card: prev_card
            };
        }
    } else {
        if (hearts.includes(prev_card)) {
            if (hearts.includes(current_card)) {
                play_allowed = true;
                if (k === pll - 1) {
                    action = {
                        fine: 'none',
                        play_allowed: 'true',
                        to_fine: 'none',
                        next_player: to_play,
                        card_requests: card_request,
                        card_requested: card_requested,
                        last_play_cards: player_cards,
                        kadi: kadi,
                        cardless: cardless,
                        line: 3414,
                        prev_card: prev_card
                    };
                }
            } else {
                action = {
                    fine: '1',
                    play_allowed: 'false',
                    to_fine: 'self',
                    next_player: to_play,
                    card_requests: card_request,
                    card_requested: card_requested,
                    last_play_cards: player_cards,
                    kadi: kadi,
                    cardless: cardless,
                    line: 3429,
                    prev_card: prev_card
                };
                break;
            }
        } else if (diamonds.includes(prev_card)) {
            if (diamonds.includes(current_card)) {
                play_allowed = true;
                if (k === pll - 1) {
                    action = {
                        fine: 'none',
                        play_allowed: 'true',
                        to_fine: 'none',
                        next_player: to_play,
                        card_requests: card_request,
                        card_requested: card_requested,
                        last_play_cards: player_cards,
                        kadi: kadi,
                        cardless: cardless,
                        line: 3456,
                        prev_card: prev_card
                    };
                }
            } else {
                action = {
                    fine: '1',
                    play_allowed: 'false',
                    to_fine: 'self',
                    next_player: to_play,
                    card_requests: card_request,
                    card_requested: card_requested,
                    last_play_cards: player_cards,
                    kadi: kadi,
                    cardless: cardless,
                    line: 3470,
                    prev_card: prev_card
                };
                break;
            }
        } else if (flowers.includes(current_card)) {
            if (flowers.includes(prev_card)) {
                play_allowed = true;
                if (k === pll - 1) {
                    action = {
                        fine: 'none',
                        play_allowed: 'true',
                        to_fine: 'none',
                        next_player: to_play,
                        card_requests: card_request,
                        card_requested: card_requested,
                        last_play_cards: player_cards,
                        kadi: kadi,
                        cardless: cardless,
                        line: 3492,
                        prev_card: prev_card
                    };
                }
            } else {
                action = {
                    fine: '1',
                    play_allowed: 'false',
                    to_fine: 'self',
                    next_player: to_play,
                    card_requests: card_request,
                    card_requested: card_requested,
                    last_play_cards: player_cards,
                    kadi: kadi,
                    cardless: cardless,
                    line: 3506,
                    prev_card: prev_card
                };
                break;
            }
        } else if (spades.includes(current_card)) {
            if (spades.includes(prev_card)) {
                play_allowed = true;
                if (k === pll - 1) {
                    action = {
                        fine: 'none',
                        play_allowed: 'true',
                        to_fine: 'none',
                        next_player: to_play,
                        card_requests: card_request,
                        card_requested: card_requested,
                        last_play_cards: player_cards,
                        kadi: kadi,
                        cardless: cardless,
                        line: 3527,
                        prev_card: prev_card
                    };
                }
            } else {
                action = {
                    fine: '1',
                    play_allowed: 'false',
                    to_fine: 'self',
                    next_player: to_play,
                    card_requests: card_request,
                    card_requested: card_requested,
                    last_play_cards: player_cards,
                    kadi: kadi,
                    cardless: cardless,
                    line: 3541,
                    prev_card: prev_card
                };
                break;
            }
        }
    }
}


if ([34, 35, 36, 37].includes(current_card)) {
    if ([34, 35, 36, 37, 28, 29].includes(prev_card)) {
        playAllowed = true;
        cardAskPerm = true;
        if (k === pll - 1) {
            action = {
                fine: 'none',
                play_allowed: 'true',
                to_fine: 'none',
                next_player: to_play,
                card_requests: card_request,
                card_requested: card_requested,
                last_play_cards: player_cards,
                kadi: kadi,
                cardless: cardless,
                line: 3577,
                 // prev_card: prevCard
            };
        }
    } else {
        if (hearts.includes(current_card)) {
            if (hearts.includes(prev_card)) {
                playAllowed = true;
                if (k === pll - 1) {
                    action = {
                        fine: 'none',
                        play_allowed: 'true',
                        to_fine: 'none',
                        next_player: to_play,
                        card_requests: card_request,
                        card_requested: card_requested,
                        last_play_cards: player_cards,
                        kadi: kadi,
                        cardless: cardless,
                        line: 3599,
                         // prev_card: prevCard
                    };
                }
            } else {
                action = {
                    fine: '1',
                    play_allowed: 'false',
                    to_fine: 'none',
                    next_player: to_play,
                    card_requests: card_request,
                    card_requested: card_requested,
                    last_play_cards: player_cards,
                    kadi: kadi,
                    cardless: cardless,
                    line: 3615,
                     // prev_card: prevCard
                };
                break;
            }
        } else if (diamonds.includes(current_card)) {
            if (diamonds.includes(prev_card)) {
                playAllowed = true;
                if (k === pll - 1) {
                    action = {
                        fine: 'none',
                        play_allowed: 'true',
                        to_fine: 'none',
                        next_player: to_play,
                        card_requests: card_request,
                        card_requested: card_requested,
                        last_play_cards: player_cards,
                        kadi: kadi,
                        cardless: cardless,
                        line: 3636,
                         // prev_card: prevCard
                    };
                }
            } else {
                action = {
                    fine: '1',
                    play_allowed: 'false',
                    to_fine: 'none',
                    next_player: to_play,
                    card_requests: card_request,
                    card_requested: card_requested,
                    last_play_cards: player_cards,
                    kadi: kadi,
                    cardless: cardless,
                    line: 3653,
                     // prev_card: prevCard
                };
                break;
            }
        } else if (flowers.includes(current_card)) {
            if (flowers.includes(prev_card)) {
                playAllowed = true;
                if (k === pll - 1) {
                    action = {
                        fine: 'none',
                        play_allowed: 'true',
                        to_fine: 'none',
                        next_player: to_play,
                        card_requests: card_request,
                        card_requested: card_requested,
                        last_play_cards: player_cards,
                        kadi: kadi,
                        cardless: cardless,
                        line: 3674,
                         // prev_card: prevCard
                    };
                }
            } else {
                action = {
                    fine: '1',
                    play_allowed: 'false',
                    to_fine: 'none',
                    next_player: to_play,
                    card_requests: card_request,
                    card_requested: card_requested,
                    last_play_cards: player_cards,
                    kadi: kadi,
                    cardless: cardless,
                    line: 3690,
                     // prev_card: prevCard
                };
                break;
            }
        } else if (spades.includes(current_card)) {
            if (spades.includes(prev_card)) {
                playAllowed = true;
                if (k === pll - 1) {
                    action = {
                        fine: 'none',
                        play_allowed: 'true',
                        to_fine: 'none',
                        next_player: to_play,
                        card_requests: card_request,
                        card_requested: card_requested,
                        last_play_cards: player_cards,
                        kadi: kadi,
                        cardless: cardless,
                        line: 3710,
                         // prev_card: prevCard
                    };
                }
            } else {
                action = {
                    fine: '1',
                    play_allowed: 'false',
                    to_fine: 'none',
                    next_player: to_play,
                    card_requests: card_request,
                    card_requested: card_requested,
                    last_play_cards: player_cards,
                    kadi: kadi,
                    cardless: cardless,
                    line: 3726,
                     // prev_card: prevCard
                };
                break;
            }
        }
    }
}

if ([38, 39, 40, 41].includes(current_card)) {
    if ([38, 39, 40, 41, 28, 29].includes(prev_card)) {
        playAllowed = true;
        cardAskPerm = true;
        if (k === pll - 1) {
            action = {
                fine: 'none',
                play_allowed: 'true',
                to_fine: 'none',
                next_player: to_play,
                card_requests: card_request,
                card_requested: card_requested,
                last_play_cards: player_cards,
                kadi: kadi,
                cardless: cardless,
                line: 3758,
                 // prev_card: prevCard
            };
        }
    } else {
        if (hearts.includes(current_card)) {
            if (hearts.includes(prev_card)) {
                playAllowed = true;
                if (k === pll - 1) {
                    action = {
                        fine: 'none',
                        play_allowed: 'true',
                        to_fine: 'none',
                        next_player: to_play,
                        card_requests: card_request,
                        card_requested: card_requested,
                        last_play_cards: player_cards,
                        kadi: kadi,
                        cardless: cardless,
                        line: 3780,
                         // prev_card: prevCard
                    };
                }
            } else {
                action = {
                    fine: '1',
                    play_allowed: 'false',
                    to_fine: 'self',
                    next_player: to_play,
                    card_requests: card_request,
                    card_requested: card_requested,
                    last_play_cards: player_cards,
                    kadi: kadi,
                    cardless: cardless,
                    line: 3795,
                     // prev_card: prevCard
                };
                break;
            }
        } else if (diamonds.includes(current_card)) {
            if (diamonds.includes(prev_card)) {
                playAllowed = true;
                if (k === pll - 1) {
                    action = {
                        fine: 'none',
                        play_allowed: 'true',
                        to_fine: 'none',
                        next_player: to_play,
                        card_requests: card_request,
                        card_requested: card_requested,
                        last_play_cards: player_cards,
                        kadi: kadi,
                        cardless: cardless,
                        line: 3815,
                         // prev_card: prevCard
                    };
                }
            } else {
                action = {
                    fine: '1',
                    play_allowed: 'false',
                    to_fine: 'self',
                    next_player: to_play,
                    card_requests: card_request,
                    card_requested: card_requested,
                    last_play_cards: player_cards,
                    kadi: kadi,
                    cardless: cardless,
                    line: 3830,
                     // prev_card: prevCard
                };
                break;
            }
        } else if (flowers.includes(current_card)) {
            if (flowers.includes(prev_card)) {
                playAllowed = true;
                if (k === pll - 1) {
                    action = {
                        fine: 'none',
                        play_allowed: 'true',
                        to_fine: 'none',
                        next_player: to_play,
                        card_requests: card_request,
                        card_requested: card_requested,
                        last_play_cards: player_cards,
                        kadi: kadi,
                        cardless: cardless,
                        line: 3851,
                         // prev_card: prevCard





                    };
                }
            } else {
                action = {
                    fine: '1',
                    play_allowed: 'false',
                    to_fine: 'self',
                    next_player: to_play,
                    card_requests: card_request,
                    card_requested: card_requested,
                    last_play_cards: player_cards,
                    kadi: kadi,
                    cardless: cardless,
                    line: 3866,
                     // prev_card: prevCard
                };
                break;
            }
        } else if (spades.includes(current_card)) {
            if (spades.includes(prev_card)) {
                playAllowed = true;
                if (k === pll - 1) {
                    action = {
                        fine: 'none',
                        play_allowed: 'true',
                        to_fine: 'none',
                        next_player: to_play,
                        card_requests: card_request,
                        card_requested: card_requested,
                        last_play_cards: player_cards,
                        kadi: kadi,
                        cardless: cardless,
                        line: 3886,
                         // prev_card: prevCard
                    };
                }
            } else {
                action = {
                    fine: '1',
                    play_allowed: 'false',
                    to_fine: 'self',
                    next_player: to_play,
                    card_requests: card_request,
                    card_requested: card_requested,
                    last_play_cards: player_cards,
                    kadi: kadi,
                    cardless: cardless,
                    line: 3902,
                     // prev_card: prevCard
                };
                break;
            }
        }
    }
}


if ([42, 43, 44, 45].includes(current_card)) {
    if ([42, 43, 44, 45, 28, 29].includes(prev_card)) {
        play_allowed = true;
        card_ask_perm = true;
        if (k === pll - 1) {
            action = {
                fine: 'none',
                play_allowed: 'true',
                to_fine: 'none',
                next_player: to_play,
                card_requests: card_request,
                card_requested: card_requested,
                last_play_cards: player_cards,
                kadi: kadi,
                cardless: cardless,
                line: 3935,
                prev_card: prev_card
            };
        }
    } else {
        if (hearts.includes(current_card)) {
            if (hearts.includes(prev_card)) {
                play_allowed = true;
                if (k === pll - 1) {
                    action = {
                        fine: 'none',
                        play_allowed: 'true',
                        to_fine: 'none',
                        next_player: to_play,
                        card_requests: card_request,
                        card_requested: card_requested,
                        last_play_cards: player_cards,
                        kadi: kadi,
                        cardless: cardless,
                        line: 3957,
                        prev_card: prev_card
                    };
                }
            } else {
                action = {
                    fine: '1',
                    play_allowed: 'false',
                    to_fine: 'self',
                    next_player: to_play,
                    card_requests: card_request,
                    card_requested: card_requested,
                    last_play_cards: player_cards,
                    kadi: kadi,
                    cardless: cardless,
                    line: 3972,
                    prev_card: prev_card
                };
                break;
            }
        } else if (diamonds.includes(current_card)) {
            if (diamonds.includes(prev_card)) {
                play_allowed = true;
                if (k === pll - 1) {
                    action = {
                        fine: 'none',
                        play_allowed: 'true',
                        to_fine: 'none',
                        next_player: to_play,
                        card_requests: card_request,
                        card_requested: card_requested,
                        last_play_cards: player_cards,
                        kadi: kadi,
                        cardless: cardless,
                        line: 3996,
                        prev_card: prev_card
                    };
                }
            } else {
                action = {
                    fine: '1',
                    play_allowed: 'false',
                    to_fine: 'self',
                    next_player: to_play,
                    card_requests: card_request,
                    card_requested: card_requested,
                    last_play_cards: player_cards,
                    kadi: kadi,
                    cardless: cardless,
                    line: 4011,
                    prev_card: prev_card
                };
                break;
            }
        } else if (flowers.includes(current_card)) {
            if (flowers.includes(prev_card)) {
                play_allowed = true;
                if (k === pll - 1) {
                    action = {
                        fine: 'none',
                        play_allowed: 'true',
                        to_fine: 'none',
                        next_player: to_play,
                        card_requests: card_request,
                        card_requested: card_requested,
                        last_play_cards: player_cards,
                        kadi: kadi,
                        cardless: cardless,
                        line: 4032,
                        prev_card: prev_card
                    };
                }
            } else {
                action = {
                    fine: '1',
                    play_allowed: 'false',
                    to_fine: 'self',
                    next_player: to_play,
                    card_requests: card_request,
                    card_requested: card_requested,
                    last_play_cards: player_cards,
                    kadi: kadi,
                    cardless: cardless,
                    line: 4047,
                    prev_card: prev_card
                };
                break;
            }
        } else if (spades.includes(current_card)) {
            if (spades.includes(prev_card)) {
                play_allowed = true;
                if (k === pll - 1) {
                    action = {
                        fine: 'none',
                        play_allowed: 'true',
                        to_fine: 'none',
                        next_player: to_play,
                        card_requests: card_request,
                        card_requested: card_requested,
                        last_play_cards: player_cards,
                        kadi: kadi,
                        cardless: cardless,
                        line: 4067,
                        prev_card: prev_card
                    };
                }
            } else {
                action = {
                    fine: '1',
                    play_allowed: 'false',
                    to_fine: 'self',
                    next_player: to_play,
                    card_requests: card_request,
                    card_requested: card_requested,
                    last_play_cards: player_cards,
                    kadi: kadi,
                    cardless: cardless,
                    line: 4083,
                    prev_card: prev_card
                };
                break;
            }
        }
    }
}

if ([46, 47, 48, 49].includes(current_card)) {
    if ([46, 47, 48, 49, 28, 29].includes(prev_card)) {
        play_allowed = true;
        card_ask_perm = true;
        if (k === pll - 1) {
            action = {
                fine: 'none',
                play_allowed: 'true',
                to_fine: 'none',
                next_player: to_play,
                card_requests: card_request,
                card_requested: card_requested,
                last_play_cards: player_cards,
                kadi: kadi,
                cardless: cardless,
                line: 4117,
                prev_card: prev_card
            };
        }
    } else {
        if (hearts.includes(current_card)) {
            if (hearts.includes(prev_card)) {
                play_allowed = true;
                if (k === pll - 1) {
                    action = {
                        fine: 'none',
                        play_allowed: 'true',
                        to_fine: 'none',
                        next_player: to_play,
                        card_requests: card_request,
                        card_requested: card_requested,
                        last_play_cards: player_cards,
                        kadi: kadi,
                        cardless: cardless,
                        line: 4139,
                        prev_card: prev_card
                    };
                }
            } else {
                action = {
                    fine: '1',
                    play_allowed: 'false',
                    to_fine: 'self',
                    next_player: to_play,
                    card_requests: card_request,
                    card_requested: card_requested,
                    last_play_cards: player_cards,
                    kadi: kadi,
                    cardless: cardless,
                    line: 4154,
                    prev_card: prev_card
                };
                break;
            }
        } else if (diamonds.includes(current_card)) {
            if (diamonds.includes(prev_card)) {
                play_allowed = true;
                if (k === pll - 1) {
                    action = {
                        fine: 'none',
                        play_allowed: 'true',
                        to_fine: 'none',
                        next_player: to_play,
                        card_requests: card_request,
                        card_requested: card_requested,
                        last_play_cards: player_cards,
                        kadi: kadi,
                        cardless: cardless,
                        line: 4174,
                        prev_card: prev_card
                    };
                }
            } else {
                action = {
                    fine: '1',
                    play_allowed: 'false',
                    to_fine: 'self',
                    next_player: to_play,
                    card_requests: card_request,
                    card_requested: card_requested,
                    last_play_cards: player_cards,
                    kadi: kadi,
                    cardless: cardless,
                    line: 4189,
                    prev_card: prev_card
                };
                break;
            }
        } else if (flowers.includes(current_card)) {
            if (flowers.includes(prev_card)) {
                play_allowed = true;
                if (k === pll - 1) {
                    action = {
                        fine: 'none',
                        play_allowed: 'true',
                        to_fine: 'none',
                        next_player: to_play,
                        card_requests: card_request,
                        card_requested: card_requested,
                        last_play_cards: player_cards,
                        kadi: kadi,
                        cardless: cardless,
                        line: 4210,
                        prev_card: prev_card
                    };
                }
            } else {
                action = {
                    fine: '1',
                    play_allowed: 'false',
                    to_fine: 'self',
                    next_player: to_play,
                    card_requests: card_request,
                    card_requested: card_requested,
                    last_play_cards: player_cards,
                    kadi: kadi,
                    cardless: cardless,
                    line: 4225,
                    prev_card: prev_card
                };
                break;
            }
        } else if (spades.includes(current_card)) {
            if (spades.includes(prev_card)) {
                play_allowed = true;
                if (k === pll - 1) {
                    action = {
                        fine: 'none',
                        play_allowed: 'true',
                        to_fine: 'none',
                        next_player: to_play,
                        card_requests: card_request,
                        card_requested: card_requested,
                        last_play_cards: player_cards,
                        kadi: kadi,
                        cardless: cardless,
                        line: 4245,
                        prev_card: prev_card
                    };
                }
            } else {
                action = {
                    fine: '1',
                    play_allowed: 'false',
                    to_fine: 'self',
                    next_player: to_play,
                    card_requests: card_request,
                    card_requested: card_requested,
                    last_play_cards: player_cards,
                    kadi: kadi,
                    cardless: cardless,
                    line: 4260,
                    prev_card: prev_card
                };
                break;
            }
        }
    }
}


if ([50, 51, 52, 53].includes(current_card)) {
    if ([50, 51, 52, 53, 28, 29].includes(prev_card)) {
        play_allowed = true;
        card_ask_perm = true;

        if (k === pll - 1) {
            action = {
                fine: 'none',
                play_allowed: 'true',
                to_fine: 'none',
                next_player: to_play,
                card_requests: card_request,
                card_requested: card_requested,
                last_play_cards: player_cards,
                kadi: kadi,
                cardless: cardless,
                line: 4298,
                prev_card: prev_card
            };
        }
    } else {
        if (hearts.includes(current_card)) {
            if (hearts.includes(prev_card)) {
                play_allowed = true;
                if (k === pll - 1) {
                    action = {
                        fine: 'none',
                        play_allowed: 'true',
                        to_fine: 'none',
                        next_player: to_play,
                        card_requests: card_request,
                        card_requested: card_requested,
                        last_play_cards: player_cards,
                        kadi: kadi,
                        cardless: cardless,
                        line: 4321,
                        prev_card: prev_card
                    };
                }
            } else {
                action = {
                    fine: '1',
                    play_allowed: 'false',
                    to_fine: 'self',
                    next_player: to_play,
                    card_requests: card_request,
                    card_requested: card_requested,
                    last_play_cards: player_cards,
                    kadi: kadi,
                    cardless: cardless,
                    line: 4336,
                    prev_card: prev_card
                };
                break;
            }
        } else if (diamonds.includes(current_card)) {
            if (diamonds.includes(prev_card)) {
                play_allowed = true;
                if (k === pll - 1) {
                    action = {
                        fine: 'none',
                        play_allowed: 'true',
                        to_fine: 'none',
                        next_player: to_play,
                        card_requests: card_request,
                        card_requested: card_requested,
                        last_play_cards: player_cards,
                        kadi: kadi,
                        cardless: cardless,
                        line: 4356,
                        prev_card: prev_card
                    };
                }
            } else {
                action = {
                    fine: '1',
                    play_allowed: 'false',
                    to_fine: 'self',
                    next_player: to_play,
                    card_requests: card_request,
                    card_requested: card_requested,
                    last_play_cards: player_cards,
                    kadi: kadi,
                    cardless: cardless,
                    line: 4371,
                    prev_card: prev_card
                };
                break;
            }
        } else if (flowers.includes(current_card)) {
            if (flowers.includes(prev_card)) {
                play_allowed = true;
                if (k === pll - 1) {
                    action = {
                        fine: 'none',
                        play_allowed: 'true',
                        to_fine: 'none',
                        next_player: to_play,
                        card_requests: card_request,
                        card_requested: card_requested,
                        last_play_cards: player_cards,
                        kadi: kadi,
                        cardless: cardless,
                        line: 4392,
                        prev_card: prev_card
                    };
                }
            } else {
                action = {
                    fine: '1',
                    play_allowed: 'false',
                    to_fine: 'self',
                    next_player: to_play,
                    card_requests: card_request,
                    card_requested: card_requested,
                    last_play_cards: player_cards,
                    kadi: kadi,
                    cardless: cardless,
                    line: 4407,
                    prev_card: prev_card
                };
                break;
            }
        } else if (spades.includes(current_card)) {
            if (spades.includes(prev_card)) {
                play_allowed = true;
                if (k === pll - 1) {
                    action = {
                        fine: 'none',
                        play_allowed: 'true',
                        to_fine: 'none',
                        next_player: to_play,
                        card_requests: card_request,
                        card_requested: card_requested,
                        last_play_cards: player_cards,
                        kadi: kadi,
                        cardless: cardless,
                        line: 4427,
                        prev_card: prev_card
                    };
                }
            } else {
                action = {
                    fine: '1',
                    play_allowed: 'false',
                    to_fine: 'self',
                    next_player: to_play,
                    card_requests: card_request,
                    card_requested: card_requested,
                    last_play_cards: player_cards,
                    kadi: kadi,
                    cardless: cardless,
                    line: 4442,
                    prev_card: prev_card
                };
                break;
            }
        }
    }
}






    }

  }
else{
//second card

let prev_card = parseInt(player_play[k - 1]);

if ([0, 1, 2, 3].includes(prev_card)) {
    if ([0, 1, 2, 3].includes(current_card)) {
        play_allowed = false;

        action = {
            fine: 'none',
            play_allowed: 'false',
            to_fine: 'none',
            next_player: to_play,
            card_requests: card_request,
            card_requested: card_requested,
            last_play_cards: player_cards,
            kadi: kadi,
            cardless: cardless,
            line: 4495,
            prev_card: prev_card,
        };
    } else {
        action = {
            fine: '1',
            play_allowed: 'false',
            to_fine: 'self',
            next_player: to_play,
            card_requests: card_request,
            card_requested: card_requested,
            last_play_cards: player_cards,
            kadi: kadi,
            cardless: cardless,
            line: 4509,
            prev_card: prev_card,
        };
        break;
    }
}

if ([4, 5, 6, 7].includes(prev_card)) {
    if ([4, 5, 6, 7].includes(current_card)) {
        play_allowed = true;
        card_ask_perm = true;
        let ps = players.length - 1;

        let op = players[0];
        players.shift(); // Removes the first player
        players.reverse(); // Reverses the array
        players.push(op); // Adds the original first player back

        to_play = players[ps];
        if (k === pll - 1) {
            action = {
                fine: 'none',
                play_allowed: 'true',
                to_fine: 'none',
                next_player: to_play,
                card_requests: card_request,
                card_requested: card_requested,
                last_play_cards: player_cards,
                kadi: kadi,
                cardless: cardless,
                line: 4544,
                prev_card: prev_card,
            };
        }
    } else {
        action = {
            fine: '1',
            play_allowed: 'false',
            to_fine: 'self',
            next_player: to_play,
            card_requests: card_request,
            card_requested: card_requested,
            last_play_cards: player_cards,
            kadi: kadi,
            cardless: cardless,
            line: 4562,
            prev_card: prev_card,
        };
        break;
    }
}

if ([8, 9, 10, 11].includes(prev_card)) {
    if ([8, 9, 10, 11].includes(current_card)) {
        let pl = players.length;
        let lp = players[pl - 1];
        let current_player = players[pl - 1];
        players.pop(); // Removes the last player
        players.unshift(lp); // Adds the last player to the front

        to_play = players[pl - 1];

        play_allowed = true;
        card_ask_perm = true;
        if (k === pll - 1) {
            action = {
                fine: 'none',
                play_allowed: 'true',
                to_fine: 'none',
                next_player: to_play,
                card_requests: card_request,
                card_requested: card_requested,
                last_play_cards: player_cards,
                kadi: kadi,
                cardless: cardless,
                line: 4602,
                prev_card: prev_card,
            };
        }
    } else {
        play_allowed = false;

        action = {
            fine: '1',
            play_allowed: 'false',
            to_fine: 'self',
            next_player: to_play,
            card_requests: card_request,
            card_requested: card_requested,
            last_play_cards: player_cards,
            kadi: kadi,
            cardless: cardless,
            line: 4626,
            prev_card: prev_card,
        };
        break;
    }
}

if ([12, 13, 14, 15].includes(prev_card)) {
    if ([12, 13, 14, 15].includes(current_card)) {
        play_allowed = true;
        card_ask_perm = true;
        if (k === pll - 1) {
            action = {
                fine: 'none',
                play_allowed: 'true',
                to_fine: 'none',
                next_player: to_play,
                card_requests: card_request,
                card_requested: card_requested,
                last_play_cards: player_cards,
                kadi: kadi,
                cardless: cardless,
                line: 4655,
                prev_card: prev_card,
            };
        }
    } else {
        if (hearts.includes(prev_card)) {
            if (allowed_q_hearts.includes(current_card)) {
                play_allowed = true;
                question_allowed = false;

                if (k === pll - 1) {
                    action = {
                        fine: 'none',
                        play_allowed: 'true',
                        to_fine: 'none',
                        next_player: to_play,
                        card_requests: card_request,
                        card_requested: card_requested,
                        last_play_cards: player_cards,
                        kadi: kadi,
                        cardless: cardless,
                        line: 4679,
                        prev_card: prev_card,
                    };
                }
            } else {
                action = {
                    fine: '1',
                    play_allowed: 'false',
                    to_fine: 'self',
                    next_player: to_play,
                    card_requests: card_request,
                    card_requested: card_requested,
                    last_play_cards: player_cards,
                    kadi: kadi,
                    cardless: cardless,
                    line: 4698,
                    prev_card: prev_card,
                };
                break;
            }
        } else if (diamonds.includes(prev_card)) {
            if (allowed_q_diamonds.includes(current_card)) {
                play_allowed = true;
                question_allowed = false;

                if (k === pll - 1) {
                    action = {
                        fine: 'none',
                        play_allowed: 'true',
                        to_fine: 'none',
                        next_player: to_play,
                        card_requests: card_request,
                        card_requested: card_requested,
                        last_play_cards: player_cards,
                        kadi: kadi,
                        cardless: cardless,
                        line: 4720,
                        prev_card: prev_card,
                    };
                }
            } else {
                action = {
                    fine: '1',
                    play_allowed: 'false',
                    to_fine: 'self',
                    next_player: to_play,
                    card_requests: card_request,
                    card_requested: card_requested,
                    last_play_cards: player_cards,
                    kadi: kadi,
                    cardless: cardless,
                    line: 4739,
                    prev_card: prev_card,
                };
                break;
            }
        } else if (flowers.includes(prev_card)) {
            if (allowed_q_flowers.includes(current_card)) {
                play_allowed = true;
                question_allowed = false;

                if (k === pll - 1) {
                    action = {
                        fine: 'none',
                        play_allowed: 'true',
                        to_fine: 'none',
                        next_player: to_play,
                        card_requests: card_request,
                        card_requested: card_requested,
                        last_play_cards: player_cards,
                        kadi: kadi,
                        cardless: cardless,
                        line: 4761,
                        prev_card: prev_card,
                    };
                }
            } else {
                action = {
                    fine: '1',
                    play_allowed: 'false',
                    to_fine: 'self',
                    next_player: to_play,
                    card_requests: card_request,
                    card_requested: card_requested,
                    last_play_cards: player_cards,
                    kadi: kadi,
                    cardless: cardless,
                    line: 4779,
                    prev_card: prev_card,
                };
                break;
            }
        } else if (spades.includes(prev_card)) {
            if (allowed_q_spades.includes(current_card)) {
                play_allowed = true;
                question_allowed = false;

                if (k === pll - 1) {
                    action = {
                        fine: 'none',
                        play_allowed: 'true',
                        to_fine: 'none',
                        next_player: to_play,
                        card_requests: card_request,
                        card_requested: card_requested,
                        last_play_cards: player_cards,
                        kadi: kadi,
                        cardless: cardless,
                        line: 4802,
                        prev_card: prev_card,
                    };
                }
            } else {
                action = {
                    fine: '1',
                    play_allowed: 'false',
                    to_fine: 'self',
                    next_player: to_play,
                    card_requests: card_request,
                    card_requested: card_requested,
                    last_play_cards: player_cards,
                    kadi: kadi,
                    cardless: cardless,
                    line: 4823,
                    prev_card: prev_card,
                };
                break;
            }
        }
    }
}



if ([16, 17, 18, 19].includes(prev_card)) {
    if ([16, 17, 18, 19].includes(current_card)) {
        play_allowed = true;
        card_ask_perm = true;

        if (k === pll - 1) {
            action = {
                fine: 'none',
                play_allowed: 'true',
                to_fine: 'none',
                next_player: to_play,
                card_requests: card_request,
                card_requested: card_requested,
                last_play_cards: player_cards,
                kadi: kadi,
                cardless: cardless,
                line: 4856,
                prev_card: prev_card
            };
        }
    } else {
        if (hearts.includes(prev_card)) {
            if (allowed_8_hearts.includes(current_card)) {
                play_allowed = true;
                question_allowed = false;

                if (k === pll - 1) {
                    action = {
                        fine: 'none',
                        play_allowed: 'true',
                        to_fine: 'none',
                        next_player: to_play,
                        card_requests: card_request,
                        card_requested: card_requested,
                        last_play_cards: player_cards,
                        kadi: kadi,
                        cardless: cardless,
                        line: 4882,
                        prev_card: prev_card
                    };
                }
            } else {
                action = {
                    fine: '1',
                    play_allowed: 'false',
                    to_fine: 'self',
                    next_player: to_play,
                    card_requests: card_request,
                    card_requested: card_requested,
                    last_play_cards: player_cards,
                    kadi: kadi,
                    cardless: cardless,
                    line: 4899,
                    prev_card: prev_card
                };
                break;
            }
        } else if (diamonds.includes(prev_card)) {
            if (allowed_8_diamonds.includes(current_card)) {
                play_allowed = true;
                question_allowed = false;

                if (k === pll - 1) {
                    action = {
                        fine: 'none',
                        play_allowed: 'true',
                        to_fine: 'none',
                        next_player: to_play,
                        card_requests: card_request,
                        card_requested: card_requested,
                        last_play_cards: player_cards,
                        kadi: kadi,
                        cardless: cardless,
                        line: 4924,
                        prev_card: prev_card
                    };
                }
            } else {
                action = {
                    fine: '1',
                    play_allowed: 'false',
                    to_fine: 'self',
                    next_player: to_play,
                    card_requests: card_request,
                    card_requested: card_requested,
                    last_play_cards: player_cards,
                    kadi: kadi,
                    cardless: cardless,
                    line: 4942,
                    prev_card: prev_card
                };
                break;
            }
        } else if (flowers.includes(prev_card)) {
            if (allowed_8_flowers.includes(current_card)) {
                play_allowed = true;
                question_allowed = false;

                if (k === pll - 1) {
                    action = {
                        fine: 'none',
                        play_allowed: 'true',
                        to_fine: 'none',
                        next_player: to_play,
                        card_requests: card_request,
                        card_requested: card_requested,
                        last_play_cards: player_cards,
                        kadi: kadi,
                        cardless: cardless,
                        line: 4967,
                        prev_card: prev_card
                    };
                }
            } else {
                action = {
                    fine: '1',
                    play_allowed: 'false',
                    to_fine: 'self',
                    next_player: to_play,
                    card_requests: card_request,
                    card_requested: card_requested,
                    last_play_cards: player_cards,
                    kadi: kadi,
                    cardless: cardless,
                    line: 4984,
                    prev_card: prev_card
                };
                break;
            }
        } else if (spades.includes(prev_card)) {
            if (allowed_8_spades.includes(current_card)) {
                play_allowed = true;
                question_allowed = false;

                if (k === pll - 1) {
                    action = {
                        fine: 'none',
                        play_allowed: 'true',
                        to_fine: 'none',
                        next_player: to_play,
                        card_requests: card_request,
                        card_requested: card_requested,
                        last_play_cards: player_cards,
                        kadi: kadi,
                        cardless: cardless,
                        line: 5008,
                        prev_card: prev_card
                    };
                }
            } else {
                action = {
                    fine: '1',
                    play_allowed: 'false',
                    to_fine: 'self',
                    next_player: to_play,
                    card_requests: card_request,
                    card_requested: card_requested,
                    last_play_cards: player_cards,
                    kadi: kadi,
                    cardless: cardless,
                    line: 5027,
                    prev_card: prev_card
                };
                break;
            }
        }
    }
}

if ([20, 21, 22, 23].includes(prev_card)) {
    if ([20, 21, 22, 23, 28, 29].includes(current_card)) {
        play_allowed = true;
        card_ask_perm = true;

        if (k === pll - 1) {
            let fine = 2;
            if (current_card === 28 || current_card === 29) {
                fine = 5;
            }
            action = {
                fine: fine,
                play_allowed: 'true',
                to_fine: to_play,
                next_player: to_play,
                card_requests: card_request,
                card_requested: card_requested,
                last_play_cards: player_cards,
                kadi: kadi,
                cardless: cardless,
                line: 5068,
                prev_card: prev_card
            };
        }
    } else {
        if (hearts.includes(prev_card)) {
            if (allowed_2_hearts.includes(current_card)) {
                play_allowed = true;
                if (k === pll - 1) {
                    let fine = 3;

                    action = {
                        fine: fine,
                        play_allowed: 'true',
                        to_fine: to_play,
                        next_player: to_play,
                        card_requests: card_request,
                        card_requested: card_requested,
                        last_play_cards: player_cards,
                        kadi: kadi,
                        cardless: cardless,
                        line: 5100,
                        prev_card: prev_card
                    };
                }
            } else {
                action = {
                    fine: '1',
                    play_allowed: 'false',
                    to_fine: 'self',
                    next_player: to_play,
                    card_requests: card_request,
                    card_requested: card_requested,
                    last_play_cards: player_cards,
                    kadi: kadi,
                    cardless: cardless,
                    line: 5117,
                    prev_card: prev_card
                };
                break;
            }
        } else if (diamonds.includes(prev_card)) {
            if (allowed_2_diamonds.includes(current_card)) {
                play_allowed = true;
                if (k === pll - 1) {
                    let fine = 3;

                    action = {
                        fine: fine,
                        play_allowed: 'true',
                        to_fine: to_play,
                        next_player: to_play,
                        card_requests: card_request,
                        card_requested: card_requested,
                        last_play_cards: player_cards,
                        kadi: kadi,
                        cardless: cardless,
                        line: 5141,
                        prev_card: prev_card
                    };
                }
            } else {
                action = {
                    fine: '1',
                    play_allowed: 'false',
                    to_fine: 'self',
                    next_player: to_play,
                    card_requests: card_request,
                    card_requested: card_requested,
                    last_play_cards: player_cards,
                    kadi: kadi,
                    cardless: cardless,
                    line: 5157,
                    prev_card: prev_card
                };
                break;
            }
        } else if (flowers.includes(prev_card)) {
            if (allowed_2_flowers.includes(current_card)) {
                play_allowed = true;
                if (k === pll - 1) {
                    let fine = 3;

                    action = {
                        fine: fine,
                        play_allowed: 'true',
                        to_fine: to_play,
                        next_player: to_play,
                        card_requests: card_request,
                        card_requested: card_requested,
                        last_play_cards: player_cards,
                        kadi: kadi,
                        cardless: cardless,
                        line: 5182,
                        prev_card: prev_card
                    };
                }
            } else {
                action = {
                    fine: '1',
                    play_allowed: 'false',
                    to_fine: 'self',
                    next_player: to_play,
                    card_requests: card_request,
                    card_requested: card_requested,
                    last_play_cards: player_cards,
                    kadi: kadi,
                    cardless: cardless,
                    line: 5198,
                    prev_card: prev_card
                };
                break;
            }
        } else if (spades.includes(prev_card)) {
            if (allowed_2_spades.includes(current_card)) {
                play_allowed = true;
                if (k === pll - 1) {
                    let fine = 3;

                    action = {
                        fine: fine,
                        play_allowed: 'true',
                        to_fine: to_play,
                        next_player: to_play,
                        card_requests: card_request,
                        card_requested: card_requested,
                        last_play_cards: player_cards,
                        kadi: kadi,
                        cardless: cardless,
                        line: 5224,
                        prev_card: prev_card
                    };
                }
            } else {
                action = {
                    fine: '1',
                    play_allowed: 'false',
                    to_fine: 'self',
                    next_player: to_play,
                    card_requests: card_request,
                    card_requested: card_requested,
                    last_play_cards: player_cards,
                    kadi: kadi,
                    cardless: cardless,
                    line: 5240,
                    prev_card: prev_card
                };
                break;
            }
        }
    }
}


if ([24, 25, 26, 27].includes(prev_card)) {
    if ([24, 25, 26, 27, 28, 29].includes(current_card)) {
        play_allowed = true;
        card_ask_perm = true;

        if (k === pll - 1) {
            fine = 3;
            action = {
                fine: fine,
                play_allowed: 'true',
                to_fine: to_play,
                next_player: to_play,
                card_requests: card_request,
                card_requested: card_requested,
                last_play_cards: player_cards,
                kadi: kadi,
                cardless: cardless,
                line: 5280,
                prev_card: prev_card
            };
        }
    } else {
        if (hearts.includes(prev_card)) {
            if (allowed_3_hearts.includes(current_card)) {
                play_allowed = true;
                if (k === pll - 1) {
                    fine = 2;
                    action = {
                        fine: fine,
                        play_allowed: 'true',
                        to_fine: to_play,
                        next_player: to_play,
                        card_requests: card_request,
                        card_requested: card_requested,
                        last_play_cards: player_cards,
                        kadi: kadi,
                        cardless: cardless,
                        line: 5310,
                        prev_card: prev_card
                    };
                }
            } else {
                action = {
                    fine: '1',
                    play_allowed: 'false',
                    to_fine: 'self',
                    next_player: to_play,
                    card_requests: card_request,
                    card_requested: card_requested,
                    last_play_cards: player_cards,
                    kadi: kadi,
                    cardless: cardless,
                    line: 5327,
                    prev_card: prev_card
                };
                break;
            }
        } else if (diamonds.includes(prev_card)) {
            if (allowed_3_diamonds.includes(current_card)) {
                play_allowed = true;
                if (k === pll - 1) {
                    fine = 2;
                    action = {
                        fine: fine,
                        play_allowed: 'true',
                        to_fine: to_play,
                        next_player: to_play,
                        card_requests: card_request,
                        card_requested: card_requested,
                        last_play_cards: player_cards,
                        kadi: kadi,
                        cardless: cardless,
                        line: 5352,
                        prev_card: prev_card
                    };
                }
            } else {
                action = {
                    fine: '1',
                    play_allowed: 'false',
                    to_fine: 'self',
                    next_player: to_play,
                    card_requests: card_request,
                    card_requested: card_requested,
                    last_play_cards: player_cards,
                    kadi: kadi,
                    cardless: cardless,
                    line: 5370,
                    prev_card: prev_card
                };
                break;
            }
        } else if (flowers.includes(prev_card)) {
            if (allowed_3_flowers.includes(current_card)) {
                play_allowed = true;
                if (k === pll - 1) {
                    fine = 2;
                    action = {
                        fine: fine,
                        play_allowed: 'true',
                        to_fine: to_play,
                        next_player: to_play,
                        card_requests: card_request,
                        card_requested: card_requested,
                        last_play_cards: player_cards,
                        kadi: kadi,
                        cardless: cardless,
                        line: 5396,
                        prev_card: prev_card
                    };
                }
            } else {
                action = {
                    fine: '1',
                    play_allowed: 'false',
                    to_fine: 'self',
                    next_player: to_play,
                    card_requests: card_request,
                    card_requested: card_requested,
                    last_play_cards: player_cards,
                    kadi: kadi,
                    cardless: cardless,
                    line: 5412,
                    prev_card: prev_card
                };
                break;
            }
        } else if (spades.includes(prev_card)) {
            if (allowed_3_spades.includes(current_card)) {
                play_allowed = true;
                if (k === pll - 1) {
                    fine = 2;
                    action = {
                        fine: fine,
                        play_allowed: 'true',
                        to_fine: to_play,
                        next_player: to_play,
                        card_requests: card_request,
                        card_requested: card_requested,
                        last_play_cards: player_cards,
                        kadi: kadi,
                        cardless: cardless,
                        line: 5436,
                        prev_card: prev_card
                    };
                }
            } else {
                action = {
                    fine: '1',
                    play_allowed: 'false',
                    to_fine: 'self',
                    next_player: to_play,
                    card_requests: card_request,
                    card_requested: card_requested,
                    last_play_cards: player_cards,
                    kadi: kadi,
                    cardless: cardless,
                    line: 5453,
                    prev_card: prev_card
                };
                break;
            }
        }
    }
}

if ([28, 29].includes(prev_card)) {
    if ([20, 21, 22, 23].includes(current_card)) {
        if (k === pll - 1) {
            fine = 2;
            action = {
                fine: fine,
                play_allowed: 'true',
                to_fine: to_play,
                next_player: to_play,
                card_requests: card_request,
                card_requested: card_requested,
                last_play_cards: player_cards,
                kadi: kadi,
                cardless: cardless,
                line: 5489,
                prev_card: prev_card
            };
        }
        play_allowed = true;
    } else if ([24, 25, 26, 27].includes(current_card)) {
        if (k === pll - 1) {
            fine = 3;
            action = {
                fine: fine,
                play_allowed: 'true',
                to_fine: to_play,
                next_player: to_play,
                card_requests: card_request,
                card_requested: card_requested,
                last_play_cards: player_cards,
                kadi: kadi,
                cardless: cardless,
                line: 5507,
                prev_card: prev_card
            };
        }
        play_allowed = true;
    } else if ([28, 29].includes(current_card)) {
        if (k === pll - 1) {
            fine = 5;
            action = {
                fine: fine,
                play_allowed: 'true',
                to_fine: to_play,
                next_player: to_play,
                card_requests: card_request,
                card_requested: card_requested,
                last_play_cards: player_cards,
                kadi: kadi,
                cardless: cardless,
                line: 5526,
                prev_card: prev_card
            };
        }
        play_allowed = true;
    } else {
        action = {
            fine: '1',
            play_allowed: 'false',
            to_fine: 'self',
            next_player: to_play,
            card_requests: card_request,
            card_requested: card_requested,
            last_play_cards: player_cards,
            kadi: kadi,
            cardless: cardless,
            line: 5543,
            prev_card: prev_card
        };
        break;
    }
}


if ([30, 31, 32, 33].includes(prev_card)) {
    if ([30, 31, 32, 33].includes(current_card)) {
        play_allowed = true;
        card_ask_perm = true;

        if (k === pll - 1) {
            action = {
                fine: 'none',
                play_allowed: 'true',
                to_fine: 'none',
                next_player: to_play,
                card_requests: card_request,
                card_requested: card_requested,
                last_play_cards: player_cards,
                kadi: kadi,
                cardless: cardless,
                line: 5569,
                prev_card: prev_card,
            };
        }
    } else {
        action = {
            fine: '1',
            play_allowed: 'false',
            to_fine: 'none',
            next_player: to_play,
            card_requests: card_request,
            card_requested: card_requested,
            last_play_cards: player_cards,
            kadi: kadi,
            cardless: cardless,
            line: 5589,
            prev_card: prev_card,
        };
    }
}

if ([34, 35, 36, 37].includes(prev_card)) {
    if ([34, 35, 36, 37].includes(current_card)) {
        if (k === pll - 1) {
            action = {
                fine: 'none',
                play_allowed: 'true',
                to_fine: 'none',
                next_player: to_play,
                card_requests: card_request,
                card_requested: card_requested,
                last_play_cards: player_cards,
                kadi: kadi,
                cardless: cardless,
                line: 5610,
                prev_card: prev_card,
            };
        }
        play_allowed = true;
        card_ask_perm = true;
    } else {
        action = {
            fine: '1',
            play_allowed: 'false',
            to_fine: 'self',
            next_player: to_play,
            card_requests: card_request,
            card_requested: card_requested,
            last_play_cards: player_cards,
            kadi: kadi,
            cardless: cardless,
            line: 5629,
            prev_card: prev_card,
        };
        break;
    }
}

if ([38, 39, 40, 41].includes(prev_card)) {
    if ([38, 39, 40, 41].includes(current_card)) {
        if (k === pll - 1) {
            action = {
                fine: 'none',
                play_allowed: 'true',
                to_fine: 'none',
                next_player: to_play,
                card_requests: card_request,
                card_requested: card_requested,
                last_play_cards: player_cards,
                kadi: kadi,
                cardless: cardless,
                line: 5658,
                prev_card: prev_card,
            };
        }
        play_allowed = true;
        card_ask_perm = true;
    } else {
        action = {
            fine: '1',
            play_allowed: 'false',
            to_fine: 'none',
            next_player: to_play,
            card_requests: card_request,
            card_requested: card_requested,
            last_play_cards: player_cards,
            kadi: kadi,
            cardless: cardless,
            line: 5676,
            prev_card: prev_card,
        };
    }
}

if ([42, 43, 44, 45].includes(prev_card)) {
    if ([42, 43, 44, 45].includes(current_card)) {
        if (k === pll - 1) {
            action = {
                fine: 'none',
                play_allowed: 'true',
                to_fine: 'none',
                next_player: to_play,
                card_requests: card_request,
                card_requested: card_requested,
                last_play_cards: player_cards,
                kadi: kadi,
                cardless: cardless,
                line: 5699,
                prev_card: prev_card,
            };
        }
        play_allowed = true;
        card_ask_perm = true;
    } else {
        action = {
            fine: '1',
            play_allowed: 'false',
            to_fine: 'none',
            next_player: to_play,
            card_requests: card_request,
            card_requested: card_requested,
            last_play_cards: player_cards,
            kadi: kadi,
            cardless: cardless,
            line: 5719,
            prev_card: prev_card,
        };
    }
}

if ([46, 47, 48, 49].includes(prev_card)) {
    if ([46, 47, 48, 49].includes(current_card)) {
        if (k === pll - 1) {
            action = {
                fine: 'none',
                play_allowed: 'true',
                to_fine: 'none',
                next_player: to_play,
                card_requests: card_request,
                card_requested: card_requested,
                last_play_cards: player_cards,
                kadi: kadi,
                cardless: cardless,
                line: 5747,
                prev_card: prev_card,
            };
        }
        play_allowed = true;
        card_ask_perm = true;
    } else {
        action = {
            fine: '1',
            play_allowed: 'false',
            to_fine: 'self',
            next_player: to_play,
            card_requests: card_request,
            card_requested: card_requested,
            last_play_cards: player_cards,
            kadi: kadi,
            cardless: cardless,
            line: 5764,
            prev_card: prev_card,
        };
        break;
    }
}

if ([50, 51, 52, 53].includes(prev_card)) {
    if ([50, 51, 52, 53].includes(current_card)) {
        if (k === pll - 1) {
            action = {
                fine: 'none',
                play_allowed: 'true',
                to_fine: 'none',
                next_player: to_play,
                card_requests: card_request,
                card_requested: card_requested,
                last_play_cards: player_cards,
                kadi: kadi,
                cardless: cardless,
                line: 5789,
                prev_card: prev_card,
            };
        }
        play_allowed = true;
        card_ask_perm = true;
    } else {
        action = {
            fine: '1',
            play_allowed: 'false',
            to_fine: 'self',
            next_player: to_play,
            card_requests: card_request,
            card_requested: card_requested,
            last_play_cards: player_cards,
            kadi: kadi,
            cardless: cardless,
            line: 5807,
            prev_card: prev_card,
        };
        break;
    }
}






}//end of second card





}//end of else for non pick











// Simulating database retrieval with LocalStorage
const query1 = JSON.parse(localStorage.getItem('challenge_registration')) || [];
//player_play = JSON.parse(localStorage.getItem('player_play')) || [];
//const action = JSON.parse(localStorage.getItem('action')) || {};

let all_cards = [];
let all_playing_cards = Array.from(Array(54).keys()); // [0, 1, 2, ..., 53]
    
    let playerCards1 = (JSON.parse(localStorage.getItem('registrationData1'))).my_cards;
    let playerCards2 = (JSON.parse(localStorage.getItem('registrationData2'))).my_cards;
    all_cards = all_cards.concat(JSON.parse(playerCards1));
    all_cards = all_cards.concat(JSON.parse(playerCards2));

// Merge cards from other players
/*query1.forEach(q1 => {
    if (q1.userID !== user_id) {
        all_cards = all_cards.concat(JSON.parse(q1.my_cards));
    }
});
*/
// Update all_cards based on action
/*if (action.play_allowed === true) {
    const sp = player_play.length;
    all_cards.push(player_play[sp - 1]);
    all_cards = all_cards.concat(JSON.parse(localStorage.getItem('player_cards')) || []);
} else {
    const last_play = JSON.parse(localStorage.getItem('last_play'));
    all_cards.push(last_play);
    all_cards = all_cards.concat(JSON.parse(localStorage.getItem('player_cards')) || []);
}

// Remove used cards from all_playing_cards
all_cards.forEach(alc => {
    const ack = all_playing_cards.indexOf(alc);
    if (ack !== -1) {
        all_playing_cards.splice(ack, 1);
    }
});*/

// Update ready_cards
//ready_cards = all_playing_cards.slice();
console.log(user_id)
let tri = JSON.parse(localStorage.getItem('kadi_plays'))

let o_p = tri.last_play[0] == '[' ? JSON.parse(tri.last_play):tri.last_play;
last_play = o_p || [];
cardless_status = tri.cardless_status || [];
kadi_status = tri.kadi_status || '[]';//JSON.parse(o_plays.kadi_status || '[]');

let end_status = ''; // You can adjust this as needed
console.log(cardless_status== 0);
console.log(kadi_status.includes(user_id));
console.log(action.play_allowed);
console.log(player_play.length== 1);
console.log(player_cards.length ==0);
console.log(cardless_status.length == 0 && (action.play_allowed == true || action.play_allowed == 'true')&& kadi_status.includes(user_id) && player_play.length == 1 && player_cards.length ==0);
if (cardless_status.length == 0 && (action.play_allowed == true || action.play_allowed == 'true') && kadi_status.includes(user_id) && player_play.length === 1 && player_cards.length ===0) {
    
    const o_plays1 = last_play;
    
    o_plays1.push({
        player: user_id,
        play: JSON.stringify(player_play),
        player_fined: action.fine,
        play_allowed: action.play_allowed,
        to_fine: action.to_fine,
        next_player: action.next_player,
        card_requests: action.card_requests,
        card_requested: action.card_requested,
        game_end: true,
        kadi: action.kadi,
        cardless: action.cardless
    });

    action.game_end = 'true';
    action.game_winner = user_id != 19 ||user_id != '19'? getFullnameByID('registrationData2') : getFullnameByID('registrationData1'); // Implement this function to get the full name

    // Update LocalStorage
    tri.last_play = JSON.stringify(o_plays1);
    tri.ready_cards = JSON.stringify(ready_cards);
    tri.play_status = 'complete';
    tri.players = JSON.stringify(players);
    tri.playing = action.next_player;

    localStorage.setItem('kadi_plays', JSON.stringify(tri));
     if(user_id == 19 || user_id =='19'){
    localStorage.setItem('registrationData1', JSON.stringify({
        ...JSON.parse(localStorage.getItem('registrationData1')),
        my_cards: JSON.stringify(player_cards) // Clear cards for user
    }));}
    else{
        localStorage.setItem('registrationData2', JSON.stringify({
        ...JSON.parse(localStorage.getItem('registrationData2')),
        my_cards: JSON.stringify(player_cards) // Clear cards for user
    }));
    }

    // Update duel status
    localStorage.setItem('duel', JSON.stringify({
        ...JSON.parse(localStorage.getItem('duel')),
        winner: user_id,
        status: 'complete'
    }));

    // Handle next player logic
    let action_d = {};
    
        action_d = { ...action, ready_cards: ready_cards };
    

    if (user_id != 19) {
       await updateLeaderboard(user_id, 10);
        return (JSON.stringify(action_d)); // Adjust output as necessary
    }


}
else{




let o_plays1 = last_play;
    let fined_card = null;
    if (action.fine == 1) {
        fined_card = ready_cards[ready_cards.length - 1];
        ready_cards.pop();
    }





const  o_plays1L =  o_plays1.length;
    o_plays1[ o_plays1L]={
        player: user_id,
        play: player_play,
        player_fined: action.fine,
        play_allowed: action.play_allowed,
        to_fine: action.to_fine,
        next_player: action.next_player,
        card_request: action.card_requests,
        card_requested: action.card_requested,
        kadi: action.kadi,
        cardless: action.cardless
    };
console.log( o_plays1);
    action.fined_card = fined_card;
    const cd = cardless_status || [];

   // if (!(JSON.parse(localStorage.getItem('registrationData2')).my_cards).length) {
    if (action.cardless == 'true' || action.cardless == true) {
        if (!cd.includes(user_id)) {
            cd.push(user_id);
        }
    } else {
        if (cd.includes(user_id)) {
            console.log(cd);
            cd.splice(cd.indexOf(user_id), 1);
        }
    }

    const kds1 = kadi_status || [];
console.log(kds1);
    if ((action.kadi == 'true' ||action.kadi == true ) && (action.cardless == 'false' || action.cardless == false)) {
        if (!kds1.includes(user_id)) {
            kds1.push(user_id);
        }
    } else {
        if (kds1.includes(user_id)) {
            kds1.splice(kds1.indexOf(user_id));
        }
    }
    console.log(action.cardless);
console.log(cd);

console.log(kds1);
    // Update LocalStorage for current plays
    tri.ready_cards = JSON.stringify(ready_cards);
    tri.play_status = 'playing';
    tri.cardless_status = cd;
    tri.kadi_status = kds1;
    tri.playing = action.next_player;
    tri.last_play = o_plays1;
    tri.game_end = 'false';
    tri.players= players;

/*$this->db->where('duel_id',$duel_id)->update('kadi_plays',['ready_cards'=>json_encode($ready_cards),'play_status'=>'playing','players'=>json_encode($players),'cardless_status'=>json_encode($cdl),'kadi_status'=>json_encode($kds),'playing'=>$action['next_player'],'last_play'=>json_encode($o_plays1),'game_end'=>'false']);*/


    // Save initial data to localStorage
//    localStorage.setItem('kadi_plays', JSON.stringify(kdp));
    localStorage.setItem('kadi_plays', JSON.stringify(tri));

console.log(player_cards)
       if(user_id == 19 || user_id =='19'){
        console.log('hello');
    localStorage.setItem('registrationData1', JSON.stringify({
        ...JSON.parse(localStorage.getItem('registrationData1')),
        my_cards: JSON.stringify(player_cards) // Clear cards for user
    }));}
    else{

        if(action.to_fine =="none"){
        localStorage.setItem('registrationData2', JSON.stringify({
        ...JSON.parse(localStorage.getItem('registrationData2')),
        my_cards: JSON.stringify(player_cards) // Clear cards for user

    }));
    }
    }

    action.game_end = 'false';



    let  action_d = { ...action, ready_cards: ready_cards, end_status: end_status };
    
   // if (action.next_player == '19' || action.next_player == 19) { // AI turn
      
        action_d.play_type = 'single_player';
        console.log(JSON.parse(localStorage.getItem('kadi_plays')))
  return (JSON.stringify(action_d)); 
   // }

   /* let action_d = {};
    if (action.next_player == '19') {
        alert('hello');
        action_d = { ...action, ready_cards: ready_cards, end_status: end_status };
      console.log( aiTurn(action_d, duel_id, players)); // Implement this function for AI turn logic
    } else {
     }

    if (user !== 19) {
        
        return (JSON.stringify(action_d)); // Adjust output as necessary
    }*/


}



}


} //end of for











///next block
function process_card_request(cards = null, players, currentPlayer, to_play) {
    // var_dump(cards);
    const userId = sessionStorage.getItem('userID'); // Assuming session storage is used
    const duelId = 1270; // You can modify this to get it dynamically
    const hearts = [0, 4, 8, 12, 16, 20, 24, 30, 34, 38, 42, 46, 50];
    const diamonds = [1, 5, 9, 13, 17, 21, 25, 31, 35, 39, 43, 47, 51];
    const flowers = [2, 6, 10, 14, 18, 22, 26, 32, 36, 40, 44, 48, 52];
    const spades = [3, 7, 11, 15, 19, 23, 27, 33, 37, 41, 45, 49, 53];

    const allowedQHearts = [16, 30, 34, 38, 42, 46, 50];
    const allowedQDiamonds = [17, 31, 35, 39, 43, 47, 51];
    const allowedQFlowers = [18, 32, 36, 40, 44, 48, 52];
    const allowedQSpades = [19, 33, 37, 41, 45, 49, 53];

    const allowed8Hearts = [12, 30, 34, 38, 42, 46, 50];
    const allowed8Diamonds = [13, 31, 35, 39, 43, 47, 51];
    const allowed8Flowers = [14, 32, 36, 40, 44, 48, 52];
    const allowed8Spades = [15, 33, 37, 41, 45, 49, 53];

    const allowed2Hearts = [24, 28, 29];
    const allowed2Diamonds = [25, 28, 29];
    const allowed2Flowers = [26, 28, 29];
    const allowed2Spades = [27, 28, 29];

    const allowed3Hearts = [20, 28, 29];
    const allowed3Diamonds = [21, 28, 29];
    const allowed3Flowers = [22, 28, 29];
    const allowed3Spades = [23, 28, 29];
    const allowedJK = [20, 21, 22, 23, 24, 25, 26, 27, 28, 29];

    const playerCount = players.length;
    currentPlayer = players[playerCount - 1];

    const cardCount = cards.length;
    toPlay = players[playerCount - 1];

    let cardRequest = false;
    let cardRequested = '';
    let playerAskCard = false;
    let action = {};

    for (let k = 0; k < cards.length; k++) {
        let current_card = cards[k];
        let prev_card;

        if (k === 0) {
            prev_card = cards[0];
        } else {
            prev_card = cards[k - 1];
        }

        // Check all breaks and action return
        if ([4, 5, 6, 7].includes(prev_card)) {
            if ([4, 5, 6, 7].includes(current_card)) {
                const playAllowed = true;
                const cardAskPerm = true;
                const ps = playerCount - 1;

                const op = players[0];
                players.splice(0, 1); // Remove first player
                players.reverse(); // Reverse the array
                players.push(op); // Add the first player to the end

                toPlay = players[ps];
                if (k === cardCount - 1) {
                    action = {
                        fine: 'none',
                        play_allowed: 'true',
                        to_fine: 'none',
                        next_player: to_play,
                    };
                }
            } else {
                action = {
                    fine: '1',
                    play_allowed: 'false',
                    to_fine: 'self',
                    next_player: to_play,
                };
                break;
            }
        }

        if ([8, 9, 10, 11].includes(prev_card)) {
            if ([8, 9, 10, 11].includes(current_card)) {
                const pl = players.length;
                const lp = players[pl - 1];
                currentPlayer = players[pl - 1];
                players.pop(); // Remove last player
                players.unshift(lp); // Add last player to the front

                toPlay = players[pl - 1];

                const playAllowed = true;
                const cardAskPerm = true;
                if (k === cardCount - 1) {
                    action = {
                        fine: 'none',
                        play_allowed: 'true',
                        to_fine: 'none',
                        next_player: to_play,
                    };
                }
            } else {
                const playAllowed = false;

                action = {
                    fine: '1',
                    play_allowed: 'false',
                    to_fine: 'self',
                    next_player: to_play,
                };
                break;
            }
        }

if ([12, 13, 14, 15].includes(prev_card)) {
    if ([12, 13, 14, 15].includes(current_card)) {
        play_allowed = true;
        card_ask_perm = true;

        if (k === cardCount - 1) {
            action = {
                fine: 'none',
                play_allowed: 'true',
                to_fine: 'none',
                next_player: to_play,
            };
        }
    } else {
        if (hearts.includes(prev_card)) {
            if (allowed_q_hearts.includes(current_card)) {
                play_allowed = true;
                question_allowed = false;

                if (k === pll - 1) {
                    action = {
                        fine: 'none',
                        play_allowed: 'true',
                        to_fine: 'none',
                        next_player: to_play,
                    };
                }
            } else {
                action = {
                    fine: '1',
                    play_allowed: 'false',
                    to_fine: 'self',
                    next_player: to_play,
                };
                break;
            }
        } else if (diamonds.includes(prev_card)) {
            if (allowed_q_diamonds.includes(current_card)) {
                play_allowed = true;
                question_allowed = false;

                if (k === pll - 1) {
                    action = {
                        fine: 'none',
                        play_allowed: 'true',
                        to_fine: 'none',
                        next_player: to_play,
                    };
                }
            } else {
                action = {
                    fine: '1',
                    play_allowed: 'false',
                    to_fine: 'self',
                    next_player: to_play,
                };
                break;
            }
        } else if (flowers.includes(prev_card)) {
            if (allowed_q_flowers.includes(current_card)) {
                play_allowed = true;
                question_allowed = false;

                if (k === pll - 1) {
                    action = {
                        fine: 'none',
                        play_allowed: 'true',
                        to_fine: 'none',
                        next_player: to_play,
                    };
                }
            } else {
                action = {
                    fine: '1',
                    play_allowed: 'false',
                    to_fine: 'self',
                    next_player: to_play,
                };
                break;
            }
        } else if (spades.includes(prev_card)) {
            if (allowed_q_spades.includes(current_card)) {
                play_allowed = true;
                question_allowed = false;

                if (k === pll - 1) {
                    action = {
                        fine: 'none',
                        play_allowed: 'true',
                        to_fine: 'none',
                        next_player: to_play,
                    };
                }
            } else {
                action = {
                    fine: '1',
                    play_allowed: 'false',
                    to_fine: 'self',
                    next_player: to_play,
                };
                break;
            }
        }
    }
}

if ([16, 17, 18, 19].includes(prev_card)) {
    if ([16, 17, 18, 19].includes(current_card)) {
        play_allowed = true;
        card_ask_perm = true;

        if (k === cardCount - 1) {
            action = {
                fine: 'none',
                play_allowed: 'true',
                to_fine: 'none',
                next_player: to_play,
            };
        }
    } else {
        if (hearts.includes(prev_card)) {
            if (allowed_8_hearts.includes(current_card)) {
                play_allowed = true;
                question_allowed = false;

                if (k === pll - 1) {
                    action = {
                        fine: 'none',
                        play_allowed: 'true',
                        to_fine: 'none',
                        next_player: to_play,
                    };
                }
            } else {
                action = {
                    fine: '1',
                    play_allowed: 'false',
                    to_fine: 'self',
                    next_player: to_play,
                };
                break;
            }
        } else if (diamonds.includes(prev_card)) {
            if (allowed_8_diamonds.includes(current_card)) {
                play_allowed = true;
                question_allowed = false;

                if (k === pll - 1) {
                    action = {
                        fine: 'none',
                        play_allowed: 'true',
                        to_fine: 'none',
                        next_player: to_play,
                    };
                }
            } else {
                action = {
                    fine: '1',
                    play_allowed: 'false',
                    to_fine: 'self',
                    next_player: to_play,
                };
                break;
            }
        } else if (flowers.includes(prev_card)) {
            if (allowed_8_flowers.includes(current_card)) {
                play_allowed = true;
                question_allowed = false;

                if (k === pll - 1) {
                    action = {
                        fine: 'none',
                        play_allowed: 'true',
                        to_fine: 'none',
                        next_player: to_play,
                    };
                }
            } else {
                action = {
                    fine: '1',
                    play_allowed: 'false',
                    to_fine: 'self',
                    next_player: to_play,
                };
                break;
            }
        } else if (spades.includes(prev_card)) {
            if (allowed_8_spades.includes(current_card)) {
                play_allowed = true;
                question_allowed = false;

                if (k === pll - 1) {
                    action = {
                        fine: 'none',
                        play_allowed: 'true',
                        to_fine: 'none',
                        next_player: to_play,
                    };
                }
            } else {
                action = {
                    fine: '1',
                    play_allowed: 'false',
                    to_fine: 'self',
                    next_player: to_play,
                };
                break;
            }
        }
    }
}


if ([20, 21, 22, 23].includes(prev_card)) {
    if ([20, 21, 22, 23, 28, 29].includes(current_card)) {
        play_allowed = true;
        card_ask_perm = true;

        if (k === cardCount - 1) {
            let fine = (current_card === 28 || current_card === 29) ? 5 : 2;
            action = {
                fine: fine,
                play_allowed: 'true',
                to_fine: to_play,
                next_player: to_play,
            };
        }
    } else {
        if (hearts.includes(prev_card)) {
            if (allowed_2_hearts.includes(current_card)) {
                play_allowed = true;
                if (k === pll - 1) {
                    let fine = 3;
                    action = {
                        fine: fine,
                        play_allowed: 'true',
                        to_fine: to_play,
                        next_player: to_play,
                    };
                }
            } else {
                action = {
                    fine: '1',
                    play_allowed: 'false',
                    to_fine: 'self',
                    next_player: to_play,
                };
                break;
            }
        } else if (diamonds.includes(prev_card)) {
            if (allowed_2_diamonds.includes(current_card)) {
                play_allowed = true;
                if (k === pll - 1) {
                    let fine = 3;
                    action = {
                        fine: fine,
                        play_allowed: 'true',
                        to_fine: to_play,
                        next_player: to_play,
                    };
                }
            } else {
                action = {
                    fine: '1',
                    play_allowed: 'false',
                    to_fine: 'self',
                    next_player: to_play,
                };
                break;
            }
        } else if (flowers.includes(prev_card)) {
            if (allowed_2_flowers.includes(current_card)) {
                play_allowed = true;
                if (k === pll - 1) {
                    let fine = 3;
                    action = {
                        fine: fine,
                        play_allowed: 'true',
                        to_fine: to_play,
                        next_player: to_play,
                    };
                }
            } else {
                action = {
                    fine: '1',
                    play_allowed: 'false',
                    to_fine: 'self',
                    next_player: to_play,
                };
                break;
            }
        } else if (spades.includes(prev_card)) {
            if (allowed_2_spades.includes(current_card)) {
                play_allowed = true;
                if (k === pll - 1) {
                    let fine = 3;
                    action = {
                        fine: fine,
                        play_allowed: 'true',
                        to_fine: to_play,
                        next_player: to_play,
                    };
                }
            } else {
                action = {
                    fine: '1',
                    play_allowed: 'false',
                    to_fine: 'self',
                    next_player: to_play,
                };
                break;
            }
        }
    }
}

if ([24, 25, 26, 27].includes(prev_card)) {
    if ([24, 25, 26, 27, 28, 29].includes(current_card)) {
        play_allowed = true;
        card_ask_perm = true;

        if (k === cardCount - 1) {
            let fine = 3;
            action = {
                fine: fine,
                play_allowed: 'true',
                to_fine: to_play,
                next_player: to_play,
            };
        }
    } else {
        if (hearts.includes(prev_card)) {
            if (allowed_3_hearts.includes(current_card)) {
                play_allowed = true;
                if (k === pll - 1) {
                    let fine = 2;
                    action = {
                        fine: fine,
                        play_allowed: 'true',
                        to_fine: to_play,
                        next_player: to_play,
                    };
                }
            } else {
                action = {
                    fine: '1',
                    play_allowed: 'false',
                    to_fine: 'self',
                    next_player: to_play,
                };
                break;
            }
        } else if (diamonds.includes(prev_card)) {
            if (allowed_3_diamonds.includes(current_card)) {
                play_allowed = true;
                if (k === pll - 1) {
                    let fine = 2;
                    action = {
                        fine: fine,
                        play_allowed: 'true',
                        to_fine: to_play,
                        next_player: to_play,
                    };
                }
            } else {
                action = {
                    fine: '1',
                    play_allowed: 'false',
                    to_fine: 'self',
                    next_player: to_play,
                };
                break;
            }
        } else if (flowers.includes(prev_card)) {
            if (allowed_3_flowers.includes(current_card)) {
                play_allowed = true;
                if (k === pll - 1) {
                    let fine = 2;
                    action = {
                        fine: fine,
                        play_allowed: 'true',
                        to_fine: to_play,
                        next_player: to_play,
                    };
                }
            } else {
                action = {
                    fine: '1',
                    play_allowed: 'false',
                    to_fine: 'self',
                    next_player: to_play,
                };
                break;
            }
        } else if (spades.includes(prev_card)) {
            if (allowed_3_spades.includes(current_card)) {
                play_allowed = true;
                if (k === pll - 1) {
                    let fine = 2;
                    action = {
                        fine: fine,
                        play_allowed: 'true',
                        to_fine: to_play,
                        next_player: to_play,
                    };
                }
            } else {
                action = {
                    fine: '1',
                    play_allowed: 'false',
                    to_fine: 'self',
                    next_player: to_play,
                };
                break;
            }
        }
    }
}

if ([28, 29].includes(prev_card)) {
    if ([20, 21, 22, 23].includes(current_card)) {
        if (k === cardCount - 1) {
            let fine = 2;
            action = {
                fine: fine,
                play_allowed: 'true',
                to_fine: to_play,
                next_player: to_play,
            };
        }
        play_allowed = true;
    } else if ([24, 25, 26, 27].includes(current_card)) {
        if (k === pll - 1) {
            let fine = 3;
            action = {
                fine: fine,
                play_allowed: 'true',
                to_fine: to_play,
                next_player: to_play,
            };
        }
        play_allowed = true;
    } else if ([28, 29].includes(current_card)) {
        if (k === pll - 1) {
            let fine = 5;
            action = {
                fine: fine,
                play_allowed: 'true',
                to_fine: to_play,
                next_player: to_play,
            };
        }
        play_allowed = true;
    } else {
        action = {
            fine: '1',
            play_allowed: 'false',
            to_fine: 'self',
            next_player: to_play,
        };
        break;
    }
}



    if ([30, 31, 32, 33].includes(prev_card)) {
        if ([30, 31, 32, 33].includes(current_card)) {
            playAllowed = true;
            cardAskPerm = true;

            if (k === cardCount - 1) {
                action = {
                    fine: 'none',
                    play_allowed: true,
                    to_fine: 'none',
                    next_player: to_play
                };
            }
        } else {
            action = {
                fine: '1',
                play_allowed: false,
                to_fine: 'none',
                next_player: to_play
            };
            return action;
        }
    }

    if ([34, 35, 36, 37].includes(prev_card)) {
        if ([34, 35, 36, 37].includes(current_card)) {
            playAllowed = true;
            cardAskPerm = true;

            if (k === cardCount - 1) {
                action = {
                    fine: 'none',
                    play_allowed: true,
                    to_fine: 'none',
                    next_player: to_play
                };
            }
        } else {
            action = {
                fine: '1',
                play_allowed: false,
                to_fine: 'self',
                next_player: to_play
            };
            return action;
        }
    }

    if ([38, 39, 40, 41].includes(prev_card)) {
        if ([38, 39, 40, 41].includes(current_card)) {
            playAllowed = true;
            cardAskPerm = true;

            if (k === cardCount - 1) {
                action = {
                    fine: 'none',
                    play_allowed: true,
                    to_fine: 'none',
                    next_player: to_play
                };
            }
        } else {
            action = {
                fine: '1',
                play_allowed: false,
                to_fine: 'none',
                next_player: to_play
            };
            return action;
        }
    }

    if ([42, 43, 44, 45].includes(prev_card)) {
        if ([42, 43, 44, 45].includes(current_card)) {
            playAllowed = true;
            cardAskPerm = true;

            if (k === cardCount - 1) {
                action = {
                    fine: 'none',
                    play_allowed: true,
                    to_fine: 'none',
                    next_player: to_play
                };
                return action;
            }
        } else {
            action = {
                fine: '1',
                play_allowed: false,
                to_fine: 'none',
                next_player: to_play
            };
            return action;
        }
    }

    if ([46, 47, 48, 49].includes(prev_card)) {
        if ([46, 47, 48, 49].includes(current_card)) {
            playAllowed = true;
            cardAskPerm = true;

            if (k === cardCount - 1) {
                action = {
                    fine: 'none',
                    play_allowed: true,
                    to_fine: 'none',
                    next_player: to_play
                };
            }
        } else {
            action = {
                fine: '1',
                play_allowed: false,
                to_fine: 'self',
                next_player: to_play
            };
            return action;
        }
    }

    if ([50, 51, 52, 53].includes(prev_card)) {
        if ([50, 51, 52, 53].includes(current_card)) {
            playAllowed = true;
            cardAskPerm = true;

            if (k === cardCount - 1) {
                action = {
                    fine: 'none',
                    play_allowed: true,
                    to_fine: 'none',
                    next_player: to_play
                };
            }
        } else {
            action = {
                fine: '1',
                play_allowed: false,
                to_fine: 'self',
                next_player: to_play
            };
            return action;
        }
    }





    }

    // Return action
    return action;
}


//next block 


// Helper function to determine card rank and suit
function getCardInfo(card) {
    const brackets = [
        [0, 1, 2, 3],
        [4, 5, 6, 7],
        [8, 9, 10, 11],
        [12, 13, 14, 15],
        [16, 17, 18, 19],
        [20, 21, 22, 23],
        [24, 25, 26, 27],
        [28, 29], // Jokers
        [30, 31, 32, 33],
        [34, 35, 36, 37],
        [38, 39, 40, 41],
        [42, 43, 44, 45],
        [46, 47, 48, 49],
        [50, 51, 52, 53]
    ];
    const suits = ['hearts', 'diamonds', 'flowers', 'spades'];
    let suit = '';
    let rank = null;

    // Determine the suit
    if ([0, 4, 8, 12, 16, 20, 24, 30, 34, 38, 42, 46, 50].includes(card)) {
        suit = 'hearts';
    } else if ([1, 5, 9, 13, 17, 21, 25, 31, 35, 39, 43, 47, 51].includes(card)) {
        suit = 'diamonds';
    } else if ([2, 6, 10, 14, 18, 22, 26, 32, 36, 40, 44, 48, 52].includes(card)) {
        suit = 'flowers';
    } else if ([3, 7, 11, 15, 19, 23, 27, 33, 37, 41, 45, 49, 53].includes(card)) {
        suit = 'spades';
    }

    // Determine the rank
    if ([28, 29].includes(card)) {
        rank = 'Joker';
        suit = 'none';
    } else {
        for (let i = 0; i < brackets.length; i++) {
            if (brackets[i].includes(card)) {
                rank = i;
                break;
            }
        }
    }

    return [rank, suit];
}

// Helper function to check if a card is playable
function isPlayable(card, topCard) {
    if ([0, 1, 2, 3].includes(card) || [28, 29].includes(card)) {
        return true;
    }

    const [cardRank, cardSuit] = getCardInfo(card);
   
    const [topRank, topSuit] = getCardInfo(topCard);

    return cardRank === topRank || cardSuit === topSuit;
}

// Function to get the majority suit from a deck
function getMajoritySuit(deck) {
    // Define suits
    let hearts = 0;
    let diamonds = 0;
    let flowers = 0;
    let spades = 0;

    // Define which cards belong to which suit
    const heartsCards = [0, 4, 8, 12, 16, 20, 24, 30, 34, 38, 42, 46, 50];
    const diamondsCards = [1, 5, 9, 13, 17, 21, 25, 31, 35, 39, 43, 47, 51];
    const flowersCards = [2, 6, 10, 14, 18, 22, 26, 32, 36, 40, 44, 48, 52];
    const spadesCards = [3, 7, 11, 15, 19, 23, 27, 33, 37, 41, 45, 49, 53];

    // Process the deck, ignoring Joker cards (assuming 28 and 29 are Jokers)
    for (const card of deck) {
        if (heartsCards.includes(card)) {
            hearts++;
        } else if (diamondsCards.includes(card)) {
            diamonds++;
        } else if (flowersCards.includes(card)) {
            flowers++;
        } else if (spadesCards.includes(card)) {
            spades++;
        }
        // Ignore the Joker (assuming Joker is card number 28 and 29)
    }

    // Determine the majority suit
    const suits = {
        hearts,
        diamonds,
        flowers,
        spades
    };

    // Find the suit with the highest count
    const sortedSuits = Object.entries(suits).sort((a, b) => b[1] - a[1]);
    const highestCount = sortedSuits[0][1];

    // Check if there's a tie or if all are zero
    if (sortedSuits.length > 1 && sortedSuits[0][1] === sortedSuits[1][1]) {
        // If there's no majority, randomize a suit
        const randomSuits = ['hearts', 'diamonds', 'flowers', 'spades'];
        return randomSuits[Math.floor(Math.random() * randomSuits.length)];
    }

    // Return the suit with the majority
    return sortedSuits[0][0]; // Return the suit name
}


// AI's turn
function aiTurn(action = null, duelId = 1384, players = null) {
    console.log(action);
    let playerPlay = [];
    let cardRequest = action.card_requests;
    let cardRequested = action.card_requested;

    const hearts = [0, 4, 8, 12, 16, 20, 24, 30, 34, 38, 42, 46, 50];
    const diamonds = [1, 5, 9, 13, 17, 21, 25, 31, 35, 39, 43, 47, 51];
    const flowers = [2, 6, 10, 14, 18, 22, 26, 32, 36, 40, 44, 48, 52];
    const spades = [3, 7, 11, 15, 19, 23, 27, 33, 37, 41, 45, 49, 53];

    const allowedQHearts = [16, 30, 34, 38, 42, 46, 50];
    const allowedQDiamonds = [17, 31, 35, 39, 43, 47, 51];
    const allowedQFlowers = [18, 32, 36, 40, 44, 48, 52];
    const allowedQSpades = [19, 33, 37, 41, 45, 49, 53];

    const allowed8Hearts = [12, 30, 34, 38, 42, 46, 50];
    const allowed8Diamonds = [13, 31, 35, 39, 43, 47, 51];
    const allowed8Flowers = [14, 32, 36, 40, 44, 48, 52];
    const allowed8Spades = [15, 33, 37, 41, 45, 49, 53];

    const allowed2Hearts = [24, 28, 29];
    const allowed2Diamonds = [25, 28, 29];
    const allowed2Flowers = [26, 28, 29];
    const allowed2Spades = [27, 28, 29];

    const allowed3Hearts = [20, 28, 29];
    const allowed3Diamonds = [21, 28, 29];
    const allowed3Flowers = [22, 28, 29];
    const allowed3Spades = [23, 28, 29];
    const allowedJK = [20, 21, 22, 23, 24, 25, 26, 27, 28, 29];







    // Assuming db is an object to interact with your database
 const lastPlayQuery = JSON.parse(localStorage.getItem('kadi_plays')) || {};

 console.log(lastPlayQuery.last_play);
const kppo = Array.isArray(lastPlayQuery.last_play)?lastPlayQuery.last_play:JSON.parse(lastPlayQuery.last_play);
let lastPlay = kppo || []
    const lpl = lastPlay.length;
    console.log(lpl);
    let topDiscardCard = lastPlay[0].play[0];
    const gameEnd = lastPlayQuery.game_end;
    for (let i = lpl - 1; i >= 1; i--) {
        const lpla = Array.isArray(lastPlay[i].play)?lastPlay[i].play:JSON.parse(lastPlay[i].play);
//look at this

        if (lpla[lpla.length - 1] !== 'picked_card' && lastPlay[i].to_fine !== 'self') {
            let s = lpla.length - 1;

            for (let t = s; t >= 0; t--) {
                if (action.card_requests === 'true' && [0, 1, 2, 3].includes(lpla[t])) {
                    topDiscardCard = parseInt(lpla[t]);
                    break;
                } else if (lpla[t] === 28 && lpla[t] === 29 && lastPlay[i].to_fine === '19') {
                    topDiscardCard = parseInt(lpla[t]);
                    break;
                } else {
                    if ((action.card_requests !== 'true' && ![0, 1, 2, 3].includes(lpla[t])) || 
                        (lpla[t] !== 28 && lpla[t] !== 29 && lastPlay[i].to_fine !== '19')) {
                        topDiscardCard = parseInt(lpla[t]);
                        break;
                    }
                }
            }
            break;
        }
    }

    let acceptedPlay = [];
    let kadi ;
    let cardless ;
    const readyCards = action.ready_cards; // Ready cards array
    const playerCardsQuery = JSON.parse(localStorage.getItem('registrationData1'));
    let playerCards = JSON.parse(playerCardsQuery.my_cards);
    
    // Initializations
    const cardSequence = ['A', 'Jump', 'Kickback', 'Q', '8', '2', '3', 'Joker', '4', '5', '6', '7', '9', '10'];
 let playableCards = [];
    const toFine = action.to_fine;

    // Identify playable cards
    for (let card of playerCards) {

    if (action.card_requests == true) {
       
        const requestMap = {
            hearts: hearts,
            diamonds: diamonds,
            flowers: flowers,
            spades: spades
        };
console.log(requestMap[action.card_requested]);
console.log(requestMap[action.card_requested]);
        const common = requestMap[action.card_requested].filter(card => playerCards.includes(card));

        playableCards = common.length === 0 ? [] : common;
    }

    else{
        const [rank, suit] = getCardInfo(card);
        
        if (isPlayable(card, topDiscardCard)) {
            playableCards.push(card);
            
        }
    }
    }
console.log(playableCards);
    if (toFine == '19') {
        const common = playableCards.filter(card => [0, 1, 2, 3, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29].includes(card));
        playableCards = common.length === 0 ? [] : common;
    }




console.log(playableCards);

    // No playable cards, draw a card
    if (playableCards.length === 0) {
        if (toFine === '19') {
            const pf = action.fine;
            for (let i = 0; i < pf; i++) {
                shuffle(readyCards);
                const drawnCard = readyCards.pop();
                playerCards .push(drawnCard);
            }
        } else {
            shuffle(readyCards);
            const drawnCard = readyCards.pop();
       
         playerCards.push(drawnCard);
        }

        acceptedPlay = ['picked_card'];
        kadi = "false";
        cardless = "false";
    } else {
        let allPlayableCards = [];

        for (let pc of playableCards) {
            let rCards = [];
            const fixed = pc;
            console.log(playerCards.includes(fixed)==true);
            const remainingArray =playerCards.filter(ra => ra!=fixed);// playerCards.slice(1);

            if ([0, 1, 2, 3].includes(fixed)) {
                rCards = remainingArray.filter(ra => [0, 1, 2, 3].includes(ra));
                 rCards.unshift(fixed);
            } else if ([4, 5, 6, 7].includes(fixed)) {
                rCards = remainingArray.filter(ra => [4, 5, 6, 7].includes(ra));
                 rCards.unshift(fixed);
            } else if ([8, 9, 10, 11].includes(fixed)) {
                rCards = remainingArray.filter(ra => [8, 9, 10, 11].includes(ra));
                 rCards.unshift(fixed);
            } else if ([12, 13, 14, 15, 16, 17, 18, 19].includes(fixed)) {
                rCards = remainingArray.filter(ra => isPlayable(ra, fixed));
                 rCards.unshift(fixed);
            } else if ([20, 21, 22, 23, 24, 25, 26, 27, 28, 29].includes(fixed)) {
         
                rCards = remainingArray.filter(ra => isPlayable(ra, fixed));
                 rCards.unshift(fixed);
            } else if ([30, 31, 32, 33].includes(fixed)) {
                rCards = remainingArray.filter(ra => [30, 31, 32, 33].includes(ra));
                rCards.unshift(fixed);
                console.log(rCards);
            } else if ([34, 35, 36, 37].includes(fixed)) {
                rCards = remainingArray.filter(ra => [34, 35, 36, 37].includes(ra));
                 rCards.unshift(fixed);
            } else if ([38, 39, 40, 41].includes(fixed)) {
                rCards = remainingArray.filter(ra => [38, 39, 40, 41].includes(ra));
                 rCards.unshift(fixed);
            } else if ([42, 43, 44, 45].includes(fixed)) {
                rCards = remainingArray.filter(ra => [42, 43, 44, 45].includes(ra));
                 rCards.unshift(fixed);
            } else if ([46, 47, 48, 49].includes(fixed)) {
                rCards = remainingArray.filter(ra => [46, 47, 48, 49].includes(ra));
                 rCards.unshift(fixed);
            } else if ([50, 51, 52, 53].includes(fixed)) {
                rCards = remainingArray.filter(ra => [50, 51, 52, 53].includes(ra));
                 rCards.unshift(fixed);
            }

            if (rCards.length > 0) {
              
                allPlayableCards.push(rCards);
            }
        }

console.log(allPlayableCards);
        // Play a card
        if (allPlayableCards.length > 0) {
            acceptedPlay = allPlayableCards[0]; // Pick the first valid set
            playerCards = playerCards.filter(card => !acceptedPlay.includes(card)); // Remove played cards
        }
if(acceptedPlay.length > 1 && playerCards.length == 0 &&  [30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40, 41, 42, 43, 44, 45, 46, 47, 48, 49, 50, 51, 52, 53].includes(acceptedPlay[acceptedPlay.length - 1]) &&  [30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40, 41, 42, 43, 44, 45, 46, 47, 48, 49, 50, 51, 52, 53].includes(acceptedPlay[acceptedPlay.length - 2])){
    playerCards.push(acceptedPlay[acceptedPlay.length - 1]);
    acceptedPlay.pop();
}
        kadi = playerCards.length == 1? "true":"false"; // Check if about to finish
        cardless = playerCards.length == 0 ? "true":"false"; // Check if no cards left
    }

   //Handle special cases
     if ([0,1,2,3].includes(acceptedPlay[acceptedPlay.length - 1] ) && action.to_fine != '19') {
                cardRequested =  getMajoritySuit(playerCards);
                cardRequest = true;
               
                
            }
            else if([12,13,14,15,16,17,18,19].includes(acceptedPlay[acceptedPlay.length - 1] )){
                   shuffle(ready_cards);
            const drawn_card = ready_cards.splice(-1);
                    playerCards.push(drawn_card);


            }
    console.log(cardRequest)
    console.log(cardRequested)
 // Prepare the data to send
    // Send data to the game processor
    // Replace with the actual method to send data in your app

 
  /*  function kadiPlay(
  player = null,
  player_cards = null,
  cardless = null,
  kadi = null,
  player_play = null,
  ready_cards = null,
  card_request = null,
  card_requested = null,
  lastPlay = null,
  duelId = null,
)*/
    kadiPlay(19,playerCards,cardless,kadi,acceptedPlay,readyCards,cardRequest,cardRequested,null,duelId)
   // sendDataToGameProcessor(dataToSend);
}

// Function to send data to the game processor
function sendDataToGameProcessor(data) {
    // Implement the logic to send the data to your game processor
    kadiPlay(data);
    console.log('Data sent to game processor:', data);
}

// Placeholder function to simulate database access
const db = {
    where: (key, value) => ({
        get: (table) => {
            // Replace with actual database access logic
            return {
                row: (rowName) => {
                    // Mock data for demonstration
                    if (table === 'kadi_plays') {
                        return { last_play: '[{"play":[0,1,2,3]}]' };
                    }
                    return { my_cards: '[1,2,3,4,5]' };
                }
            };
        }
    })
};

// Placeholder function for shuffling an array
function shuffle(array) {
    for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
    }
}


// Function to start the game and deal cards to AI
function aiStart(readyCards) {
    let deck = readyCards.slice(); // Copy of readyCards
    shuffle(deck);

    // Deal 4 random cards to AI
    let playerCards = deck.splice(0, 4);

    // Initial discard pile and draw pile
    let discardPile = [deck.pop()];
    readyCards = deck;

const kadiPlays = getLocalStorage('kadi_plays', null)|| [];
const reg1 = getLocalStorage('registrationData1', null)|| [];

    const data1 = {
        ...kadiPlays,
        ready_cards: JSON.stringify(readyCards),
    };

    const data2 = {
        ...reg1,
        my_cards: JSON.stringify(playerCards),
    };

    // Store data in Local Storage
    updateLocalStorage('kadi_plays',null, data1);
    updateLocalStorage('registrationData1', null, data2); // Assuming 19 is userID for kadi_ai

    return { player_cards: playerCards, discard_pile: discardPile, ready_cards: readyCards };
}

// Function to generate combinations recursively
function generate(subArray, length, start, array, results) {
    if (length === 0) {
        results.push([...subArray]); // Use spread operator to push a copy
        return;
    }

    for (let i = start; i <= array.length - length; i++) {
        subArray.push(array[i]);
        generate(subArray, length - 1, i + 1, array, results);
        subArray.pop(); // Remove last element to backtrack
    }
}

// Function to get all combinations of an array
function getCombinations(array) {
    const results = [];
    const arrayLength = array.length;

    // Loop through to generate all combinations from single-value arrays to arrays containing all elements
    for (let i = 1; i <= arrayLength; i++) {
        generate([], i, 0, array, results);
    }

    return results;
}

// Function to generate permutations recursively
function permute(items, perms = [], results, fixed) {
    if (items.length === 0) {
        perms.unshift(fixed); // Add fixed element at the start
        results.push(perms);
    } else {
        for (let i = 0; i < items.length; i++) {
            const newItems = items.slice();
            const newPerms = [...perms]; // Copy current permutations
            const current = newItems.splice(i, 1)[0]; // Remove current item
            newPerms.push(current);
            permute(newItems, newPerms, results, fixed);
        }
    }
}

// Function to get all permutations of an array with the first element fixed
function getPermutations(array, fixed) {
    const results = [];
    permute(array, [], results, fixed);
    return results;
}

// Function to sort arrays by length in descending order
function sortArraysByLengthDescending(arrays) {
    return arrays.sort((a, b) => b.length - a.length);
}

// Function to shuffle an array (Fisher-Yates Shuffle)
function shuffle(array) {
    for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]]; // Swap elements
    }
}

// Function to update Local Storage
function updateLocalStorage(tableName = null, duelId = null, data = null) {
    const key = tableName;//`${tableName}_${duelId}`;
    localStorage.setItem(key, JSON.stringify(data));
}

// Function to retrieve data from Local Storage
function getLocalStorage(tableName, duelId = null) {
    const key = tableName;//`${tableName}_${duelId}`;
    const data = localStorage.getItem(key);
    return data ? JSON.parse(data) : null;
}

function getFullnameByID(storage){
const player = JSON.parse(localStorage.getItem(storage))
  return  player.name;
}










});






</script>
<style type="text/css">
.tutorial-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.7);
    z-index: 100;
    display:none;
   
}

.tutorial-text {
    position: absolute;
    z-index: 1010;
    color: #3ea2bf;
    font-size: 18px;
    display: none;
    top:20%;
    margin:0 auto;
    text-align:center;
}
.circle2 {
background-color: white;
  box-shadow: 0 0 0 1000px rgba(0, 0, 0, 0.3);
  justify-content: center;
  flex-direction: column;
  align-items: center;
position:relative;
  display: flex;
  height: 75px;
  width: 75px;
}
.circle {
    
background-color: white;
  box-shadow: 0 0 0 1000px rgba(0, 0, 0, 0.3);
  justify-content: center;
  flex-direction: column;
  align-items: center;
  border-radius: 100%;
  display: flex;
  height: 75px;
  width: 75px;
}
.card-stack {

  z-index: 1; /* Ensure the cards are below the overlay */

    
}

    .footer {
    display:none;
}
#hearts { background: url('cards/card_1.png');background-size :contain;background-repeat: no-repeat;}
#diamonds { background: url('cards/card_2.png');background-size :contain;background-repeat: no-repeat;}
#flowers { background: url('cards/card_3.png');background-size :contain;background-repeat: no-repeat;}
#spades { background: url('cards/card_4.png');background-size :contain;background-repeat: no-repeat;}


#card_0 { background: url('cards/card_1.png');background-size :contain;background-repeat: no-repeat;}
#card_1 { background: url('cards/card_2.png');background-size :contain;background-repeat: no-repeat;}
#card_2 { background: url('cards/card_3.png');background-size :contain;background-repeat: no-repeat;}
#card_3 { background: url('cards/card_4.png');background-size :contain;background-repeat: no-repeat;}
#card_4 { background: url('cards/card_5.png');background-size :contain;background-repeat: no-repeat;}
#card_5 { background: url('cards/card_6.png');background-size :contain;background-repeat: no-repeat;}
#card_6 { background: url('cards/card_7.png');background-size :contain;background-repeat: no-repeat;}
#card_7 { background: url('cards/card_8.png');background-size :contain;background-repeat: no-repeat;}
#card_8 { background: url('cards/card_9.png');background-size :contain;background-repeat: no-repeat;}
#card_9 { background: url('cards/card_10.png');background-size :contain;background-repeat: no-repeat;}
#card_10 { background: url('cards/card_11.png');background-size :contain;background-repeat: no-repeat;}
#card_11 { background: url('cards/card_12.png');background-size :contain;background-repeat: no-repeat;}
#card_12 { background: url('cards/card_13.png');background-size :contain;background-repeat: no-repeat;}
#card_13 { background: url('cards/card_14.png');background-size :contain;background-repeat: no-repeat;}
#card_14 { background: url('cards/card_15.png');background-size :contain;background-repeat: no-repeat;}
#card_15 { background: url('cards/card_16.png');background-size :contain;background-repeat: no-repeat;}
#card_16 { background: url('cards/card_17.png');background-size :contain;background-repeat: no-repeat;}
#card_17 { background: url('cards/card_18.png');background-size :contain;background-repeat: no-repeat;}
#card_18 { background: url('cards/card_19.png');background-size :contain;background-repeat: no-repeat;}
#card_19 { background: url('cards/card_20.png');background-size :contain;background-repeat: no-repeat;}
#card_20 { background: url('cards/card_21.png');background-size :contain;background-repeat: no-repeat;}
#card_21 { background: url('cards/card_22.png');background-size :contain;background-repeat: no-repeat;}
#card_22 { background: url('cards/card_23.png');background-size :contain;background-repeat: no-repeat;}
#card_23 { background: url('cards/card_24.png');background-size :contain;background-repeat: no-repeat;}
#card_24 { background: url('cards/card_25.png');background-size :contain;background-repeat: no-repeat;}
#card_25 { background: url('cards/card_26.png');background-size :contain;background-repeat: no-repeat;}
#card_26 { background: url('cards/card_27.png');background-size :contain;background-repeat: no-repeat;}
#card_27 { background: url('cards/card_28.png');background-size :contain;background-repeat: no-repeat;}
#card_28 { background: url('cards/card_29.png');background-size :contain;background-repeat: no-repeat;}
#card_29 { background: url('cards/card_30.png');background-size :contain;background-repeat: no-repeat;}
#card_30 { background: url('cards/card_31.png');background-size :contain;background-repeat: no-repeat;}
#card_31 { background: url('cards/card_32.png');background-size :contain;background-repeat: no-repeat;}
#card_32 { background: url('cards/card_33.png');background-size :contain;background-repeat: no-repeat;}
#card_33 { background: url('cards/card_34.png');background-size :contain;background-repeat: no-repeat;}
#card_34 { background: url('cards/card_35.png');background-size :contain;background-repeat: no-repeat;}
#card_35 { background: url('cards/card_36.png');background-size :contain;background-repeat: no-repeat;}
#card_36 { background: url('cards/card_37.png');background-size :contain;background-repeat: no-repeat;}
#card_37{ background: url('cards/card_38.png');background-size :contain;background-repeat: no-repeat;}
#card_38 { background: url('cards/card_39.png');background-size :contain;background-repeat: no-repeat;}
#card_39 { background: url('cards/card_40.png');background-size :contain;background-repeat: no-repeat;}
#card_40 { background: url('cards/card_41.png');background-size :contain;background-repeat: no-repeat;}
#card_41 { background: url('cards/card_42.png');background-size :contain;background-repeat: no-repeat;}
#card_42 { background: url('cards/card_43.png');background-size :contain;background-repeat: no-repeat;}
#card_43 { background: url('cards/card_44.png');background-size :contain;background-repeat: no-repeat;}
#card_44 { background: url('cards/card_45.png');background-size :contain;background-repeat: no-repeat;}
#card_45 { background: url('cards/card_46.png');background-size :contain;background-repeat: no-repeat;}
#card_46 { background: url('cards/card_47.png');background-size :contain;background-repeat: no-repeat;}
#card_47 { background: url('cards/card_48.png');background-size :contain;background-repeat: no-repeat;}
#card_48 { background: url('cards/card_49.png');background-size :contain;background-repeat: no-repeat;}
#card_49 { background: url('cards/card_50.png');background-size :contain;background-repeat: no-repeat;}
#card_50 { background: url('cards/card_51.png');background-size :contain;background-repeat: no-repeat;}
#card_51 { background: url('cards/card_52.png');background-size :contain;background-repeat: no-repeat;}
#card_52 { background: url('cards/card_53.png');background-size :contain;background-repeat: no-repeat;}
#card_53 { background: url('cards/card_54.png');background-size :contain;background-repeat: no-repeat;}
#card_placeholder { background: url('cards/placeholder-cards.png');background-size :contain;background-repeat: no-repeat;}
#card_pick { background: url('cards/card-pick.png');background-size :contain;background-repeat: no-repeat;}






#game-container {
    margin: 50px auto;
    width: 600px;
    display: flex;
    justify-content: space-between;
}

#stack, #playing-area {
    width: 200px;
    height: 300px; 
    border: 2px dashed #ccc; 
    display: flex;
    flex-direction: column;
    align-items: center;
}

.card {
    width: 80px;
    height: 120px;
    border-radius: 5px;
    margin-right: 30px; 
    cursor: pointer;
    position: relative;
    transition: all 0.2s ease-in-out;
    z-index:1
}

.card:last-child {
    margin-right: 0; 
}

.card.dragging {
    z-index: 3;
    opacity: 0.7;
} 
.card1,.card2,.card3,.card4{
        display: inline-block;
    }

    .popup {
  justify-content: center;
  flex-direction: column;
  align-items: center;
  position: absolute;
  overflow: hidden;
  display: flex;
  bottom: 0;
  right: 0;
  left: 0;
  top: 0;
}
/* Ensure cards fill the screen on smaller devices */
@media (min-width: 767px) {
    .tutorial-text{
        max-width:50%;
    }
}
#custom-alert {
      display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #f8d7da;
            padding: 20px;
            border: 1px solid #f5c2c7;
            color: #842029;
            font-family: Arial, sans-serif;
            z-index: 1000;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
        }
</style>
